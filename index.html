<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Trainer Partner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'], },
                    colors: {
                        'background-dark': '#0d1117', 'primary-blue': '#58a6ff',
                        'bg-container': '#161b22', 'border-light': '#30363d',
                        'text-light': '#c9d1d9', 'text-muted': '#8b949e',
                        'btn-primary': '#38c172', 'btn-hover-primary': '#2b9e59',
                        'btn-danger': '#ef4444', 'btn-delete-hover': '#dc2626',
                        'btn-secondary': '#6b7280', 'btn-secondary-hover': '#4b5563',
                        'btn-success': '#16a34a', 'btn-success-hover': '#15803d'
                    }
                }
            }
        }
    </script>
    <!-- LIBS PARA GERAR PDF E GRÁFICOS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0d1117; background-image: linear-gradient(135deg, #0d1117 0%, #171d2b 100%); }
        .container { max-width: 900px; }
        input, select, textarea { transition: border-color: 0.3s, box-shadow: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #58a6ff; outline: none; box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3); }
        .hide { display: none !important; }
        .modal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #58a6ff; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-background-dark text-text-light font-sans flex justify-center items-start min-h-screen p-4 md:p-8 text-lg">

    <!-- Notificações e Spinner de Carregamento -->
    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 opacity-0 invisible transition-all duration-300 -translate-y-10 w-full max-w-sm shadow-lg">
        <div class="flex items-start">
            <div id="notification-icon" class="flex-shrink-0 mr-3 mt-1"></div>
            <div>
                <p id="notification-title" class="font-bold"></p>
                <p id="notification-message" class="text-sm"></p>
            </div>
        </div>
    </div>
    <div id="loadingSpinner" class="spinner-overlay hide">
        <div class="spinner"></div>
        <p id="spinner-message" class="text-lg font-semibold text-white">Aguarde...</p>
    </div>

    <!-- Tela de Visualização Pública para Alunos -->
    <div id="publicView" class="hide container bg-bg-container p-6 md:p-10 rounded-xl shadow-xl border border-border-light my-5 md:my-10 w-full">
        <div id="publicContent">
             <h1 class="text-center text-primary-blue text-3xl md:text-4xl font-bold mb-2 pb-4 border-b border-border-light drop-shadow-md">Plano de Treino</h1>
             <div id="publicHeader" class="text-center mb-6">
                 <h2 id="publicAlunoNome" class="text-2xl font-semibold text-text-light"></h2>
                 <p id="publicTrainerInfo" class="text-sm text-text-muted"></p>
             </div>
             <div id="publicTreinoContainer" class="space-y-6"></div>
        </div>
        <div id="publicError" class="hide text-center py-10">
            <h2 class="text-2xl font-bold text-red-500">Treino Não Encontrado</h2>
            <p class="text-text-muted mt-2">O link pode estar incorreto ou o treino pode ter sido removido.</p>
        </div>
    </div>

    <div id="mainApp" class="container bg-bg-container p-6 md:p-10 rounded-xl shadow-xl border border-border-light my-5 md:my-10 w-full">
        <h1 class="text-center text-primary-blue text-3xl md:text-4xl font-bold mb-6 pb-4 border-b border-border-light drop-shadow-md">Your Trainer Partner</h1>

        <!-- Tela de Login -->
        <div id="telaLogin">
            <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4">Aceder à Plataforma</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block mb-2 text-text-muted">Email:</label>
                    <input type="email" id="emailInput" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="passwordInput" class="block mb-2 text-text-muted">Palavra-passe:</label>
                    <div class="relative">
                        <input type="password" id="passwordInput" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                        <button type="button" id="btnTogglePassword" class="absolute inset-y-0 right-0 px-4 text-text-muted hover:text-text-light"></button>
                    </div>
                </div>
                <div class="text-right"><a href="#" id="btnForgotPassword" class="text-sm text-primary-blue hover:underline">Esqueceu a sua palavra-passe?</a></div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="submit" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold">Entrar</button>
                </div>
                <div class="text-center mt-4">
                    <p class="text-text-muted">Não tem uma conta? <a href="#" id="linkGoToSignup" class="font-semibold text-primary-blue hover:underline">Registe-se</a></p>
                </div>
            </form>
        </div>
        
        <!-- Tela de Cadastro -->
        <div id="telaCadastro" class="hide">
            <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4">Criar Nova Conta</h2>
            <form id="signupForm" class="space-y-4">
                <div>
                    <label for="signupName" class="block mb-2 text-text-muted">Nome Completo:</label>
                    <input type="text" id="signupName" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupDisplayName" class="block mb-2 text-text-muted">Como quer ser chamado(a) (Ex: Prof. João):</label>
                    <input type="text" id="signupDisplayName" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupAge" class="block mb-2 text-text-muted">Idade:</label>
                    <input type="number" id="signupAge" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupEmail" class="block mb-2 text-text-muted">Email:</label>
                    <input type="email" id="signupEmail" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupPassword" class="block mb-2 text-text-muted">Palavra-passe (mínimo 6 caracteres):</label>
                    <input type="password" id="signupPassword" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="submit" class="w-full py-3 text-lg bg-btn-primary text-white rounded-lg font-semibold">Finalizar Registo</button>
                </div>
                <div class="text-center mt-4">
                    <p class="text-text-muted">Já tem uma conta? <a href="#" id="linkGoToLogin" class="font-semibold text-primary-blue hover:underline">Faça login</a></p>
                </div>
            </form>
        </div>

        <!-- Conteúdo Principal da Aplicação -->
        <div id="appContent" class="hide">
            <div class="text-right mb-4 flex justify-end items-center gap-2">
                <span id="userInfo" class="text-text-muted text-sm mr-2"></span>
                <button id="btnEditProfile" class="py-2 px-4 text-sm bg-btn-secondary text-white rounded-lg font-semibold">Editar Perfil</button>
                <button id="btnLogout" class="py-2 px-4 text-sm bg-btn-danger text-white rounded-lg font-semibold">Sair</button>
            </div>

            <!-- Tela de Boas-Vindas -->
            <div id="telaBoasVindas" class="hide">
                <div class="text-center p-4">
                    <h2 id="mensagemBoasVindas" class="text-3xl md:text-4xl font-bold text-primary-blue mb-4"></h2>
                    <p class="text-text-muted text-lg mb-8">Pronto para transformar resultados? O que deseja fazer hoje?</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="btnIrParaAlunos" class="py-3 px-6 text-lg bg-primary-blue text-white rounded-lg font-semibold">Ver Meus Alunos</button>
                        <button id="btnAdicionarAlunoRapido" class="py-3 px-6 text-lg bg-btn-success text-white rounded-lg font-semibold">Adicionar Novo Aluno</button>
                    </div>
                </div>
            </div>

            <!-- Tela de Alunos -->
            <div id="telaAlunos" class="hide">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                     <h2 class="text-2xl font-semibold text-primary-blue">Meus Alunos</h2>
                     <button id="btnShowAddAlunoModal" class="py-2 px-4 bg-btn-primary text-white rounded-lg font-semibold w-full sm:w-auto">+ Adicionar Aluno</button>
                 </div>
                 <!-- NOVO: Filtros de Alunos -->
                 <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <input type="search" id="alunoSearchInput" placeholder="Pesquisar por nome..." class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light flex-grow">
                    <select id="alunoObjectiveFilter" class="w-full sm:w-1/3 p-3 rounded-lg border border-border-light bg-background-dark text-text-light">
                        <option value="">Filtrar por objetivo</option>
                    </select>
                 </div>
                 <div id="listaAlunos" class="space-y-3"></div>
            </div>

            <!-- Tela Gerenciar Aluno -->
            <div id="telaGerenciarAluno" class="hide">
                <button id="btnVoltarParaAlunos" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Alunos</button>
                <h2 id="nomeAlunoGerenciado" class="text-2xl font-semibold text-primary-blue mb-6"></h2>
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl w-full">
                    <h3 class="text-xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">O que deseja fazer?</h3>
                    <div class="flex flex-col gap-4">
                        <button id="btnAcompanharEvolucao" class="w-full py-4 text-xl bg-btn-success text-white rounded-lg font-semibold">Acompanhar Evolução</button>
                        <button id="btnNovoTreino" class="w-full py-4 text-xl bg-primary-blue text-white rounded-lg font-semibold">Criar Novo Treino</button>
                        <!-- NOVO: Botão para carregar de modelo -->
                        <button id="btnLoadTemplate" class="w-full py-4 text-xl bg-blue-800 text-white rounded-lg font-semibold">Criar Treino a Partir de Modelo</button>
                        <button id="btnCarregarTreino" class="w-full py-4 text-xl bg-btn-secondary text-white rounded-lg font-semibold">Ver Treinos Guardados</button>
                    </div>
                </div>
            </div>

            <!-- Tela de Acompanhamento de Evolução -->
            <div id="telaAcompanhamento" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Acomp" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Aluno</button>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 id="tituloAcompanhamento" class="text-2xl font-semibold text-primary-blue"></h2>
                    <button id="btnShowAddAvaliacaoModal" class="py-2 px-4 bg-btn-primary text-white rounded-lg font-semibold w-full sm:w-auto">+ Nova Avaliação</button>
                </div>
                <div id="listaAvaliacoes" class="space-y-4"></div>
            </div>

            <!-- Tela de Carregar Treinos Salvos -->
            <div id="telaCarregar" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Carregar" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Aluno</button>
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl">
                    <h3 id="tituloTelaCarregar" class="text-xl md:text-2xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">Gerir Treinos Guardados</h3>
                    <div id="listaTreinosSalvos" class="space-y-3"></div>
                </div>
            </div>
            
            <!-- Formulário de Criação de Treino -->
            <form id="treinoForm" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Form" type="button" class="py-2 px-4 text-lg bg-btn-secondary text-white rounded-lg font-semibold mb-6">← Voltar</button>
                
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl mb-6 space-y-4">
                    <h2 class="text-xl md:text-2xl font-semibold text-primary-blue pb-2 border-b border-border-light">1. Defina os Parâmetros</h2>
                    <input type="text" id="nome_aluno_form" class="w-full p-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg" disabled>
                    
                    <!-- NOVO: Observações para a IA -->
                    <div>
                        <label for="observacoes_ia" class="block mb-2 text-text-muted">Observações para a IA (lesões, preferências, etc.):</label>
                        <textarea id="observacoes_ia" placeholder="Ex: Evitar exercícios de alto impacto no joelho. Foco em ombros." class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light text-md"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="dificuldade" class="block mb-2 text-text-muted">Nível:</label>
                            <select id="dificuldade" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="Iniciante">Iniciante</option>
                                <option value="Intermediario">Intermediário</option>
                                <option value="Avancado">Avançado</option>
                            </select>
                        </div>
                        <div>
                            <label for="objetivo" class="block mb-2 text-text-muted">Objetivo:</label>
                            <select id="objetivo" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="Hipertrofia">Hipertrofia</option>
                                <option value="Emagrecimento">Emagrecimento</option>
                                <option value="Resistencia Muscular">Resistência Muscular</option>
                                <option value="Condicionamento Fisico">Condicionamento Físico</option>
                            </select>
                        </div>
                        <div>
                            <label for="dias_semana" class="block mb-2 text-text-muted">Dias/Semana:</label>
                            <select id="dias_semana" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="1">1 dia (Avulso)</option>
                                <option value="3">3 dias</option>
                                <option value="4">4 dias</option>
                                <option value="5">5 dias</option>
                                <option value="6">6 dias</option>
                            </select>
                        </div>
                        <div>
                            <label for="duracao_treino" class="block mb-2 text-text-muted">Duração:</label>
                            <select id="duracao_treino" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="N/A" selected>Padrão</option>
                                <option value="30 minutos">~30 min</option>
                                <option value="45 minutos">~45 min</option>
                                <option value="60 minutos">~60 min</option>
                                <option value="90 minutos">~90 min</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="divisao_treino" class="block mb-2 text-text-muted">Sugestão de Divisão:</label>
                        <select id="divisao_treino" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light"></select>
                    </div>

                    <div class="border-t border-border-light pt-4 space-y-4">
                         <h3 class="text-lg font-semibold text-primary-blue">Detalhes Avançados (Opcional)</h3>
                         
                         <label class="flex items-center space-x-3 cursor-pointer">
                             <input type="checkbox" id="treino_em_casa" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue">
                             <span>Treino em Casa (sem equipamento de ginásio)</span>
                         </label>
                         
                         <div id="tecnicas_avancadas_container" class="hide">
                             <label class="flex items-center space-x-3 cursor-pointer">
                                 <input type="checkbox" id="incluir_tecnicas" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue">
                                 <span>Incluir técnicas avançadas (dropsets, supersets, etc.)</span>
                             </label>
                         </div>
                         <div>
                             <label for="musculo_enfase" class="block mb-2 text-text-muted">Músculo a Enfatizar:</label>
                             <input type="text" id="musculo_enfase" placeholder="Ex: Peitoral Superior, Quadríceps" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                         </div>
                         <label class="flex items-center space-x-3 cursor-pointer">
                             <input type="checkbox" id="incluir_dicas" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue" checked>
                             <span>Incluir descrições das técnicas e dicas extra</span>
                         </label>
                    </div>
                </div>

                <button id="btnGerarComIA" type="button" class="w-full py-4 text-xl bg-btn-primary text-white rounded-lg font-semibold transition-opacity duration-300">
                    <span class="flex items-center justify-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Gerar Treino com IA
                    </span>
                </button>

                <div class="my-6 border-t border-border-light"></div>
                
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl mb-6">
                    <h2 class="text-xl md:text-2xl font-semibold text-primary-blue pb-2 border-b border-border-light">2. Reveja e Ajuste o Treino Gerado</h2>
                    <textarea id="observacoes_gerais" class="w-full p-4 mt-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg" placeholder="Observações gerais para o aluno (geradas pela IA)"></textarea>
                    <div id="diasDeTreinoContainer" class="space-y-6 mt-4"></div>
                    <button id="btnAddDia" type="button" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold mt-6">+ Adicionar Dia Manualmente</button>
                </div>
                
                <button id="btnGerarPreview" type="button" class="w-full py-4 text-xl bg-btn-primary text-white rounded-lg font-semibold mt-4">Pré-visualizar e Guardar</button>
            </form>

            <!-- Tela de Preview e Salvar/Exportar -->
            <div id="treinoPreview" class="hide">
                 <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl">
                     <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">Pré-visualização do Plano</h2>
                     
                     <div id="analiseNutricionalPreview" class="mb-6 bg-bg-container p-4 rounded-lg border border-border-light"></div>

                     <div id="treinosPreviewContainer" class="space-y-6"></div>
                     
                     <div class="mt-8 space-y-4">
                         <input type="text" id="treinoNomeSalvo" placeholder="Nome do Treino (Ex: Hipertrofia - Mês 1)" class="w-full p-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg">
                         <div class="flex flex-col sm:flex-row gap-4">
                            <!-- NOVO: Botão para salvar como modelo -->
                            <button id="btnSalvarComoModelo" type="button" class="w-full py-3 text-lg bg-blue-800 text-white rounded-lg font-semibold">Guardar como Modelo</button>
                            <button id="btnSalvarTreino" type="button" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold">Guardar Treino na Nuvem</button>
                         </div>
                     </div>

                     <div class="flex flex-col sm:flex-row gap-4 mt-6">
                         <button id="btnVoltarForm" type="button" class="w-full py-3 text-lg bg-btn-secondary text-white rounded-lg font-semibold">← Editar</button>
                         <button id="btnGerarPDF" type="button" class="w-full py-3 text-lg bg-btn-primary text-white rounded-lg font-semibold">Gerar e Descarregar PDF</button>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar/Editar Aluno -->
    <div id="addAlunoModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeAddAlunoModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="modalAlunoTitle" class="text-2xl font-semibold text-text-light mb-4">Registar Novo Aluno</h3>
            <form id="formAddAluno" class="space-y-4">
                <input type="hidden" id="alunoIdHidden">
                <div><label for="alunoNome" class="block text-text-muted">Nome do Aluno:</label><input type="text" id="alunoNome" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoIdade" class="block text-text-muted">Idade:</label><input type="number" id="alunoIdade" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                    <div>
                        <label for="alunoSexo" class="block text-text-muted">Sexo:</label>
                        <select id="alunoSexo" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoAltura" class="block text-text-muted">Altura (cm):</label><input type="number" id="alunoAltura" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                    <div><label for="alunoPesoInicial" class="block text-text-muted">Peso (kg):</label><input type="number" step="0.1" id="alunoPesoInicial" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoEmail" class="block text-text-muted">Email (Opcional):</label><input type="email" id="alunoEmail" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label for="alunoTelefone" class="block text-text-muted">Telefone (Opcional):</label><input type="tel" id="alunoTelefone" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                </div>
                <div><label for="alunoObjetivo" class="block text-text-muted">Objetivo Principal:</label><input type="text" id="alunoObjetivo" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                <div class="mt-6 flex justify-end"><button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Aluno</button></div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Perfil do Treinador -->
    <div id="editProfileModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeEditProfileModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Editar Perfil</h3>
            <form id="editProfileForm" class="space-y-4">
                <div>
                    <label for="editNameInput" class="block text-text-muted">Nome Completo:</label>
                    <input type="text" id="editNameInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                </div>
                <div>
                    <label for="editDisplayNameInput" class="block text-text-muted">Como quer ser chamado(a):</label>
                    <input type="text" id="editDisplayNameInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Adicionar Avaliação Física -->
    <div id="addAvaliacaoModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-4 sm:p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-2xl relative">
            <span id="closeAddAvaliacaoModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-6">Nova Avaliação Física</h3>
            <form id="formAddAvaliacao" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="avaliacaoData" class="block text-text-muted">Data da Avaliação:</label>
                        <input type="date" id="avaliacaoData" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                    </div>
                    <div>
                        <label for="avaliacaoPeso" class="block text-text-muted">Peso (kg):</label>
                        <input type="number" step="0.1" id="avaliacaoPeso" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                    </div>
                </div>
                <h4 class="text-lg font-semibold text-primary-blue pt-4 border-t border-border-light">Medidas Corporais (cm)</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-text-muted text-sm">Peito:</label><input type="number" step="0.1" data-medida="peito" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Braço D:</label><input type="number" step="0.1" data-medida="braco_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Braço E:</label><input type="number" step="0.1" data-medida="braco_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Cintura:</label><input type="number" step="0.1" data-medida="cintura" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Abdômen:</label><input type="number" step="0.1" data-medida="abdomen" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Quadril:</label><input type="number" step="0.1" data-medida="quadril" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Coxa D:</label><input type="number" step="0.1" data-medida="coxa_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Coxa E:</label><input type="number" step="0.1" data-medida="coxa_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Pant. D:</label><input type="number" step="0.1" data-medida="panturrilha_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Pant. E:</label><input type="number" step="0.1" data-medida="panturrilha_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Avaliação</button></div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmationModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-md relative text-center">
            <h3 id="confirmationTitle" class="text-xl font-semibold text-text-light mb-4"></h3>
            <p id="confirmationMessage" class="text-text-muted mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="btnConfirm" class="py-2 px-6 bg-btn-danger text-white rounded-lg font-semibold">Confirmar</button>
                <button id="btnCancel" class="py-2 px-6 bg-btn-secondary text-white rounded-lg font-semibold">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Opções de Guardar -->
    <div id="saveOptionsModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-md relative text-center">
            <h3 id="saveOptionsTitle" class="text-xl font-semibold text-text-light mb-4">Guardar Treino</h3>
            <p id="saveOptionsMessage" class="text-text-muted mb-6">Este treino já existe. O que deseja fazer?</p>
            <div class="flex flex-col gap-4">
                <button id="btnUpdateWorkout" class="w-full py-3 bg-btn-primary text-white rounded-lg font-semibold">Guardar Alterações</button>
                <button id="btnSaveAsNewWorkout" class="w-full py-3 bg-primary-blue text-white rounded-lg font-semibold">Guardar como Novo Treino</button>
                <button id="btnCancelSave" class="w-full py-2 bg-btn-secondary text-white rounded-lg font-semibold mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para exibir os Gráficos -->
    <div id="chartModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-4xl relative">
            <span id="closeChartModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="chartModalTitle" class="text-2xl font-semibold text-text-light mb-4">Visualização de Progresso</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold text-primary-blue text-center mb-2">Evolução do Peso (kg)</h4>
                    <canvas id="weightChart"></canvas>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-primary-blue text-center mb-2">Comparativo de Medidas (cm)</h4>
                    <canvas id="measuresChart"></canvas>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="btnDownloadChart" class="py-2 px-6 bg-btn-primary text-white rounded-lg font-semibold">Descarregar Gráficos</button>
            </div>
        </div>
    </div>

    <!-- Modal para Partilhar Link -->
    <div id="shareLinkModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeShareLinkModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Partilhar Link do Treino</h3>
            <p class="text-text-muted mb-4">Envie este link para o seu aluno. Ele terá acesso apenas a este plano de treino.</p>
            <div class="relative">
                <input type="text" id="shareableLinkInput" class="w-full p-3 pr-12 rounded-lg border border-border-light bg-background-dark text-text-light" readonly>
                <button id="btnCopyLink" class="absolute inset-y-0 right-0 px-3 text-text-muted hover:text-primary-blue">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal para carregar Templates de Treino -->
    <div id="loadTemplateModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-2xl relative">
            <span id="closeLoadTemplateModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Carregar a Partir de um Modelo</h3>
            <div id="templateListContainer" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- A lista de templates será inserida aqui -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, deleteDoc, serverTimestamp, query, where, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // --- FUNÇÕES GLOBAIS / UTILITÁRIAS ---
        function toggleSpinner(show, message = "Aguarde...") {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                document.getElementById('spinner-message').textContent = message;
                spinner.classList.toggle('hide', !show);
            }
        }

        function showNotification(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            const iconContainer = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');

            if (notification && iconContainer && titleEl && messageEl) {
                titleEl.textContent = title;
                messageEl.textContent = message;

                const successIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                const errorIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

                if (type === 'success') {
                    notification.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 bg-btn-success opacity-100 visible translate-y-0 w-full max-w-sm shadow-lg`;
                    iconContainer.innerHTML = successIcon;
                } else {
                    notification.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 bg-btn-danger opacity-100 visible translate-y-0 w-full max-w-sm shadow-lg`;
                    iconContainer.innerHTML = errorIcon;
                }

                setTimeout(() => {
                    notification.className = notification.className.replace('opacity-100 visible translate-y-0', 'opacity-0 invisible -translate-y-10');
                }, 4000);
            }
        }

        // --- INICIALIZAÇÃO DO FIREBASE E DA APLICAÇÃO ---
        let app, auth, db;

        try {
            const encodedConfig = 'eyJhcGlLZXkiOiJBSXphU3lEcjU0NGU0M19pS1dOVkw5VUNLZEtPTk1fczlfZ0d4VHMiLCJhdXRoRG9tYWluIjoic2FtcGxlLWZpcmViYXNlLWFpLWFwcC03YzRiOC5maXJlYmFzZWFwcC5jb20iLCJwcm9qZWN0SWQiOiJzYW1wbGUtZmlyZWJhc2UtYWktYXBwLTdjNGI4Iiwic3RvcmFnZUJ1Y2tldCI6InNhbXBsZS1maXJlYmFzZS1haS1hcHAtN2M0YjguYXBwc3BvdC5jb20iLCJtZXNzYWdpbmdTZW5kZXJJZCI6IjYxNDg5MjIzODQiLCJhcHBJZCI6IjE6NjE0ODkyMjM4NDp3ZWI6YmM2YzllZTM0MGQ5NzI2YWNmYmU5NSJ9';
            const decodedConfig = atob(encodedConfig);
            const firebaseConfig = JSON.parse(decodedConfig);

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado com sucesso!");

        } catch (error) {
            console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
            showNotification("Erro crítico", "Falha ao conectar com a aplicação. Verifique a console.", "error");
        }

        // --- INICIALIZAÇÃO DAS VIEWS ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!app || !auth || !db) {
                console.error("A aplicação não pode iniciar porque o Firebase falhou a inicialização.");
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const publicId = params.get('publicId');

            if (publicId) {
                initializePublicView(publicId);
            } else {
                initializeTrainerApp();
            }
        });

        // --- LÓGICA DA PÁGINA PÚBLICA ---
        async function initializePublicView(publicId) {
            document.getElementById('mainApp').classList.add('hide');
            const publicView = document.getElementById('publicView');
            publicView.classList.remove('hide');
            toggleSpinner(true, "A carregar treino...");

            try {
                const publicDocRef = doc(db, "publicTrainings", publicId);
                const docSnap = await getDoc(publicDocRef);

                if (docSnap.exists()) {
                    renderPublicTraining(docSnap.data());
                    document.getElementById('publicContent').classList.remove('hide');
                    document.getElementById('publicError').classList.add('hide');
                } else {
                    document.getElementById('publicContent').classList.add('hide');
                    document.getElementById('publicError').classList.remove('hide');
                }
            } catch (error) {
                console.error("Erro ao carregar treino público:", error);
                document.getElementById('publicContent').classList.add('hide');
                document.getElementById('publicError').classList.remove('hide');
            } finally {
                toggleSpinner(false);
            }
        }
        
        function renderPublicTraining(data) {
            document.getElementById('publicAlunoNome').textContent = data.alunoNome;
            document.getElementById('publicTrainerInfo').textContent = `Preparado por: ${data.trainerName}`;
            const container = document.getElementById('publicTreinoContainer');
            container.innerHTML = '';

            if (data.analiseNutricional) {
                const { imc, tmb, caloriasRecomendadas } = data.analiseNutricional;
                container.innerHTML += `
                    <div class="mb-6 bg-bg-container p-4 rounded-lg border border-border-light">
                        <h3 class="text-lg font-semibold text-primary-blue mb-2">Análise Corporal e Metas</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <p><strong class="text-text-light">IMC:</strong> ${imc || 'N/D'}</p>
                            <p><strong class="text-text-light">TMB:</strong> ${tmb || 'N/D'}</p>
                            <p><strong class="text-text-light">Calorias (Obj.):</strong> ${caloriasRecomendadas || 'N/D'}</p>
                        </div>
                    </div>
                `;
            }

            if (data.observacoes) {
                container.innerHTML += `<div class="mb-4"><h4 class="font-bold text-primary-blue">Observações Gerais:</h4><p class="text-text-muted whitespace-pre-wrap">${data.observacoes}</p></div>`;
            }

            if (!data.dias || !Array.isArray(data.dias) || data.dias.length === 0) {
                container.innerHTML += '<p class="text-text-muted text-center py-8">Nenhum dia de treino foi encontrado neste plano.</p>';
                return;
            }

            const youtubeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-red-500"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" /></svg>`;

            data.dias.forEach(dia => {
                let diaHTML = `<div class="mb-4">
                    <h3 class="text-xl font-semibold text-text-light border-b-2 border-primary-blue pb-1 mb-3">${dia.nome} <span class="text-base font-normal text-text-muted">- ${dia.musculos}</span></h3>`;

                // Renderizar Aquecimento, Cardio, Arrefecimento
                if (dia.aquecimento) diaHTML += `<div class="mb-3"><h4 class="font-semibold text-primary-blue text-sm">Aquecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.aquecimento}</p></div>`;
                
                if (dia.exercicios && Array.isArray(dia.exercicios) && dia.exercicios.length > 0) {
                    let exerciciosHTML = dia.exercicios.map(ex => {
                        const nomeExercicioComVideo = ex.videoUrl 
                            ? `<a href="${ex.videoUrl}" target="_blank" class="flex items-center text-primary-blue hover:underline">
                                   <span>${ex.nome}</span>
                                   <span class="ml-2">${youtubeIcon}</span>
                               </a>` 
                            : `<span>${ex.nome}</span>`;

                        const obsHTML = ex.obs ? `<tr class="bg-background-dark"><td colspan="4" class="text-xs text-primary-blue pt-1 pb-2 px-2">${ex.obs}</td></tr>` : '';

                        return `
                            <tr class="border-b border-border-light">
                                <td class="py-2 px-2">${nomeExercicioComVideo}</td>
                                <td class="py-2 px-2 text-center">${ex.series || '-'}</td>
                                <td class="py-2 px-2 text-center">${ex.reps || '-'}</td>
                                <td class="py-2 px-2 text-center">${ex.descanso || '-'}</td>
                            </tr>
                            ${obsHTML}
                        `;
                    }).join('');
                    
                    diaHTML += `<table class="w-full text-left text-sm">
                        <thead><tr class="text-text-muted"><th class="w-2/5 font-semibold py-2 px-2">Exercício</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Séries</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Reps</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Descanso</th></tr></thead>
                        <tbody>${exerciciosHTML}</tbody>
                    </table>`;
                }
                
                if (dia.cardio) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Cardio:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.cardio}</p></div>`;
                if (dia.arrefecimento) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Arrefecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.arrefecimento}</p></div>`;

                diaHTML += `</div>`;
                container.innerHTML += diaHTML;
            });

            if (data.tecnicas && data.tecnicas.length > 0) {
                let tecnicasHTML = data.tecnicas.map(t => `<li><strong class="text-text-light">${t.nome}:</strong> ${t.descricao}</li>`).join('');
                container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Técnicas Utilizadas</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${tecnicasHTML}</ul></div>`;
            }
            if (data.dicas && data.dicas.length > 0) {
                let dicasHTML = data.dicas.map(d => `<li>${d}</li>`).join('');
                container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Dicas Extra</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${dicasHTML}</ul></div>`;
            }
        }

        // --- LÓGICA PRINCIPAL DA APLICAÇÃO DO TREINADOR ---
        function initializeTrainerApp() {
            // --- STATE & DOM ELEMENTS ---
            let appState = { 
                currentUser: null, 
                alunoSelecionado: null, 
                treinoSemanal: [],
                tecnicas: [],
                dicas: [],
                analiseNutricional: {},
                avaliacoesCache: [],
                treinoAbertoId: null,
                alunosCache: [], // NOVO: Cache de alunos para pesquisa/filtro
            };

            const telaLogin = document.getElementById('telaLogin');
            const telaCadastro = document.getElementById('telaCadastro');
            const appContent = document.getElementById('appContent');
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const btnForgotPassword = document.getElementById('btnForgotPassword');
            const btnTogglePassword = document.getElementById('btnTogglePassword');
            const signupForm = document.getElementById('signupForm');
            const signupName = document.getElementById('signupName');
            const signupDisplayName = document.getElementById('signupDisplayName');
            const signupAge = document.getElementById('signupAge');
            const signupEmail = document.getElementById('signupEmail');
            const signupPassword = document.getElementById('signupPassword');
            const linkGoToSignup = document.getElementById('linkGoToSignup');
            const linkGoToLogin = document.getElementById('linkGoToLogin');
            const btnLogout = document.getElementById('btnLogout');
            const userInfo = document.getElementById('userInfo');
            const btnShowAddAlunoModal = document.getElementById('btnShowAddAlunoModal');
            const addAlunoModal = document.getElementById('addAlunoModal');
            const closeAddAlunoModal = document.getElementById('closeAddAlunoModal');
            const formAddAluno = document.getElementById('formAddAluno');
            const listaAlunos = document.getElementById('listaAlunos');
            const nomeAlunoGerenciado = document.getElementById('nomeAlunoGerenciado');
            const btnVoltarParaAlunos = document.getElementById('btnVoltarParaAlunos');
            const btnNovoTreino = document.getElementById('btnNovoTreino');
            const btnCarregarTreino = document.getElementById('btnCarregarTreino');
            const tituloTelaCarregar = document.getElementById('tituloTelaCarregar');
            const btnVoltarParaGerenciarAluno_Carregar = document.getElementById('btnVoltarParaGerenciarAluno_Carregar');
            const btnVoltarParaGerenciarAluno_Form = document.getElementById('btnVoltarParaGerenciarAluno_Form');
            const btnVoltarForm = document.getElementById('btnVoltarForm');
            const diasDeTreinoContainer = document.getElementById('diasDeTreinoContainer');
            const diasSemanaSelect = document.getElementById('dias_semana');
            const divisaoTreinoSelect = document.getElementById('divisao_treino');
            const btnGerarComIA = document.getElementById('btnGerarComIA');
            const dificuldadeSelect = document.getElementById('dificuldade');
            const tecnicasContainer = document.getElementById('tecnicas_avancadas_container');
            const btnAcompanharEvolucao = document.getElementById('btnAcompanharEvolucao');
            const telaAcompanhamento = document.getElementById('telaAcompanhamento');
            const btnVoltarParaGerenciarAluno_Acomp = document.getElementById('btnVoltarParaGerenciarAluno_Acomp');
            const tituloAcompanhamento = document.getElementById('tituloAcompanhamento');
            const btnShowAddAvaliacaoModal = document.getElementById('btnShowAddAvaliacaoModal');
            const addAvaliacaoModal = document.getElementById('addAvaliacaoModal');
            const closeAddAvaliacaoModal = document.getElementById('closeAddAvaliacaoModal');
            const formAddAvaliacao = document.getElementById('formAddAvaliacao');
            const listaAvaliacoes = document.getElementById('listaAvaliacoes');
            const chartModal = document.getElementById('chartModal');
            const closeChartModal = document.getElementById('closeChartModal');
            const chartModalTitle = document.getElementById('chartModalTitle');
            const btnDownloadChart = document.getElementById('btnDownloadChart');
            let weightChartInstance = null;
            let measuresChartInstance = null;
            const modalAlunoTitle = document.getElementById('modalAlunoTitle');
            const alunoIdHidden = document.getElementById('alunoIdHidden');
            const telaBoasVindas = document.getElementById('telaBoasVindas');
            const mensagemBoasVindas = document.getElementById('mensagemBoasVindas');
            const btnIrParaAlunos = document.getElementById('btnIrParaAlunos');
            const btnAdicionarAlunoRapido = document.getElementById('btnAdicionarAlunoRapido');
            const shareLinkModal = document.getElementById('shareLinkModal');
            const closeShareLinkModal = document.getElementById('closeShareLinkModal');
            const shareableLinkInput = document.getElementById('shareableLinkInput');
            const btnCopyLink = document.getElementById('btnCopyLink');
            
            const btnEditProfile = document.getElementById('btnEditProfile');
            const editProfileModal = document.getElementById('editProfileModal');
            const closeEditProfileModal = document.getElementById('closeEditProfileModal');
            const editProfileForm = document.getElementById('editProfileForm');
            const editNameInput = document.getElementById('editNameInput');
            const editDisplayNameInput = document.getElementById('editDisplayNameInput');

            // --- NOVOS Elementos ---
            const alunoSearchInput = document.getElementById('alunoSearchInput');
            const alunoObjectiveFilter = document.getElementById('alunoObjectiveFilter');
            const btnLoadTemplate = document.getElementById('btnLoadTemplate');
            const loadTemplateModal = document.getElementById('loadTemplateModal');
            const closeLoadTemplateModal = document.getElementById('closeLoadTemplateModal');
            const templateListContainer = document.getElementById('templateListContainer');
            const btnSalvarComoModelo = document.getElementById('btnSalvarComoModelo');


            const iconEye = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.01 9.963 7.182.373.836-.018 1.76-.942 1.956a1.012 1.012 0 01-1.258-.453C18.663 15.045 15.564 18 12 18c-3.564 0-6.663-2.955-8.22-5.468z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
            const iconEyeSlash = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;
            if(btnTogglePassword) btnTogglePassword.innerHTML = iconEye;

            // --- AUTH & NAVIGATION ---
            onAuthStateChanged(auth, async user => {
                if (user) {
                    const userDocRef = doc(db, "usuarios", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    let userName = "Treinador(a)";
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        userName = userData.nomeExibicao || userData.nome || "Treinador(a)";
                    }
                    appState.currentUser = { ...user, displayName: userName };

                    userInfo.textContent = `Logado como: ${user.email}`;
                    telaLogin.classList.add('hide');
                    telaCadastro.classList.add('hide');
                    appContent.classList.remove('hide');
                    
                    updateWelcomeMessage();
                    mostrarTela('telaBoasVindas');

                } else {
                    appState.currentUser = null;
                    userInfo.textContent = '';
                    appContent.classList.add('hide');
                    telaCadastro.classList.add('hide');
                    telaLogin.classList.remove('hide');
                }
            });

            linkGoToSignup.addEventListener('click', (e) => { e.preventDefault(); telaLogin.classList.add('hide'); telaCadastro.classList.remove('hide'); });
            linkGoToLogin.addEventListener('click', (e) => { e.preventDefault(); telaCadastro.classList.add('hide'); telaLogin.classList.remove('hide'); });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                toggleSpinner(true, "A criar conta...");
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
                    await setDoc(doc(db, "usuarios", userCredential.user.uid), {
                        nome: signupName.value,
                        nomeExibicao: signupDisplayName.value,
                        idade: signupAge.value,
                        email: signupEmail.value
                    });
                    showNotification("Sucesso!", `Bem-vindo, ${signupDisplayName.value}!`);
                } catch (error) { handleAuthError(error); } 
                finally { toggleSpinner(false); }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                toggleSpinner(true, "A entrar...");
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) { handleAuthError(error); }
                finally { toggleSpinner(false); }
            });

            btnLogout.addEventListener('click', () => signOut(auth));
            btnForgotPassword.addEventListener('click', async () => {
                const email = emailInput.value || prompt("Por favor, digite o seu email para redefinir a palavra-passe:");
                if (!email) return showNotification("Atenção", "Por favor, insira um email.", "error");
                toggleSpinner(true, "A enviar email...");
                try {
                    await sendPasswordResetEmail(auth, email);
                    showNotification("Enviado!", `Email de redefinição enviado para ${email}. Verifique a sua caixa de entrada e spam.`, "success");
                } catch (error) { handleAuthError(error); }
                finally { toggleSpinner(false); }
            });

            btnTogglePassword.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                btnTogglePassword.innerHTML = isPassword ? iconEyeSlash : iconEye;
            });

            function handleAuthError(error) {
                let title = "Erro de Autenticação";
                let message = "Ocorreu um erro. Tente novamente mais tarde.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        title = "Credenciais Inválidas";
                        message = "O email ou a palavra-passe que inseriu estão incorretos.";
                        break;
                    case 'auth/email-already-in-use':
                        title = "Email já Registado";
                        message = "Este endereço de email já está a ser utilizado por outra conta.";
                        break;
                    case 'auth/invalid-email':
                        title = "Email Inválido";
                        message = "O formato do email que inseriu não é válido.";
                        break;
                    case 'auth/weak-password':
                        title = "Palavra-passe Fraca";
                        message = "A sua palavra-passe deve ter pelo menos 6 caracteres.";
                        break;
                }
                showNotification(title, message, 'error');
            }

            // --- LÓGICA DE PERFIL DO TREINADOR ---
            btnEditProfile.addEventListener('click', async () => {
                if (!appState.currentUser) return;
                toggleSpinner(true, "A carregar perfil...");
                try {
                    const userDocRef = doc(db, "usuarios", appState.currentUser.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        editNameInput.value = userData.nome || '';
                        editDisplayNameInput.value = userData.nomeExibicao || '';
                    } else {
                        editNameInput.value = '';
                        editDisplayNameInput.value = '';
                    }
                    editProfileModal.classList.remove('hide');
                } catch (error) {
                    showNotification("Erro", "Erro ao carregar o perfil.", "error");
                    console.error("Erro ao buscar perfil:", error);
                } finally {
                    toggleSpinner(false);
                }
            });

            closeEditProfileModal.addEventListener('click', () => editProfileModal.classList.add('hide'));

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;

                const newName = editNameInput.value.trim();
                const newDisplayName = editDisplayNameInput.value.trim();

                if (!newName || !newDisplayName) {
                    showNotification("Atenção", "Ambos os campos são obrigatórios.", "error");
                    return;
                }

                toggleSpinner(true, "A guardar alterações...");
                try {
                    const userDocRef = doc(db, "usuarios", appState.currentUser.uid);
                    await setDoc(userDocRef, {
                        nome: newName,
                        nomeExibicao: newDisplayName
                    }, { merge: true });

                    appState.currentUser.displayName = newDisplayName;
                    updateWelcomeMessage();

                    showNotification("Sucesso!", "Perfil atualizado com sucesso!");
                    editProfileModal.classList.add('hide');

                } catch (error) {
                    showNotification("Erro", "Erro ao guardar as alterações.", "error");
                    console.error("Erro ao atualizar perfil:", error);
                } finally {
                    toggleSpinner(false);
                }
            });
            
            function updateWelcomeMessage() {
                if (!appState.currentUser) return;
                let nome = appState.currentUser.displayName.split(' ')[0];
                const hora = new Date().getHours();
                let saudacao = "Olá";
                if (hora >= 5 && hora < 12) { saudacao = "Bom dia"; }
                else if (hora >= 12 && hora < 18) { saudacao = "Boa tarde"; }
                else { saudacao = "Boa noite"; }
                mensagemBoasVindas.textContent = `${saudacao}, ${nome}!`;
            }


            // --- LÓGICA DE ALUNOS ---
            btnIrParaAlunos.addEventListener('click', () => {
                carregarAlunos();
                mostrarTela('telaAlunos');
            });
            btnAdicionarAlunoRapido.addEventListener('click', () => {
                formAddAluno.reset();
                alunoIdHidden.value = '';
                modalAlunoTitle.textContent = "Registar Novo Aluno";
                addAlunoModal.classList.remove('hide');
            });
            btnVoltarParaAlunos.addEventListener('click', () => { appState.alunoSelecionado = null; mostrarTela('telaBoasVindas'); });
            btnShowAddAlunoModal.addEventListener('click', () => {
                formAddAluno.reset();
                alunoIdHidden.value = '';
                modalAlunoTitle.textContent = "Registar Novo Aluno";
                addAlunoModal.classList.remove('hide');
            });
            closeAddAlunoModal.addEventListener('click', () => addAlunoModal.classList.add('hide'));

            formAddAluno.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;

                const alunoId = alunoIdHidden.value;
                const isEditing = !!alunoId;

                const nome = document.getElementById('alunoNome').value.trim();
                const idade = parseInt(document.getElementById('alunoIdade').value);
                const sexo = document.getElementById('alunoSexo').value;
                const altura = parseInt(document.getElementById('alunoAltura').value);
                const pesoInicial = parseFloat(document.getElementById('alunoPesoInicial').value);
                const objetivo = document.getElementById('alunoObjetivo').value;
                const email = document.getElementById('alunoEmail').value.trim();
                const telefone = document.getElementById('alunoTelefone').value.trim();

                if (!nome || !objetivo || !altura || !idade || !pesoInicial || !sexo) return showNotification('Atenção', 'Todos os campos obrigatórios devem ser preenchidos.', 'error');
                
                toggleSpinner(true, "A guardar dados...");
                try {
                    const alunosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos");
                    const nomeLowerCase = nome.toLowerCase();
                    
                    if (!isEditing) {
                        const q = query(alunosRef, where("nome_lowercase", "==", nomeLowerCase));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            showNotification("Atenção", "Já existe um aluno com este nome.", "error");
                            toggleSpinner(false);
                            return;
                        }
                    }
                    
                    const alunoData = { 
                        nome, nome_lowercase: nomeLowerCase, idade, sexo, altura, pesoInicial,
                        objetivo, email, telefone
                    };

                    if (isEditing) {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        await updateDoc(alunoDocRef, alunoData);
                        showNotification("Sucesso!", `Dados de "${nome}" atualizados!`);
                    } else {
                        alunoData.criadoEm = serverTimestamp();
                        await addDoc(alunosRef, alunoData);
                        showNotification("Sucesso!", `Aluno "${nome}" registado!`);
                    }

                    formAddAluno.reset();
                    addAlunoModal.classList.add('hide');
                    await carregarAlunos(); // Recarrega os dados do cache
                } catch (error) { 
                    console.error("Erro ao guardar aluno:", error);
                    showNotification("Erro", "Erro ao guardar dados do aluno.", "error");
                } finally { 
                    toggleSpinner(false); 
                }
            });

            // NOVO: Event listeners para filtros
            alunoSearchInput.addEventListener('input', () => renderAlunosList());
            alunoObjectiveFilter.addEventListener('change', () => renderAlunosList());

            async function carregarAlunos() {
                if (!appState.currentUser) return;
                listaAlunos.innerHTML = `<p class="text-text-muted text-center py-8">A carregar...</p>`;
                try {
                    const alunosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos");
                    const querySnapshot = await getDocs(alunosRef);
                    
                    appState.alunosCache = [];
                    querySnapshot.forEach(doc => {
                        appState.alunosCache.push({ id: doc.id, ...doc.data() });
                    });
                    
                    populateObjectiveFilter();
                    renderAlunosList();
                } catch (error) { 
                    appState.alunosCache = [];
                    renderAlunosList();
                    console.error(error);
                }
            }

            // NOVO: Popula o filtro de objetivos
            function populateObjectiveFilter() {
                const objectives = new Set(appState.alunosCache.map(aluno => aluno.objetivo));
                alunoObjectiveFilter.innerHTML = '<option value="">Filtrar por objetivo</option>';
                objectives.forEach(obj => {
                    const option = document.createElement('option');
                    option.value = obj;
                    option.textContent = obj;
                    alunoObjectiveFilter.appendChild(option);
                });
            }

            // NOVO: Renderiza a lista de alunos com base nos filtros
            function renderAlunosList() {
                const searchTerm = alunoSearchInput.value.toLowerCase();
                const selectedObjective = alunoObjectiveFilter.value;

                const filteredAlunos = appState.alunosCache.filter(aluno => {
                    const nameMatch = aluno.nome.toLowerCase().includes(searchTerm);
                    const objectiveMatch = !selectedObjective || aluno.objetivo === selectedObjective;
                    return nameMatch && objectiveMatch;
                });

                if (filteredAlunos.length === 0) {
                     if(appState.alunosCache.length === 0) {
                        listaAlunos.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum aluno registado. Clique em "+ Adicionar Aluno" para começar.</p>`;
                    } else {
                        listaAlunos.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum aluno encontrado com os filtros atuais.</p>`;
                    }
                    return;
                }
                
                listaAlunos.innerHTML = '';
                filteredAlunos.forEach(aluno => {
                    const alunoDiv = document.createElement('div');
                    alunoDiv.className = 'bg-background-dark border border-border-light p-4 rounded-lg flex justify-between items-center';
                    
                    const placeholderIcon = `<div class="w-12 h-12 rounded-full bg-border-light flex items-center justify-center text-text-muted text-xl font-bold">${aluno.nome.charAt(0).toUpperCase()}</div>`;
                    
                    alunoDiv.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow cursor-pointer view-aluno" data-alunoid="${aluno.id}">
                            ${placeholderIcon}
                            <div class="flex-grow">
                                <h4 class="font-semibold text-text-light pointer-events-none">${aluno.nome}</h4>
                                <p class="text-sm text-text-muted pointer-events-none">${aluno.objetivo}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button class="btn-editar-aluno text-primary-blue hover:text-opacity-80 p-2 rounded-full" data-alunoid="${aluno.id}">
                                <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="btn-excluir-aluno text-red-500 hover:text-red-400 p-2 rounded-full" data-alunoid="${aluno.id}">
                                <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`;
                    listaAlunos.appendChild(alunoDiv);
                });
            }
            
            async function deleteSubcollection(collectionRef) {
                const querySnapshot = await getDocs(collectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            }

            listaAlunos.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.btn-excluir-aluno');
                const editButton = e.target.closest('.btn-editar-aluno');
                const viewArea = e.target.closest('.view-aluno');

                if (deleteButton) {
                    const alunoId = deleteButton.dataset.alunoid;
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir este aluno e todos os seus dados? Esta ação não pode ser desfeita.");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir aluno...");
                    try {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        
                        const treinosRef = collection(alunoDocRef, "treinos");
                        await deleteSubcollection(treinosRef);
                        
                        const avaliacoesRef = collection(alunoDocRef, "avaliacoes");
                        await deleteSubcollection(avaliacoesRef);
                        
                        await deleteDoc(alunoDocRef);

                        showNotification("Sucesso!", "Aluno excluído com sucesso.");
                        await carregarAlunos();
                    } catch (error) {
                        console.error("Erro ao excluir aluno:", error);
                        if (error.code === 'permission-denied') {
                            showNotification("Erro de Permissão", "Verifique as regras de segurança do Firebase.", "error");
                        } else {
                            showNotification("Erro", "Erro ao excluir aluno.", "error");
                        }
                    } finally {
                        toggleSpinner(false);
                    }
                } else if (editButton) {
                    const alunoId = editButton.dataset.alunoid;
                    abrirModalEdicao(alunoId);
                } else if (viewArea) {
                    const alunoId = viewArea.dataset.alunoid;
                    toggleSpinner(true, "A carregar dados do aluno...");
                    try {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        const docSnap = await getDoc(alunoDocRef);
                        if (docSnap.exists()) {
                            appState.alunoSelecionado = { id: docSnap.id, ...docSnap.data() };
                            nomeAlunoGerenciado.textContent = `A gerir: ${appState.alunoSelecionado.nome}`;
                            mostrarTela('telaGerenciarAluno');
                        } else { throw new Error("Aluno não encontrado."); }
                    } catch (error) { showNotification("Erro", "Erro ao carregar dados do aluno.", "error"); } 
                    finally { toggleSpinner(false); }
                }
            });
            
            async function abrirModalEdicao(alunoId) {
                toggleSpinner(true, "A carregar dados...");
                try {
                    const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                    const docSnap = await getDoc(alunoDocRef);
                    if (docSnap.exists()) {
                        const aluno = docSnap.data();
                        appState.alunoSelecionado = { id: docSnap.id, ...aluno }; 
                        
                        formAddAluno.reset();
                        alunoIdHidden.value = docSnap.id;
                        modalAlunoTitle.textContent = "Editar Dados do Aluno";
                        
                        document.getElementById('alunoNome').value = aluno.nome || '';
                        document.getElementById('alunoIdade').value = aluno.idade || '';
                        document.getElementById('alunoSexo').value = aluno.sexo || 'Masculino';
                        document.getElementById('alunoAltura').value = aluno.altura || '';
                        document.getElementById('alunoPesoInicial').value = aluno.pesoInicial || '';
                        document.getElementById('alunoEmail').value = aluno.email || '';
                        document.getElementById('alunoTelefone').value = aluno.telefone || '';
                        document.getElementById('alunoObjetivo').value = aluno.objetivo || '';
                        
                        addAlunoModal.classList.remove('hide');
                    }
                } catch (error) {
                    showNotification("Erro", "Erro ao carregar dados para edição.", "error");
                } finally {
                    toggleSpinner(false);
                }
            }
                                
            // --- LÓGICA DE ACOMPANHAMENTO ---
            btnAcompanharEvolucao.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;
                tituloAcompanhamento.textContent = `Evolução de ${appState.alunoSelecionado.nome}`;
                carregarAvaliacoes();
                mostrarTela('telaAcompanhamento');
            });

            btnVoltarParaGerenciarAluno_Acomp.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnShowAddAvaliacaoModal.addEventListener('click', () => {
                formAddAvaliacao.reset();
                document.getElementById('avaliacaoData').value = new Date().toISOString().split('T')[0];
                addAvaliacaoModal.classList.remove('hide');
            });
            closeAddAvaliacaoModal.addEventListener('click', () => addAvaliacaoModal.classList.add('hide'));

            formAddAvaliacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser || !appState.alunoSelecionado) return;

                const data = document.getElementById('avaliacaoData').value;
                const peso = parseFloat(document.getElementById('avaliacaoPeso').value);

                if (!data || !peso) return showNotification("Atenção", "Data e Peso são obrigatórios.", "error");

                const medidas = {};
                document.querySelectorAll('.medida-input').forEach(input => {
                    if (input.value) {
                        medidas[input.dataset.medida] = parseFloat(input.value);
                    }
                });

                toggleSpinner(true, "A guardar avaliação...");
                try {
                    const avaliacoesRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes");
                    await addDoc(avaliacoesRef, { data, peso, medidas, criadoEm: serverTimestamp() });
                    showNotification("Sucesso!", "Avaliação guardada com sucesso!");
                    addAvaliacaoModal.classList.add('hide');
                    carregarAvaliacoes(); // Alterado para carregar avaliações em vez de alunos
                } catch (error) {
                    showNotification("Erro", "Erro ao guardar avaliação.", "error");
                    console.error("Erro:", error);
                } finally {
                    toggleSpinner(false);
                }
            });

            async function carregarAvaliacoes() {
                if (!appState.currentUser || !appState.alunoSelecionado) return;
                listaAvaliacoes.innerHTML = `<p class="text-text-muted text-center py-8">A carregar histórico...</p>`;
                try {
                    const avaliacoesRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes");
                    const querySnapshot = await getDocs(avaliacoesRef);

                    if (querySnapshot.empty) {
                        listaAvaliacoes.innerHTML = `<p class="text-text-muted text-center py-8">Nenhuma avaliação registada. Clique em "+ Nova Avaliação" para começar.</p>`;
                        appState.avaliacoesCache = [];
                        return;
                    }

                    const avaliacoes = [];
                    querySnapshot.forEach(doc => avaliacoes.push({ id: doc.id, ...doc.data() }));
                    
                    avaliacoes.sort((a, b) => new Date(a.data) - new Date(b.data));
                    appState.avaliacoesCache = avaliacoes;

                    renderizarListaAvaliacoes();
                } catch (error) {
                    console.error("Erro ao carregar avaliações:", error);
                    listaAvaliacoes.innerHTML = `<p class="text-red-500 text-center py-8">Erro ao carregar o histórico.</p>`;
                }
            }

            function renderizarListaAvaliacoes() {
                listaAvaliacoes.innerHTML = '';
                const avaliacoesOrdenadas = [...appState.avaliacoesCache].sort((a, b) => new Date(b.data) - new Date(a.data));

                avaliacoesOrdenadas.forEach((av, index) => {
                    const dataFormatada = new Date(av.data + 'T00:00:00').toLocaleDateString('pt-BR');
                    let medidasHTML = Object.entries(av.medidas || {}).map(([key, value]) => `
                        <div class="text-sm"><span class="capitalize text-text-muted">${key.replace(/_/g, ' ')}:</span> <strong class="text-text-light">${value} cm</strong></div>
                    `).join('');

                    if (!medidasHTML) medidasHTML = `<p class="text-text-muted text-sm col-span-2">Nenhuma medida registada.</p>`;

                    const card = document.createElement('div');
                    card.className = "bg-background-dark border border-border-light p-4 rounded-lg";
                    card.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-2 mb-3">
                            <div>
                                <h4 class="font-bold text-primary-blue text-xl">${dataFormatada}</h4>
                                <p class="font-semibold text-text-light text-lg">${av.peso} kg</p>
                            </div>
                            <div class="flex gap-2 self-end sm:self-start">
                                <button class="btn-ver-grafico py-2 px-3 text-sm bg-btn-success text-white rounded-lg font-semibold flex items-center gap-1" data-avaliacaoindex="${index}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                    Gráfico
                                </button>
                                <button class="btn-excluir-avaliacao text-red-500 hover:text-red-400 p-2 rounded-full" data-avaliacaoid="${av.id}">
                                    <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 pt-3 border-t border-border-light">
                            ${medidasHTML}
                        </div>
                    `;
                    listaAvaliacoes.appendChild(card);
                });
            }


            listaAvaliacoes.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.btn-excluir-avaliacao');
                const chartButton = e.target.closest('.btn-ver-grafico');

                if (deleteButton) {
                    const avaliacaoId = deleteButton.dataset.avaliacaoid;
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir esta avaliação?");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir...");
                    try {
                        const avaliacaoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes", avaliacaoId);
                        await deleteDoc(avaliacaoDocRef);
                        showNotification("Sucesso!", "Avaliação excluída.");
                        carregarAvaliacoes();
                    } catch (error) {
                        showNotification("Erro", "Erro ao excluir.", "error");
                    } finally {
                        toggleSpinner(false);
                    }
                }

                if (chartButton) {
                    const index = parseInt(chartButton.dataset.avaliacaoindex, 10);
                    abrirModalGrafico(index);
                }
            });

            // --- LÓGICA DOS GRÁFICOS ---
            closeChartModal.addEventListener('click', () => chartModal.classList.add('hide'));

            function abrirModalGrafico(index) {
                const avaliacoesOrdenadas = [...appState.avaliacoesCache].sort((a, b) => new Date(b.data) - new Date(a.data));
                const avaliacaoAtual = avaliacoesOrdenadas[index];
                const avaliacaoAnterior = avaliacoesOrdenadas[index + 1] || null;

                const dataFormatada = new Date(avaliacaoAtual.data + 'T00:00:00').toLocaleDateString('pt-BR');
                chartModalTitle.textContent = `Progresso até ${dataFormatada}`;

                gerarGraficoPeso();
                gerarGraficoMedidas(avaliacaoAtual, avaliacaoAnterior);

                chartModal.classList.remove('hide');
            }

            function gerarGraficoPeso() {
                const ctx = document.getElementById('weightChart').getContext('2d');
                if (weightChartInstance) {
                    weightChartInstance.destroy();
                }
                
                const labels = appState.avaliacoesCache.map(av => new Date(av.data + 'T00:00:00').toLocaleDateString('pt-BR'));
                const data = appState.avaliacoesCache.map(av => av.peso);

                weightChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Peso (kg)',
                            data: data,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: '#c9d1d9' } },
                            x: { ticks: { color: '#c9d1d9' } }
                        }
                    }
                });
            }

            function gerarGraficoMedidas(atual, anterior) {
                const ctx = document.getElementById('measuresChart').getContext('2d');
                if (measuresChartInstance) {
                    measuresChartInstance.destroy();
                }
                
                const todasMedidas = new Set([...Object.keys(atual.medidas || {}), ...(anterior ? Object.keys(anterior.medidas || {}) : [])]);
                const labels = Array.from(todasMedidas).map(key => key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
                
                const dataAtual = labels.map(label => (atual.medidas || {})[label.toLowerCase().replace(/ /g, '_')] || 0);
                const dataAnterior = anterior ? labels.map(label => (anterior.medidas || {})[label.toLowerCase().replace(/ /g, '_')] || 0) : [];

                const datasets = [{
                    label: `Atual (${new Date(atual.data + 'T00:00:00').toLocaleDateString('pt-BR')})`,
                    data: dataAtual,
                    borderColor: '#38c172',
                    backgroundColor: 'rgba(56, 193, 114, 0.2)',
                    pointBackgroundColor: '#38c172'
                }];

                if (anterior) {
                    datasets.push({
                        label: `Anterior (${new Date(anterior.data + 'T00:00:00').toLocaleDateString('pt-BR')})`,
                        data: dataAnterior,
                        borderColor: '#8b949e',
                        backgroundColor: 'rgba(139, 148, 158, 0.2)',
                        pointBackgroundColor: '#8b949e'
                    });
                }

                measuresChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: '#c9d1d9' } } },
                        scales: {
                            r: {
                                angleLines: { color: '#30363d' },
                                grid: { color: '#30363d' },
                                pointLabels: { color: '#c9d1d9', font: { size: 12 } },
                                ticks: {
                                    color: '#c9d1d9',
                                    backdropColor: '#161b22'
                                }
                            }
                        }
                    }
                });
            }

            btnDownloadChart.addEventListener('click', () => {
                const canvasPeso = document.getElementById('weightChart');
                const canvasMedidas = document.getElementById('measuresChart');
                
                const combinedCanvas = document.createElement('canvas');
                const padding = 50;
                combinedCanvas.width = canvasPeso.width + canvasMedidas.width + padding * 2;
                combinedCanvas.height = Math.max(canvasPeso.height, canvasMedidas.height) + padding * 2;
                const ctx = combinedCanvas.getContext('2d');

                ctx.fillStyle = '#161b22';
                ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
                
                ctx.drawImage(canvasPeso, padding, padding);
                ctx.drawImage(canvasMedidas, canvasPeso.width + padding, padding);

                ctx.fillStyle = '#c9d1d9';
                ctx.font = '24px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText(`Progresso de ${appState.alunoSelecionado.nome}`, combinedCanvas.width / 2, padding - 10);

                const link = document.createElement('a');
                link.download = `progresso_${appState.alunoSelecionado.nome.replace(/\s/g, '_')}.png`;
                link.href = combinedCanvas.toDataURL('image/png');
                link.click();
                showNotification("Sucesso!", "Gráfico descarregado com sucesso!");
            });


            // --- FUNÇÕES DE CÁLCULO NUTRICIONAL ---
            function calcularIMC(peso, alturaCm) {
                if (!peso || !alturaCm) return { valor: 0, classificacao: "Dados insuficientes" };
                const alturaM = alturaCm / 100;
                const imc = peso / (alturaM * alturaM);
                let classificacao = "Normal";
                if (imc < 18.5) classificacao = "Abaixo do peso";
                else if (imc >= 25 && imc < 30) classificacao = "Excesso de peso";
                else if (imc >= 30) classificacao = "Obesidade";
                return { valor: imc.toFixed(2), classificacao };
            }

            function calcularTMB(peso, alturaCm, idade, sexo) {
                if (!peso || !alturaCm || !idade || !sexo) return 0;
                if (sexo === 'Masculino') {
                    return (10 * peso + 6.25 * alturaCm - 5 * idade + 5).toFixed(0);
                } else {
                    return (10 * peso + 6.25 * alturaCm - 5 * idade - 161).toFixed(0);
                }
            }

            function calcularCaloriasRecomendadas(tmb, objetivo) {
                if (!tmb || !objetivo) return 0;
                const fatorAtividade = 1.55;
                const gastoTotal = tmb * fatorAtividade;
                
                if (objetivo.toLowerCase().includes('emagrecimento')) return (gastoTotal - 400).toFixed(0);
                if (objetivo.toLowerCase().includes('hipertrofia')) return (gastoTotal + 400).toFixed(0);
                return gastoTotal.toFixed(0);
            }

            // --- LÓGICA DE GERAÇÃO DE TREINO ---
            btnNovoTreino.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;

                appState.treinoAbertoId = null; 

                const { altura, idade, objetivo, sexo } = appState.alunoSelecionado;
                const ultimoPeso = appState.avaliacoesCache.length > 0 ? appState.avaliacoesCache[appState.avaliacoesCache.length - 1].peso : appState.alunoSelecionado.pesoInicial;
                const imc = calcularIMC(ultimoPeso, altura);
                const tmb = calcularTMB(ultimoPeso, altura, idade, sexo);
                const calorias = calcularCaloriasRecomendadas(tmb, objetivo);

                appState.analiseNutricional = {
                    imc: `${imc.valor} (${imc.classificacao})`,
                    tmb: `${tmb} kcal`,
                    caloriasRecomendadas: `${calorias} kcal`,
                    pesoIdeal: `~${(22 * (altura/100) * (altura/100)).toFixed(1)} kg`,
                    dataCriacao: new Date().toLocaleDateString('pt-BR')
                };
                
                appState.treinoSemanal = [];
                appState.tecnicas = [];
                appState.dicas = [];
                document.getElementById('treinoForm').reset();
                diasDeTreinoContainer.innerHTML = '';
                document.getElementById('nome_aluno_form').value = appState.alunoSelecionado.nome;
                atualizarDivisoes();
                tecnicasContainer.classList.add('hide');
                mostrarTela('treinoForm');
            });

            btnCarregarTreino.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;
                tituloTelaCarregar.textContent = `Treinos de ${appState.alunoSelecionado.nome}`;
                carregarTreinosSalvos();
                mostrarTela('telaCarregar');
            });

            btnVoltarParaGerenciarAluno_Carregar.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnVoltarParaGerenciarAluno_Form.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnVoltarForm.addEventListener('click', () => mostrarTela('treinoForm'));

            const divisoesSugeridas = {
                '1': ['Full Body (Corpo Inteiro)', 'Treino Específico (Ex: Só Pernas)'],
                '3': ['ABC (Peito-Ombro-Tríceps / Costas-Bíceps / Pernas)', 'Full Body (Corpo Inteiro 3x)'],
                '4': ['Upper/Lower (Superiores/Inferiores 2x)', 'ABCD (Ex: Peito / Costas / Pernas / Ombros)'],
                '5': ['ABCDE (Push/Pull/Legs/Upper/Lower)', 'ABCAB (Ex: Peito-Tríceps / Costas-Bíceps / Pernas / Repete A e B)'],
                '6': ['ABCABC (Push/Pull/Legs 2x)', 'Divisão por grupo muscular isolado']
            };

            const divisoesSugeridasFeminino = {
                '1': ['Full Body (Foco em Glúteos)', 'Inferiores Completo'],
                '3': ['Inferior/Superior/Full Body', 'ABC (Foco Inferiores: Posterior/Glúteo / Quadríceps / Superiores)'],
                '4': ['Inferior/Superior/Inferior/Superior', 'ABCD (Posterior/Glúteo / Superiores A / Quadríceps / Superiores B)'],
                '5': ['Inferior/Superior/Inferior/Superior/Inferior', 'ABCDE (Posterior / Quadríceps / Superiores Push / Glúteo / Superiores Pull)'],
                '6': ['Inferior/Superior/Inferior/Superior/Inferior/Superior', 'PPL PPL (com ênfase em Glúteos nos dias de perna)']
            };

            function atualizarDivisoes() {
                const dias = diasSemanaSelect.value;
                const sexoAluno = appState.alunoSelecionado ? appState.alunoSelecionado.sexo : 'Masculino';
                const divisoes = sexoAluno === 'Feminino' ? divisoesSugeridasFeminino : divisoesSugeridas;

                divisaoTreinoSelect.innerHTML = '';
                if (divisoes[dias]) {
                    divisoes[dias].forEach(divisao => {
                        divisaoTreinoSelect.innerHTML += `<option value="${divisao}">${divisao}</option>`;
                    });
                }
            }
            diasSemanaSelect.addEventListener('change', atualizarDivisoes);
            
            dificuldadeSelect.addEventListener('change', () => {
                tecnicasContainer.classList.toggle('hide', dificuldadeSelect.value !== 'Avancado');
            });
            
            async function getExerciseHistory(alunoId) {
                if (!appState.currentUser || !alunoId) return "";

                try {
                    const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", alunoId, "treinos");
                    const q = query(treinosRef, orderBy("criadoEm", "desc"), limit(2));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) return "";

                    const exercises = new Set();
                    querySnapshot.forEach(doc => {
                        const treino = doc.data();
                        if (treino.dias && Array.isArray(treino.dias)) {
                            treino.dias.forEach(dia => {
                                if (dia.exercicios && Array.isArray(dia.exercicios)) {
                                    dia.exercicios.forEach(ex => exercises.add(ex.nome.trim()));
                                }
                            });
                        }
                    });

                    if (exercises.size === 0) return "";

                    const exerciseList = Array.from(exercises).join(', ');
                    return `\n- **Histórico de Exercícios Recentes (EVITAR REPETIR):** ${exerciseList}`;

                } catch (error) {
                    console.error("Erro ao buscar histórico de exercícios:", error);
                    return "";
                }
            }

            btnGerarComIA.addEventListener('click', async () => {
                if (!appState.alunoSelecionado) return;
                
                const duracaoTreino = document.getElementById('duracao_treino').value;
                const treinoEmCasa = document.getElementById('treino_em_casa').checked;
                const incluirTecnicas = document.getElementById('incluir_tecnicas').checked && dificuldadeSelect.value !== 'Iniciante';
                const musculoEnfase = document.getElementById('musculo_enfase').value.trim();
                const incluirDicas = document.getElementById('incluir_dicas').checked;
                const observacoesIA = document.getElementById('observacoes_ia').value.trim(); // NOVO
                
                toggleSpinner(true, "A analisar histórico e criar um treino único...");
                btnGerarComIA.disabled = true;
                btnGerarComIA.classList.add('opacity-50', 'cursor-not-allowed');

                const exerciseHistory = await getExerciseHistory(appState.alunoSelecionado.id);

                // ---------- PROMPT MELHORADO ----------
                let prompt = `Você é um Personal Trainer de elite, especialista em fisiologia do exercício e nutrição esportiva. Sua missão é criar o melhor plano de treino possível, detalhado, científico e motivador.

## Regras Críticas:
- **Links Válidos:** É OBRIGATÓRIO incluir um \`videoUrl\` funcional do YouTube para CADA exercício, demonstrando a execução correta. Use sua ferramenta de pesquisa para validar.
- **Formato JSON:** Responda APENAS com o objeto JSON, sem nenhum texto extra.
- **Volume do Treino:** Cada dia deve conter pelo menos 5-7 exercícios de musculação.
- **Variedade é Chave:** O treino deve ser NOVO e CRIATIVO. **NÃO REPITA** os exercícios do histórico fornecido. Use variações e ângulos diferentes.
- **Treino Completo:** Inclua sugestões para \`aquecimento\`, \`cardio\`, e \`arrefecimento\` em cada dia de treino, como strings de texto.
- **Dicas Inteligentes:** Se solicitado, gere 3 a 5 dicas personalizadas e acionáveis, baseadas nos dados do aluno.

`;
                if (appState.alunoSelecionado.sexo === 'Feminino') {
                    prompt += `## Instruções para Treino Feminino:
- **Foco:** Dê ênfase especial ao desenvolvimento de glúteos, posteriores e quadríceps. Priorize exercícios como agachamento, levantamento terra romeno, elevação pélvica, e afundo.
- **Equilíbrio:** Construa um treino de superiores equilibrado para fortalecer costas e ombros.
`;
                }
                prompt += `---
Crie o plano de treino para o(a) seguinte aluno(a):
- Aluno(a): "${appState.alunoSelecionado.nome}"
- Sexo: ${appState.alunoSelecionado.sexo}
- Idade: ${appState.alunoSelecionado.idade} anos
- Nível: ${dificuldadeSelect.value}
- Objetivo Principal: ${document.getElementById('objetivo').value}
- Frequência: ${diasSemanaSelect.value} dias por semana
- Divisão de Treino Sugerida: ${divisaoTreinoSelect.value}`;

                if (exerciseHistory) { prompt += exerciseHistory; }
                if (observacoesIA) { prompt += `\n- **Restrições/Observações do Aluno (MUITO IMPORTANTE):** ${observacoesIA}`; } // NOVO
                if (duracaoTreino !== 'N/A') { prompt += `\n- **Duração Máxima por Sessão:** ${duracaoTreino}.`; }
                if (treinoEmCasa) { prompt += `\n- **Local:** Treino em casa. Utilize APENAS o peso corporal.`; }
                if (incluirTecnicas) { prompt += `\n- **Técnicas Avançadas:** Incorpore UMA técnica avançada (drop set, superset, etc.) em no MÁXIMO DOIS exercícios por dia.`; }
                if (musculoEnfase) { prompt += `\n- **Ênfase Muscular:** Foco especial em: ${musculoEnfase}.`; }
                if (incluirDicas) { prompt += `\n- **Descrições e Dicas:** Forneça a seção de técnicas e dicas personalizadas.`; }
                prompt += `\nResponda APENAS com o JSON estruturado.`;
                // ---------- FIM DO PROMPT MELHORADO ----------

                const schema = {
                    type: "OBJECT",
                    properties: {
                        observacoes_gerais: { type: "STRING" },
                        plano_semanal: { 
                            type: "ARRAY", 
                            items: { 
                                type: "OBJECT", 
                                properties: { 
                                    nome_dia: { type: "STRING" }, 
                                    grupos_musculares: { type: "STRING" },
                                    aquecimento: { type: "STRING" }, // NOVO
                                    exercicios: { 
                                        type: "ARRAY", 
                                        items: { 
                                            type: "OBJECT", 
                                            properties: { 
                                                nome: { type: "STRING" }, series: { type: "STRING" }, reps: { type: "STRING" },
                                                descanso: { type: "STRING" }, obs: { type: "STRING" }, videoUrl: { type: "STRING" }
                                            },
                                            required: ["nome", "series", "reps", "descanso", "videoUrl"]
                                        } 
                                    },
                                    cardio: { type: "STRING" }, // NOVO
                                    arrefecimento: { type: "STRING" } // NOVO
                                },
                                required: ["nome_dia", "grupos_musculares", "exercicios"]
                            } 
                        },
                        tecnicas_utilizadas: { type: "ARRAY", items: { type: "OBJECT", properties: { nome: { type: "STRING" }, descricao: { type: "STRING" } } } },
                        dicas_extras: { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["observacoes_gerais", "plano_semanal"]
                };
                
                try {
                    const apiKey = "AIzaSyCIa13DPD2yAF_EfNBah1sY39injiZuiYA"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const payload = { 
                        contents: [{ role: "user", parts: [{ text: prompt }] }], 
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema },
                        tools: [{ "google_search": {} }]
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        let errorDetails = `HTTP status ${response.status}: ${response.statusText}`;
                        try {
                            const errorJson = await response.json();
                            errorDetails = errorJson.error?.message || JSON.stringify(errorJson);
                        } catch (e) { console.log("Could not parse error response body as JSON."); }
                        throw new Error(`API Error: ${errorDetails}`);
                    }

                    const result = await response.json();
                    let textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textPart) throw new Error("Resposta da IA inválida ou vazia.");

                    const startIndex = textPart.indexOf('{');
                    const endIndex = textPart.lastIndexOf('}');

                    if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
                        console.error("Resposta da IA recebida:", textPart);
                        throw new Error("Não foi possível encontrar um objeto JSON válido na resposta da IA.");
                    }
                    textPart = textPart.substring(startIndex, endIndex + 1);

                    const treinoJson = JSON.parse(textPart);
                    preencherFormularioComIA(treinoJson);
                    showNotification("Sucesso!", "Sugestão de treino gerada! Reveja e ajuste se necessário.");
                } catch (error) {
                    console.error("Erro ao gerar treino com IA:", error);
                    if (error.message && (error.message.includes('quota') || error.message.includes('rate limit'))) {
                        showNotification(
                            "Limite de Pedidos Atingido", 
                            "Você fez muitos pedidos em pouco tempo. Por favor, aguarde um minuto antes de tentar gerar um novo treino.", 
                            "error"
                        );
                    } else {
                        showNotification(
                            "Erro de IA", 
                            error.message || "A IA não conseguiu gerar o treino. Verifique se a sua Chave de API é válida.", 
                            "error"
                        );
                    }
                } finally {
                    toggleSpinner(false);
                    btnGerarComIA.disabled = false;
                    btnGerarComIA.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            function preencherFormularioComIA(treinoData, isTemplate = false) {
                if (!isTemplate) {
                     appState.tecnicas = treinoData.tecnicas_utilizadas || [];
                    appState.dicas = treinoData.dicas_extras || [];
                    document.getElementById('observacoes_gerais').value = treinoData.observacoes_gerais || '';
                } else {
                    appState.tecnicas = treinoData.tecnicas || [];
                    appState.dicas = treinoData.dicas || [];
                    document.getElementById('observacoes_gerais').value = treinoData.observacoes || '';
                }
                
                diasDeTreinoContainer.innerHTML = '';
                const plano = isTemplate ? treinoData.dias : treinoData.plano_semanal;

                if (plano) {
                    plano.forEach((dia) => {
                        const nomeDia = isTemplate ? dia.nome : dia.nome_dia;
                        const musculos = isTemplate ? dia.musculos : dia.grupos_musculares;
                        const diaDiv = addDiaDeTreino(nomeDia, musculos, dia.aquecimento, dia.cardio, dia.arrefecimento);
                        const exerciciosContainer = diaDiv.querySelector('.exercicios-container');
                        if (dia.exercicios) {
                            dia.exercicios.forEach(ex => addExercicio(exerciciosContainer, ex));
                        }
                    });
                }
            }

            document.getElementById('btnAddDia').addEventListener('click', () => addDiaDeTreino());
            let diaCount = 0;
            function addDiaDeTreino(nome = '', musculos = '', aquecimento = '', cardio = '', arrefecimento = '') {
                diaCount++;
                const diaDiv = document.createElement('div');
                diaDiv.className = 'bg-background-dark border border-border-light p-6 rounded-xl space-y-4';
                diaDiv.id = `dia-${diaCount}`;
                diaDiv.innerHTML = `
                    <div class="flex justify-between items-center gap-4">
                        <input type="text" placeholder="Nome do Treino (Ex: Treino A)" value="${nome}" class="dia-nome w-full p-3 bg-bg-container border-border-light border rounded-lg text-lg font-semibold" required>
                        <button type="button" class="btn-remover-dia text-red-500 p-2 rounded-full hover:bg-red-500/20">✖</button>
                    </div>
                    <div>
                        <input type="text" placeholder="Grupos Musculares (Ex: Peito, Ombro, Tríceps)" value="${musculos}" class="dia-musculos w-full p-3 bg-bg-container border-border-light border rounded-lg text-md" required>
                    </div>
                    <!-- NOVOS CAMPOS AQUECIMENTO/CARDIO/ARREFECIMENTO -->
                    <div><textarea placeholder="Aquecimento (opcional)..." class="dia-aquecimento w-full p-2 bg-bg-container border-border-light border rounded text-sm">${aquecimento}</textarea></div>
                    <div class="exercicios-container space-y-4"></div>
                    <button type="button" class="btn-add-exercicio w-full py-2 text-md bg-btn-secondary text-white rounded-lg font-semibold mt-2">+ Adicionar Exercício Manualmente</button>
                    <div><textarea placeholder="Cardio (opcional)..." class="dia-cardio w-full p-2 bg-bg-container border-border-light border rounded text-sm">${cardio}</textarea></div>
                    <div><textarea placeholder="Arrefecimento (opcional)..." class="dia-arrefecimento w-full p-2 bg-bg-container border-border-light border rounded text-sm">${arrefecimento}</textarea></div>
                `;
                diasDeTreinoContainer.appendChild(diaDiv);
                return diaDiv;
            }

            function addExercicio(container, ex = { nome: '', series: '', reps: '', descanso: '', obs: '', videoUrl: '' }) {
                const exercicioDiv = document.createElement('div');
                exercicioDiv.className = 'exercicio-item border-t border-border-light pt-4';
                exercicioDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center gap-2">
                        <input type="text" placeholder="Exercício" value="${ex.nome || ''}" class="ex-nome flex-grow w-full p-2 bg-bg-container border-border-light border rounded">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <input type="text" placeholder="Séries" value="${ex.series || ''}" class="ex-series w-full p-2 bg-bg-container border-border-light border rounded">
                            <span class="text-text-muted">x</span>
                            <input type="text" placeholder="Reps" value="${ex.reps || ''}" class="ex-reps w-full p-2 bg-bg-container border-border-light border rounded">
                            <input type="text" placeholder="Descanso" value="${ex.descanso || ''}" class="ex-descanso w-full p-2 bg-bg-container border-border-light border rounded">
                        </div>
                        <button type="button" class="btn-remover-exercicio text-red-400 p-1 rounded-full hover:bg-red-500/20">➖</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                        <input type="text" placeholder="Obs. (ex: Drop set)" value="${ex.obs || ''}" class="ex-obs w-full p-2 bg-bg-container border-border-light border rounded text-sm">
                        <div class="flex items-center gap-2">
                            <input type="url" placeholder="Link do YouTube (verificar)" value="${ex.videoUrl || ''}" class="ex-video-url w-full p-2 bg-bg-container border-border-light border rounded text-sm">
                            <button type="button" class="btn-testar-video text-primary-blue hover:text-opacity-80 p-1 rounded-full" title="Testar Link do Vídeo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>`;
                container.appendChild(exercicioDiv);
            }
            
            diasDeTreinoContainer.addEventListener('click', e => {
                if (e.target.classList.contains('btn-add-exercicio')) addExercicio(e.target.previousElementSibling);
                if (e.target.classList.contains('btn-remover-dia')) e.target.closest('.bg-background-dark').remove();
                if (e.target.classList.contains('btn-remover-exercicio')) e.target.closest('.exercicio-item').remove();
                
                const testButton = e.target.closest('.btn-testar-video');
                if (testButton) {
                    const urlInput = testButton.previousElementSibling;
                    const url = urlInput.value.trim();
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        showNotification("Atenção", "Insira um URL para testar.", "error");
                    }
                }
            });

            document.getElementById('btnGerarPreview').addEventListener('click', () => {
                const dias = diasDeTreinoContainer.querySelectorAll('.bg-background-dark');
                if (dias.length === 0) return showNotification("Atenção", "Adicione pelo menos um dia de treino.", "error");

                appState.treinoSemanal = [];
                let formValido = true;
                let totalExercicios = 0;

                dias.forEach(diaEl => {
                    const nomeDia = diaEl.querySelector('.dia-nome').value;
                    const musculosDia = diaEl.querySelector('.dia-musculos').value;
                    if (!nomeDia || !musculosDia) formValido = false;
                    const exercicios = [];
                    diaEl.querySelectorAll('.exercicio-item').forEach(exEl => {
                        const nomeEx = exEl.querySelector('.ex-nome').value;
                        if (!nomeEx) formValido = false;
                        exercicios.push({
                            nome: nomeEx,
                            series: exEl.querySelector('.ex-series').value,
                            reps: exEl.querySelector('.ex-reps').value,
                            descanso: exEl.querySelector('.ex-descanso').value,
                            obs: exEl.querySelector('.ex-obs').value,
                            videoUrl: exEl.querySelector('.ex-video-url').value
                        });
                        totalExercicios++;
                    });
                    appState.treinoSemanal.push({ 
                        nome: nomeDia, 
                        musculos: musculosDia, 
                        // NOVO: Coleta dos novos campos
                        aquecimento: diaEl.querySelector('.dia-aquecimento').value,
                        exercicios,
                        cardio: diaEl.querySelector('.dia-cardio').value,
                        arrefecimento: diaEl.querySelector('.dia-arrefecimento').value,
                    });
                });
                if (!formValido) return showNotification("Formulário Inválido", "Preencha o nome e os grupos musculares de todos os dias, e o nome de todos os exercícios.", "error");

                if (totalExercicios === 0) {
                    return showNotification("Atenção", "O treino não contém exercícios. Adicione exercícios manualmente ou gere um novo treino com a IA.", "error");
                }

                renderizarPreview();
                mostrarTela('treinoPreview');
            });

            function renderizarPreview() {
                const container = document.getElementById('treinosPreviewContainer');
                const analiseContainer = document.getElementById('analiseNutricionalPreview');
                container.innerHTML = '';
                analiseContainer.innerHTML = '';

                const { imc, tmb, caloriasRecomendadas } = appState.analiseNutricional || {};
                analiseContainer.innerHTML = `
                    <h3 class="text-lg font-semibold text-primary-blue mb-2">Análise Rápida</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <p><strong class="text-text-light">IMC:</strong> ${imc || 'N/D'}</p>
                        <p><strong class="text-text-light">TMB:</strong> ${tmb || 'N/D'}</p>
                        <p><strong class="text-text-light">Calorias (Obj.):</strong> ${caloriasRecomendadas || 'N/D'}</p>
                    </div>
                `;
                
                const observacoes = document.getElementById('observacoes_gerais').value;
                if (observacoes) {
                    container.innerHTML += `<div class="mb-4"><h4 class="font-bold text-primary-blue">Observações Gerais:</h4><p class="text-text-muted whitespace-pre-wrap">${observacoes}</p></div>`;
                }

                appState.treinoSemanal.forEach(dia => {
                    let diaHTML = `<div class="mb-4">
                        <h3 class="text-xl font-semibold text-text-light border-b-2 border-primary-blue pb-1 mb-2">${dia.nome} <span class="text-base font-normal text-text-muted">- ${dia.musculos}</span></h3>`;

                    // NOVO: Renderizar Aquecimento, Cardio, Arrefecimento
                    if(dia.aquecimento) diaHTML += `<div class="mb-3"><h4 class="font-semibold text-primary-blue text-sm">Aquecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.aquecimento}</p></div>`;

                    if (dia.exercicios && dia.exercicios.length > 0) {
                         let exerciciosHTML = dia.exercicios.map(ex => {
                             const videoIconHTML = ex.videoUrl ? `<span class="ml-2 inline-block">${youtubeIcon}</span>` : '';
                             return `<li class="flex justify-between items-center text-text-muted border-b border-border-light py-2 gap-2">
                                         <span class="flex-1 flex items-center">${ex.nome}${videoIconHTML}</span>
                                         <span class="text-right whitespace-nowrap">${ex.series || '-' }x${ex.reps || '-'} | ${ex.descanso || '-'} | ${ex.obs || '-'}</span>
                                     </li>`;
                         }).join('');
                         diaHTML += `<ul class="space-y-1">${exerciciosHTML}</ul>`;
                    }
                   
                    if(dia.cardio) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Cardio:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.cardio}</p></div>`;
                    if(dia.arrefecimento) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Arrefecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.arrefecimento}</p></div>`;

                    diaHTML += '</div>';
                    container.innerHTML += diaHTML;
                });

                if (appState.tecnicas && appState.tecnicas.length > 0) {
                    let tecnicasHTML = appState.tecnicas.map(t => `<li><strong class="text-text-light">${t.nome}:</strong> ${t.descricao}</li>`).join('');
                    container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Técnicas Utilizadas</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${tecnicasHTML}</ul></div>`;
                }
                if (appState.dicas && appState.dicas.length > 0) {
                    let dicasHTML = appState.dicas.map(d => `<li>${d}</li>`).join('');
                    container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Dicas Extra</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${dicasHTML}</ul></div>`;
                }
            }

            document.getElementById('btnSalvarTreino').addEventListener('click', async () => {
                const nomeTreino = document.getElementById('treinoNomeSalvo').value;
                if (!nomeTreino) return showNotification("Atenção", "Dê um nome ao treino para o guardar.", "error");
                if (!appState.currentUser || !appState.alunoSelecionado) return;
                
                const treinoData = { 
                    nome: nomeTreino, 
                    observacoes: document.getElementById('observacoes_gerais').value, 
                    dias: appState.treinoSemanal, 
                    tecnicas: appState.tecnicas,
                    dicas: appState.dicas,
                    analiseNutricional: appState.analiseNutricional,
                    criadoEm: serverTimestamp()
                };

                if (appState.treinoAbertoId) {
                    const choice = await showSaveOptionsModal();
                    if (choice === 'update') {
                        toggleSpinner(true, "A atualizar treino...");
                        try {
                            const treinoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", appState.treinoAbertoId);
                            await updateDoc(treinoDocRef, treinoData);
                            showNotification("Sucesso!", "Treino atualizado com sucesso!");
                            mostrarTela('telaGerenciarAluno');
                        } catch (error) {
                            showNotification("Erro", "Erro ao atualizar o treino.", "error");
                            console.error(error);
                        } finally {
                            toggleSpinner(false);
                        }
                    } else if (choice === 'save_new') {
                        toggleSpinner(true, "A guardar como novo...");
                        try {
                            const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                            await addDoc(treinosRef, treinoData);
                            showNotification("Sucesso!", "Novo treino guardado com sucesso!");
                            mostrarTela('telaGerenciarAluno');
                        } catch (error) {
                            showNotification("Erro", "Erro ao guardar o novo treino.", "error");
                            console.error(error);
                        } finally {
                            toggleSpinner(false);
                        }
                    }
                } else {
                    toggleSpinner(true, "A guardar na nuvem...");
                    try {
                        const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                        await addDoc(treinosRef, treinoData);
                        showNotification("Sucesso!", "Treino guardado com sucesso!");
                        mostrarTela('telaGerenciarAluno');
                    } catch (error) { 
                        showNotification("Erro", "Erro ao guardar o treino.", "error");
                        console.error(error);
                    } 
                    finally { toggleSpinner(false); }
                }
            });

            async function carregarTreinosSalvos() {
                const container = document.getElementById('listaTreinosSalvos');
                container.innerHTML = `<p class="text-text-muted text-center py-8">A carregar...</p>`;
                try {
                    const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                    const querySnapshot = await getDocs(treinosRef);

                    if (querySnapshot.empty) {
                        container.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum treino guardado para este aluno.</p>`;
                        return;
                    }
                    container.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const treino = doc.data();
                        const data = treino.criadoEm ? new Date(treino.criadoEm.seconds * 1000).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', '') : 'sem data';
                        
                        const gruposMusculares = treino.dias && treino.dias.length > 0
                            ? [...new Set(treino.dias.map(dia => dia.musculos.split(/, | e /)[0].trim()))].slice(0, 3).join(', ') + (treino.dias.length > 3 ? '...' : '')
                            : 'Geral';

                        container.innerHTML += `
                            <div class="bg-bg-container p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-3">
                                <div class="w-full">
                                    <h4 class="font-semibold text-text-light">${treino.nome}</h4>
                                    <p class="text-sm text-text-muted">Guardado em: ${data}</p>
                                    <p class="text-sm text-primary-blue font-semibold mt-1">Foco: ${gruposMusculares}</p>
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <button data-treinoid="${doc.id}" class="btn-compartilhar-treino flex-1 py-2 px-3 text-sm bg-btn-success text-white rounded-lg font-semibold">Partilhar</button>
                                    <button data-treinoid="${doc.id}" class="btn-visualizar-treino flex-1 py-2 px-3 text-sm bg-primary-blue text-white rounded-lg font-semibold">Ver</button>
                                    <button data-treinoid="${doc.id}" class="btn-deletar-treino py-2 px-3 text-sm bg-btn-danger text-white rounded-lg font-semibold">X</button>
                                </div>
                            </div>`;
                    });
                } catch (error) { 
                    container.innerHTML = `<p class="text-red-500 text-center py-8">Erro ao carregar treinos.</p>`;
                    console.error(error);
                }
            }

            document.getElementById('listaTreinosSalvos').addEventListener('click', async e => {
                const treinoId = e.target.dataset.treinoid;
                if (!treinoId) return;

                const isDelete = e.target.classList.contains('btn-deletar-treino');
                const isView = e.target.classList.contains('btn-visualizar-treino');
                const isShare = e.target.classList.contains('btn-compartilhar-treino');

                if (isDelete) {
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir este treino?");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir...");
                    try {
                        await deleteDoc(doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId));
                        showNotification("Sucesso!", "Treino excluído.");
                        carregarTreinosSalvos();
                    } catch (error) { showNotification("Erro", "Erro ao excluir.", "error"); }
                    finally { toggleSpinner(false); }
                }

                if (isView) {
                    toggleSpinner(true, "A carregar treino...");
                    try {
                        const docSnap = await getDoc(doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId));
                        if (docSnap.exists()) {
                            appState.treinoAbertoId = treinoId;
                            const treino = docSnap.data();
                            appState.treinoSemanal = treino.dias;
                            appState.tecnicas = treino.tecnicas || [];
                            appState.dicas = treino.dicas || [];
                            appState.analiseNutricional = treino.analiseNutricional || {};
                            document.getElementById('observacoes_gerais').value = treino.observacoes || '';
                            document.getElementById('treinoNomeSalvo').value = treino.nome;
                            renderizarPreview();
                            mostrarTela('treinoPreview');
                        }
                    } catch (error) { 
                        showNotification("Erro", "Erro ao carregar detalhes.", "error");
                        console.error(error);
                    }
                    finally { toggleSpinner(false); }
                }

                if (isShare) {
                    handleShareTraining(treinoId);
                }
            });

            async function handleShareTraining(treinoId) {
                toggleSpinner(true, "A gerar link...");
                try {
                    const treinoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId);
                    const docSnap = await getDoc(treinoDocRef);
                    if (!docSnap.exists()) throw new Error("Treino não encontrado.");

                    const treinoData = docSnap.data();
                    let publicId = treinoData.publicId;

                    if (!publicId) {
                        publicId = generateUUID();
                        const publicTrainingData = {
                            ...treinoData,
                            alunoNome: appState.alunoSelecionado.nome,
                            trainerName: appState.currentUser.displayName,
                            trainerId: appState.currentUser.uid,
                            alunoId: appState.alunoSelecionado.id
                        };
                        
                        const publicDocRef = doc(db, "publicTrainings", publicId);
                        await setDoc(publicDocRef, publicTrainingData);
                        await updateDoc(treinoDocRef, { publicId: publicId });
                    }
                    
                    const url = `${window.location.origin}${window.location.pathname}?publicId=${publicId}`;
                    shareableLinkInput.value = url;
                    shareLinkModal.classList.remove('hide');

                } catch (error) {
                    showNotification("Erro ao Partilhar", "Erro ao partilhar treino. Verifique as regras de segurança do Firestore.", "error");
                    console.error(error);
                } finally {
                    toggleSpinner(false);
                }
            }
            
            closeShareLinkModal.addEventListener('click', () => shareLinkModal.classList.add('hide'));
            btnCopyLink.addEventListener('click', () => {
                shareableLinkInput.select();
                document.execCommand('copy');
                showNotification("Copiado!", "Link copiado para a área de transferência!");
            });

            document.getElementById('btnGerarPDF').addEventListener('click', gerarPDF);
            
            function gerarPDF() {
                // Função de gerar PDF existente, atualizada para incluir os novos campos
                 if (appState.treinoSemanal.length === 0) return showNotification("Atenção", "Não há treino para gerar PDF.", "error");
                
                toggleSpinner(true, "A gerar PDF profissional...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const MARGIN = 15, DOC_WIDTH = doc.internal.pageSize.getWidth(), DOC_HEIGHT = doc.internal.pageSize.getHeight();
                const PRIMARY_COLOR = '#58a6ff', TEXT_COLOR = '#333333', LIGHT_TEXT_COLOR = '#777777';
                let yPosition = 0;

                const { nome, altura, idade, objetivo, pesoInicial, sexo } = appState.alunoSelecionado;
                const temAvaliacoes = appState.avaliacoesCache && appState.avaliacoesCache.length > 0;
                const ultimoPeso = temAvaliacoes ? appState.avaliacoesCache[appState.avaliacoesCache.length - 1].peso : pesoInicial;
                
                const analise = {
                    imc: calcularIMC(ultimoPeso, altura), tmb: calcularTMB(ultimoPeso, altura, idade, sexo),
                    caloriasRecomendadas: calcularCaloriasRecomendadas(calcularTMB(ultimoPeso, altura, idade, sexo), objetivo),
                    pesoIdeal: `~${(22 * (altura/100) * (altura/100)).toFixed(1)} kg`
                };

                const addHeader = () => { /* ... (código existente) ... */ };
                const addFooter = (page, total) => { /* ... (código existente) ... */ };
                
                // ... (código de montagem do cabeçalho do PDF existente) ...
                
                // Atualização na renderização dos dias de treino
                appState.treinoSemanal.forEach(dia => {
                    // ... (código de verificação de página e cabeçalho do dia) ...
                    
                    const addSimpleSection = (title, content) => {
                        if(content) {
                            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(TEXT_COLOR);
                            doc.text(title, MARGIN + 1, yPosition); yPosition += 5;
                            doc.setFont('helvetica', 'normal'); doc.setTextColor(LIGHT_TEXT_COLOR);
                            const splitText = doc.splitTextToSize(content, DOC_WIDTH - (MARGIN * 2) - 2);
                            doc.text(splitText, MARGIN + 1, yPosition);
                            yPosition += (splitText.length * 4) + 5;
                        }
                    };
                    
                    addSimpleSection("Aquecimento:", dia.aquecimento);

                    const head = [['Exercício', 'Séries x Reps', 'Descanso', 'Obs.']];
                    const body = dia.exercicios.map(ex => [ /* ... (código existente) ... */ ]);
                    doc.autoTable({ /* ... (configuração existente) ... */ });
                    yPosition = doc.autoTable.previous.finalY + 8;

                    addSimpleSection("Cardio:", dia.cardio);
                    addSimpleSection("Arrefecimento:", dia.arrefecimento);
                    yPosition += 7;
                });
                
                // ... (restante do código de geração de PDF, incluindo dicas e técnicas) ...
                doc.save(`plano_${nome.replace(/\s/g, '_')}.pdf`);
                toggleSpinner(false);
            }

            // --- NOVO: LÓGICA DE TEMPLATES ---
            btnLoadTemplate.addEventListener('click', async () => {
                if (!appState.currentUser) return;
                toggleSpinner(true, "A carregar modelos...");
                templateListContainer.innerHTML = '<p class="text-text-muted">A carregar...</p>';
                loadTemplateModal.classList.remove('hide');

                try {
                    const templatesRef = collection(db, "usuarios", appState.currentUser.uid, "workoutTemplates");
                    const querySnapshot = await getDocs(templatesRef);
                    if (querySnapshot.empty) {
                        templateListContainer.innerHTML = '<p class="text-text-muted">Nenhum modelo guardado ainda.</p>';
                        return;
                    }
                    templateListContainer.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const template = doc.data();
                        const templateDiv = document.createElement('div');
                        templateDiv.className = 'bg-background-dark border border-border-light p-4 rounded-lg flex justify-between items-center';
                        templateDiv.innerHTML = `
                            <div>
                                <h4 class="font-semibold text-text-light">${template.nome}</h4>
                                <p class="text-sm text-text-muted">${template.dias.length} dias de treino</p>
                            </div>
                            <button data-templateid="${doc.id}" class="btn-load-template-confirm py-2 px-4 bg-primary-blue text-white rounded-lg font-semibold">Carregar</button>
                        `;
                        templateListContainer.appendChild(templateDiv);
                    });
                } catch (error) {
                    console.error("Erro ao carregar modelos:", error);
                    templateListContainer.innerHTML = '<p class="text-red-500">Erro ao carregar modelos.</p>';
                } finally {
                    toggleSpinner(false);
                }
            });

            closeLoadTemplateModal.addEventListener('click', () => loadTemplateModal.classList.add('hide'));

            templateListContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-load-template-confirm')) {
                    const templateId = e.target.dataset.templateid;
                    toggleSpinner(true, "A carregar modelo...");
                    try {
                        const templateDocRef = doc(db, "usuarios", appState.currentUser.uid, "workoutTemplates", templateId);
                        const docSnap = await getDoc(templateDocRef);
                        if (docSnap.exists()) {
                            const templateData = docSnap.data();
                            btnNovoTreino.click(); // Simula clique para resetar o form
                            setTimeout(() => { // Garante que o reset foi concluído
                                preencherFormularioComIA(templateData, true);
                                loadTemplateModal.classList.add('hide');
                                showNotification("Sucesso!", `Modelo "${templateData.nome}" carregado.`);
                            }, 100);
                        }
                    } catch (error) {
                        showNotification("Erro", "Não foi possível carregar o modelo.", "error");
                    } finally {
                        toggleSpinner(false);
                    }
                }
            });

            btnSalvarComoModelo.addEventListener('click', async () => {
                const nomeTreino = document.getElementById('treinoNomeSalvo').value;
                if (!nomeTreino) return showNotification("Atenção", "Dê um nome ao modelo para o guardar.", "error");
                if (!appState.currentUser) return;

                const templateData = {
                    nome: nomeTreino,
                    observacoes: document.getElementById('observacoes_gerais').value,
                    dias: appState.treinoSemanal,
                    tecnicas: appState.tecnicas,
                    dicas: appState.dicas,
                    criadoEm: serverTimestamp()
                };

                toggleSpinner(true, "A guardar modelo...");
                try {
                    const templatesRef = collection(db, "usuarios", appState.currentUser.uid, "workoutTemplates");
                    await addDoc(templatesRef, templateData);
                    showNotification("Sucesso!", `Modelo "${nomeTreino}" guardado com sucesso!`);
                } catch (error) {
                    console.error("Erro ao guardar modelo: ", error);
                    showNotification("Erro", "Não foi possível guardar o modelo.", "error");
                } finally {
                    toggleSpinner(false);
                }
            });


            // --- FUNÇÕES GERAIS ---
            function mostrarTela(idTela) {
                document.querySelectorAll('#telaAlunos, #telaGerenciarAluno, #telaCarregar, #treinoForm, #treinoPreview, #telaAcompanhamento, #telaBoasVindas').forEach(el => el.classList.add('hide'));
                const tela = document.getElementById(idTela);
                if (tela) tela.classList.remove('hide');
            }
            
            function showConfirmationModal(title, message) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmationModal');
                    document.getElementById('confirmationTitle').textContent = title;
                    document.getElementById('confirmationMessage').textContent = message;
                    modal.classList.remove('hide');

                    const btnConfirm = document.getElementById('btnConfirm');
                    const btnCancel = document.getElementById('btnCancel');

                    const confirmHandler = () => { cleanup(); resolve(true); };
                    const cancelHandler = () => { cleanup(); resolve(false); };
                    
                    const cleanup = () => {
                        modal.classList.add('hide');
                        btnConfirm.removeEventListener('click', confirmHandler);
                        btnCancel.removeEventListener('click', cancelHandler);
                    }

                    btnConfirm.addEventListener('click', confirmHandler);
                    btnCancel.addEventListener('click', cancelHandler);
                });
            }

            function showSaveOptionsModal() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('saveOptionsModal');
                    modal.classList.remove('hide');

                    const btnUpdate = document.getElementById('btnUpdateWorkout');
                    const btnSaveNew = document.getElementById('btnSaveAsNewWorkout');
                    const btnCancel = document.getElementById('btnCancelSave');

                    const updateHandler = () => { cleanup(); resolve('update'); };
                    const saveNewHandler = () => { cleanup(); resolve('save_new'); };
                    const cancelHandler = () => { cleanup(); resolve('cancel'); };
                    
                    const cleanup = () => {
                        modal.classList.add('hide');
                        btnUpdate.removeEventListener('click', updateHandler);
                        btnSaveNew.removeEventListener('click', saveNewHandler);
                        btnCancel.removeEventListener('click', cancelHandler);
                    }

                    btnUpdate.addEventListener('click', updateHandler);
                    btnSaveNew.addEventListener('click', saveNewHandler);
                    btnCancel.addEventListener('click', cancelHandler);
                });
            }

            function generateUUID() {
                if (crypto && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // --- INICIALIZAÇÃO ---
            atualizarDivisoes();
            tecnicasContainer.classList.add('hide');
        }
    </script>
</body>
</html>

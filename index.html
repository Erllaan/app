<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Trainer Partner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'], },
                    colors: {
                        'background-dark': '#0d1117', 'primary-blue': '#58a6ff',
                        'bg-container': '#161b22', 'border-light': '#30363d',
                        'text-light': '#c9d1d9', 'text-muted': '#8b949e',
                        'btn-primary': '#38c172', 'btn-hover-primary': '#2b9e59',
                        'btn-danger': '#ef4444', 'btn-delete-hover': '#dc2626',
                        'btn-secondary': '#6b7280', 'btn-secondary-hover': '#4b5563',
                        'btn-success': '#16a34a', 'btn-success-hover': '#15803d'
                    }
                }
            }
        }
    </script>
    <!-- LIBS PARA GERAR PDF E GRÁFICOS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0d1117; background-image: linear-gradient(135deg, #0d1117 0%, #171d2b 100%); }
        .container { max-width: 900px; }
        input, select, textarea { transition: border-color: 0.3s, box-shadow: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #58a6ff; outline: none; box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3); }
        .hide { display: none !important; }
        .modal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #58a6ff; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-background-dark text-text-light font-sans flex justify-center items-start min-h-screen p-4 md:p-8 text-lg">

    <!-- Notificações e Spinner de Carregamento -->
    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 opacity-0 invisible transition-all duration-300 -translate-y-10 w-full max-w-sm shadow-lg">
        <div class="flex items-start">
            <div id="notification-icon" class="flex-shrink-0 mr-3 mt-1"></div>
            <div>
                <p id="notification-title" class="font-bold"></p>
                <p id="notification-message" class="text-sm"></p>
            </div>
        </div>
    </div>
    <div id="loadingSpinner" class="spinner-overlay hide">
        <div class="spinner"></div>
        <p id="spinner-message" class="text-lg font-semibold text-white">Aguarde...</p>
    </div>

    <!-- Tela de Visualização Pública para Alunos -->
    <div id="publicView" class="hide container bg-bg-container p-6 md:p-10 rounded-xl shadow-xl border border-border-light my-5 md:my-10 w-full">
        <div id="publicContent">
             <h1 class="text-center text-primary-blue text-3xl md:text-4xl font-bold mb-2 pb-4 border-b border-border-light drop-shadow-md">Plano de Treino</h1>
             <div id="publicHeader" class="text-center mb-6">
                 <h2 id="publicAlunoNome" class="text-2xl font-semibold text-text-light"></h2>
                 <p id="publicTrainerInfo" class="text-sm text-text-muted"></p>
             </div>
             <div id="publicTreinoContainer" class="space-y-6"></div>
        </div>
        <div id="publicError" class="hide text-center py-10">
            <h2 class="text-2xl font-bold text-red-500">Treino Não Encontrado</h2>
            <p class="text-text-muted mt-2">O link pode estar incorreto ou o treino pode ter sido removido.</p>
        </div>
    </div>

    <div id="mainApp" class="container bg-bg-container p-6 md:p-10 rounded-xl shadow-xl border border-border-light my-5 md:my-10 w-full">
        <h1 class="text-center text-primary-blue text-3xl md:text-4xl font-bold mb-6 pb-4 border-b border-border-light drop-shadow-md">Your Trainer Partner</h1>

        <!-- Tela de Login -->
        <div id="telaLogin">
            <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4">Aceder à Plataforma</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block mb-2 text-text-muted">Email:</label>
                    <input type="email" id="emailInput" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="passwordInput" class="block mb-2 text-text-muted">Palavra-passe:</label>
                    <div class="relative">
                        <input type="password" id="passwordInput" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                        <button type="button" id="btnTogglePassword" class="absolute inset-y-0 right-0 px-4 text-text-muted hover:text-text-light"></button>
                    </div>
                </div>
                <div class="text-right"><a href="#" id="btnForgotPassword" class="text-sm text-primary-blue hover:underline">Esqueceu a sua palavra-passe?</a></div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="submit" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold">Entrar</button>
                </div>
                <div class="text-center mt-4">
                    <p class="text-text-muted">Não tem uma conta? <a href="#" id="linkGoToSignup" class="font-semibold text-primary-blue hover:underline">Registe-se</a></p>
                </div>
            </form>
        </div>
        
        <!-- Tela de Cadastro -->
        <div id="telaCadastro" class="hide">
            <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4">Criar Nova Conta</h2>
            <form id="signupForm" class="space-y-4">
                <div>
                    <label for="signupName" class="block mb-2 text-text-muted">Nome Completo:</label>
                    <input type="text" id="signupName" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupDisplayName" class="block mb-2 text-text-muted">Como quer ser chamado(a) (Ex: Prof. João):</label>
                    <input type="text" id="signupDisplayName" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupAge" class="block mb-2 text-text-muted">Idade:</label>
                    <input type="number" id="signupAge" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupEmail" class="block mb-2 text-text-muted">Email:</label>
                    <input type="email" id="signupEmail" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div>
                    <label for="signupPassword" class="block mb-2 text-text-muted">Palavra-passe (mínimo 6 caracteres):</label>
                    <input type="password" id="signupPassword" class="w-full p-4 rounded-lg border border-border-light bg-background-dark text-text-light text-lg" required>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button type="submit" class="w-full py-3 text-lg bg-btn-primary text-white rounded-lg font-semibold">Finalizar Registo</button>
                </div>
                <div class="text-center mt-4">
                    <p class="text-text-muted">Já tem uma conta? <a href="#" id="linkGoToLogin" class="font-semibold text-primary-blue hover:underline">Faça login</a></p>
                </div>
            </form>
        </div>

        <!-- Conteúdo Principal da Aplicação -->
        <div id="appContent" class="hide">
            <div class="text-right mb-4 flex justify-end items-center gap-2">
                <span id="userInfo" class="text-text-muted text-sm mr-2"></span>
                <button id="btnShowSettings" class="p-2 text-sm bg-btn-secondary text-white rounded-lg font-semibold" title="Configurações">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button id="btnEditProfile" class="py-2 px-4 text-sm bg-btn-secondary text-white rounded-lg font-semibold">Editar Perfil</button>
                <button id="btnLogout" class="py-2 px-4 text-sm bg-btn-danger text-white rounded-lg font-semibold">Sair</button>
            </div>

            <!-- Tela de Boas-Vindas -->
            <div id="telaBoasVindas" class="hide">
                <div class="text-center p-4">
                    <h2 id="mensagemBoasVindas" class="text-3xl md:text-4xl font-bold text-primary-blue mb-4"></h2>
                    <p class="text-text-muted text-lg mb-8">Pronto para transformar resultados? O que deseja fazer hoje?</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="btnIrParaAlunos" class="py-3 px-6 text-lg bg-primary-blue text-white rounded-lg font-semibold">Ver Meus Alunos</button>
                        <button id="btnIrParaBiblioteca" class="py-3 px-6 text-lg bg-btn-secondary text-white rounded-lg font-semibold">Biblioteca de Exercícios</button>
                    </div>
                </div>
            </div>

            <!-- Tela de Alunos -->
            <div id="telaAlunos" class="hide">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                     <h2 class="text-2xl font-semibold text-primary-blue">Meus Alunos</h2>
                     <button id="btnShowAddAlunoModal" class="py-2 px-4 bg-btn-primary text-white rounded-lg font-semibold w-full sm:w-auto">+ Adicionar Aluno</button>
                 </div>
                 <div class="mb-6 flex flex-col sm:flex-row gap-4">
                     <input type="search" id="alunoSearchInput" placeholder="Pesquisar por nome..." class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light flex-grow">
                     <select id="alunoObjectiveFilter" class="w-full sm:w-1/3 p-3 rounded-lg border border-border-light bg-background-dark text-text-light">
                         <option value="">Filtrar por objetivo</option>
                     </select>
                 </div>
                 <div id="listaAlunos" class="space-y-3"></div>
            </div>

            <!-- Tela Biblioteca de Exercícios -->
            <div id="telaBiblioteca" class="hide">
                <button id="btnVoltarParaBoasVindas_Bib" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar</button>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold text-primary-blue">Biblioteca de Exercícios</h2>
                    <button id="btnPopularBiblioteca" class="py-2 px-4 bg-btn-primary text-white rounded-lg font-semibold w-full sm:w-auto">Popular com Lista Padrão</button>
                </div>
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <input type="search" id="exercicioSearchInput" placeholder="Pesquisar por exercício..." class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light flex-grow">
                    <select id="exercicioGroupFilter" class="w-full sm:w-1/3 p-3 rounded-lg border border-border-light bg-background-dark text-text-light">
                        <option value="">Filtrar por grupo muscular</option>
                    </select>
                </div>
                <div id="listaExerciciosBiblioteca" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>

            <!-- Tela Gerenciar Aluno -->
            <div id="telaGerenciarAluno" class="hide">
                <button id="btnVoltarParaAlunos" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Alunos</button>
                <h2 id="nomeAlunoGerenciado" class="text-2xl font-semibold text-primary-blue mb-6"></h2>
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl w-full">
                    <h3 class="text-xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">O que deseja fazer?</h3>
                    <div class="flex flex-col gap-4">
                        <button id="btnAcompanharEvolucao" class="w-full py-4 text-xl bg-btn-success text-white rounded-lg font-semibold">Acompanhar Evolução</button>
                        <button id="btnNovoTreino" class="w-full py-4 text-xl bg-primary-blue text-white rounded-lg font-semibold">Criar Novo Treino</button>
                        <button id="btnLoadTemplate" class="w-full py-4 text-xl bg-blue-800 text-white rounded-lg font-semibold">Criar Treino a Partir de Modelo</button>
                        <button id="btnCarregarTreino" class="w-full py-4 text-xl bg-btn-secondary text-white rounded-lg font-semibold">Ver Treinos Guardados</button>
                    </div>
                </div>
            </div>

            <!-- Tela de Acompanhamento de Evolução -->
            <div id="telaAcompanhamento" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Acomp" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Aluno</button>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 id="tituloAcompanhamento" class="text-2xl font-semibold text-primary-blue"></h2>
                    <button id="btnShowAddAvaliacaoModal" class="py-2 px-4 bg-btn-primary text-white rounded-lg font-semibold w-full sm:w-auto">+ Nova Avaliação</button>
                </div>
                <div id="listaAvaliacoes" class="space-y-4"></div>
            </div>

            <!-- Tela de Carregar Treinos Salvos -->
            <div id="telaCarregar" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Carregar" class="py-2 px-4 mb-6 bg-btn-secondary text-white rounded-lg font-semibold">← Voltar para Aluno</button>
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl">
                    <h3 id="tituloTelaCarregar" class="text-xl md:text-2xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">Gerir Treinos Guardados</h3>
                    <div id="listaTreinosSalvos" class="space-y-3"></div>
                </div>
            </div>
            
            <!-- Formulário de Criação de Treino -->
            <form id="treinoForm" class="hide">
                <button id="btnVoltarParaGerenciarAluno_Form" type="button" class="py-2 px-4 text-lg bg-btn-secondary text-white rounded-lg font-semibold mb-6">← Voltar</button>
                
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl mb-6 space-y-4">
                    <h2 class="text-xl md:text-2xl font-semibold text-primary-blue pb-2 border-b border-border-light">1. Defina os Parâmetros</h2>
                    <input type="text" id="nome_aluno_form" class="w-full p-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg" disabled>
                    
                    <div>
                        <label for="observacoes_ia" class="block mb-2 text-text-muted">Observações para a IA (lesões, preferências, etc.):</label>
                        <textarea id="observacoes_ia" placeholder="Ex: Evitar exercícios de alto impacto no joelho. Foco em ombros." class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light text-md"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="dificuldade" class="block mb-2 text-text-muted">Nível:</label>
                            <select id="dificuldade" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="Iniciante">Iniciante</option>
                                <option value="Intermediario">Intermediário</option>
                                <option value="Avancado">Avançado</option>
                            </select>
                        </div>
                        <div>
                            <label for="objetivo" class="block mb-2 text-text-muted">Objetivo:</label>
                            <select id="objetivo" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="Hipertrofia">Hipertrofia</option>
                                <option value="Emagrecimento">Emagrecimento</option>
                                <option value="Resistencia Muscular">Resistência Muscular</option>
                                <option value="Condicionamento Fisico">Condicionamento Físico</option>
                            </select>
                        </div>
                        <div>
                            <label for="dias_semana" class="block mb-2 text-text-muted">Dias/Semana:</label>
                            <select id="dias_semana" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="1">1 dia (Avulso)</option>
                                <option value="3">3 dias</option>
                                <option value="4">4 dias</option>
                                <option value="5">5 dias</option>
                                <option value="6">6 dias</option>
                            </select>
                        </div>
                        <div>
                            <label for="duracao_treino" class="block mb-2 text-text-muted">Duração:</label>
                            <select id="duracao_treino" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                                <option value="N/A" selected>Padrão</option>
                                <option value="30 minutos">~30 min</option>
                                <option value="45 minutos">~45 min</option>
                                <option value="60 minutos">~60 min</option>
                                <option value="90 minutos">~90 min</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="divisao_treino" class="block mb-2 text-text-muted">Sugestão de Divisão:</label>
                        <select id="divisao_treino" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light"></select>
                    </div>

                    <div class="border-t border-border-light pt-4 space-y-4">
                         <h3 class="text-lg font-semibold text-primary-blue">Detalhes Avançados (Opcional)</h3>
                         
                         <label class="flex items-center space-x-3 cursor-pointer">
                             <input type="checkbox" id="treino_em_casa" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue">
                             <span>Treino em Casa (sem equipamento de ginásio)</span>
                         </label>
                         
                         <div id="tecnicas_avancadas_container" class="hide">
                             <label class="flex items-center space-x-3 cursor-pointer">
                                 <input type="checkbox" id="incluir_tecnicas" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue">
                                 <span>Incluir técnicas avançadas (dropsets, supersets, etc.)</span>
                             </label>
                         </div>
                         <div>
                             <label for="musculo_enfase" class="block mb-2 text-text-muted">Músculo a Enfatizar:</label>
                             <input type="text" id="musculo_enfase" placeholder="Ex: Peitoral Superior, Quadríceps" class="w-full p-3 rounded-lg border border-border-light bg-bg-container text-text-light">
                         </div>
                         <label class="flex items-center space-x-3 cursor-pointer">
                             <input type="checkbox" id="incluir_dicas" class="h-5 w-5 rounded bg-bg-container border-border-light text-primary-blue focus:ring-primary-blue" checked>
                             <span>Incluir descrições das técnicas e dicas extra</span>
                         </label>
                    </div>
                </div>

                <button id="btnGerarComIA" type="button" class="w-full py-4 text-xl bg-btn-primary text-white rounded-lg font-semibold transition-opacity duration-300">
                    <span class="flex items-center justify-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Gerar Treino com IA
                    </span>
                </button>

                <div class="my-6 border-t border-border-light"></div>
                
                <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl mb-6">
                    <h2 class="text-xl md:text-2xl font-semibold text-primary-blue pb-2 border-b border-border-light">2. Reveja e Ajuste o Treino Gerado</h2>
                    <textarea id="observacoes_gerais" class="w-full p-4 mt-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg" placeholder="Observações gerais para o aluno (geradas pela IA)"></textarea>
                    <div id="diasDeTreinoContainer" class="space-y-6 mt-4"></div>
                    <button id="btnAddDia" type="button" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold mt-6">+ Adicionar Dia Manualmente</button>
                </div>
                
                <button id="btnGerarPreview" type="button" class="w-full py-4 text-xl bg-btn-primary text-white rounded-lg font-semibold mt-4">Pré-visualizar e Guardar</button>
            </form>

            <!-- Tela de Preview e Salvar/Exportar -->
            <div id="treinoPreview" class="hide">
                 <div class="bg-background-dark border border-border-light p-6 md:p-8 rounded-xl">
                     <h2 class="text-xl md:text-2xl font-semibold text-primary-blue mb-4 pb-2 border-b border-border-light">Pré-visualização do Plano</h2>
                     
                     <div id="analiseNutricionalPreview" class="mb-6 bg-bg-container p-4 rounded-lg border border-border-light"></div>

                     <div id="treinosPreviewContainer" class="space-y-6"></div>
                     
                     <div class="mt-8 space-y-4">
                         <input type="text" id="treinoNomeSalvo" placeholder="Nome do Treino (Ex: Hipertrofia - Mês 1)" class="w-full p-4 rounded-lg border border-border-light bg-bg-container text-text-light text-lg">
                         <div class="flex flex-col sm:flex-row gap-4">
                             <button id="btnSalvarComoModelo" type="button" class="w-full py-3 text-lg bg-blue-800 text-white rounded-lg font-semibold">Guardar como Modelo</button>
                             <button id="btnSalvarTreino" type="button" class="w-full py-3 text-lg bg-primary-blue text-white rounded-lg font-semibold">Guardar Treino na Nuvem</button>
                         </div>
                     </div>

                     <div class="flex flex-col sm:flex-row gap-4 mt-6">
                         <button id="btnVoltarForm" type="button" class="w-full py-3 text-lg bg-btn-secondary text-white rounded-lg font-semibold">← Editar</button>
                         <button id="btnGerarPDF" type="button" class="w-full py-3 text-lg bg-btn-primary text-white rounded-lg font-semibold">Gerar e Descarregar PDF</button>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar/Editar Aluno -->
    <div id="addAlunoModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeAddAlunoModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="modalAlunoTitle" class="text-2xl font-semibold text-text-light mb-4">Registar Novo Aluno</h3>
            <form id="formAddAluno" class="space-y-4">
                <input type="hidden" id="alunoIdHidden">
                <div><label for="alunoNome" class="block text-text-muted">Nome do Aluno:</label><input type="text" id="alunoNome" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoIdade" class="block text-text-muted">Idade:</label><input type="number" id="alunoIdade" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                    <div>
                        <label for="alunoSexo" class="block text-text-muted">Sexo:</label>
                        <select id="alunoSexo" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoAltura" class="block text-text-muted">Altura (cm):</label><input type="number" id="alunoAltura" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                    <div><label for="alunoPesoInicial" class="block text-text-muted">Peso (kg):</label><input type="number" step="0.1" id="alunoPesoInicial" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="alunoEmail" class="block text-text-muted">Email (Opcional):</label><input type="email" id="alunoEmail" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label for="alunoTelefone" class="block text-text-muted">Telefone (Opcional):</label><input type="tel" id="alunoTelefone" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                </div>
                <div><label for="alunoObjetivo" class="block text-text-muted">Objetivo Principal:</label><input type="text" id="alunoObjetivo" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required></div>
                <div class="mt-6 flex justify-end"><button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Aluno</button></div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Perfil do Treinador -->
    <div id="editProfileModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeEditProfileModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Editar Perfil</h3>
            <form id="editProfileForm" class="space-y-4">
                <div>
                    <label for="editNameInput" class="block text-text-muted">Nome Completo:</label>
                    <input type="text" id="editNameInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                </div>
                <div>
                    <label for="editDisplayNameInput" class="block text-text-muted">Como quer ser chamado(a):</label>
                    <input type="text" id="editDisplayNameInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Configurações da API Key -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeSettingsModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Configurações de API</h3>
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label for="apiKeyInput" class="block text-text-muted">A sua Chave de API do Google AI:</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                    <p class="text-xs text-text-muted mt-2">A sua chave é guardada apenas no seu navegador. Obtenha a sua em <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary-blue hover:underline">Google AI Studio</a>.</p>
                </div>
                <div>
                    <label for="youtubeApiKeyInput" class="block text-text-muted">A sua Chave de API do YouTube Data v3:</label>
                    <input type="password" id="youtubeApiKeyInput" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" value="AIzaSyByiaW2KLCduh-jKcZtdEUxI1GXWk8axok">
                    <p class="text-xs text-text-muted mt-2">Necessária para a funcionalidade de sugestão de vídeos. A sua chave é guardada apenas no seu navegador. Obtenha a sua no <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank" class="text-primary-blue hover:underline">Google Cloud Console</a>.</p>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="btnClearApiKeys" class="py-3 px-6 text-lg bg-btn-danger text-white rounded-lg font-semibold">Remover Chaves</button>
                    <button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Chaves</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Adicionar Avaliação Física -->
    <div id="addAvaliacaoModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-4 sm:p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-2xl relative">
            <span id="closeAddAvaliacaoModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-6">Nova Avaliação Física</h3>
            <form id="formAddAvaliacao" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="avaliacaoData" class="block text-text-muted">Data da Avaliação:</label>
                        <input type="date" id="avaliacaoData" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                    </div>
                    <div>
                        <label for="avaliacaoPeso" class="block text-text-muted">Peso (kg):</label>
                        <input type="number" step="0.1" id="avaliacaoPeso" class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                    </div>
                </div>
                <h4 class="text-lg font-semibold text-primary-blue pt-4 border-t border-border-light">Medidas Corporais (cm)</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-text-muted text-sm">Peito:</label><input type="number" step="0.1" data-medida="peito" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Braço D:</label><input type="number" step="0.1" data-medida="braco_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Braço E:</label><input type="number" step="0.1" data-medida="braco_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Cintura:</label><input type="number" step="0.1" data-medida="cintura" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Abdômen:</label><input type="number" step="0.1" data-medida="abdomen" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Quadril:</label><input type="number" step="0.1" data-medida="quadril" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Coxa D:</label><input type="number" step="0.1" data-medida="coxa_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Coxa E:</label><input type="number" step="0.1" data-medida="coxa_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Pant. D:</label><input type="number" step="0.1" data-medida="panturrilha_d" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                    <div><label class="block text-text-muted text-sm">Pant. E:</label><input type="number" step="0.1" data-medida="panturrilha_e" class="medida-input w-full p-2 rounded-lg border border-border-light bg-background-dark text-text-light"></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Avaliação</button></div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmationModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-md relative text-center">
            <h3 id="confirmationTitle" class="text-xl font-semibold text-text-light mb-4"></h3>
            <p id="confirmationMessage" class="text-text-muted mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="btnConfirm" class="py-2 px-6 bg-btn-danger text-white rounded-lg font-semibold">Confirmar</button>
                <button id="btnCancel" class="py-2 px-6 bg-btn-secondary text-white rounded-lg font-semibold">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Opções de Guardar -->
    <div id="saveOptionsModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-md relative text-center">
            <h3 id="saveOptionsTitle" class="text-xl font-semibold text-text-light mb-4">Guardar Treino</h3>
            <p id="saveOptionsMessage" class="text-text-muted mb-6">Este treino já existe. O que deseja fazer?</p>
            <div class="flex flex-col gap-4">
                <button id="btnUpdateWorkout" class="w-full py-3 bg-btn-primary text-white rounded-lg font-semibold">Guardar Alterações</button>
                <button id="btnSaveAsNewWorkout" class="w-full py-3 bg-primary-blue text-white rounded-lg font-semibold">Guardar como Novo Treino</button>
                <button id="btnCancelSave" class="w-full py-2 bg-btn-secondary text-white rounded-lg font-semibold mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para exibir os Gráficos -->
    <div id="chartModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-4xl relative">
            <span id="closeChartModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="chartModalTitle" class="text-2xl font-semibold text-text-light mb-4">Visualização de Progresso</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold text-primary-blue text-center mb-2">Evolução do Peso (kg)</h4>
                    <canvas id="weightChart"></canvas>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-primary-blue text-center mb-2">Comparativo de Medidas (cm)</h4>
                    <canvas id="measuresChart"></canvas>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="btnDownloadChart" class="py-2 px-6 bg-btn-primary text-white rounded-lg font-semibold">Descarregar Gráficos</button>
            </div>
        </div>
    </div>

    <!-- Modal para Partilhar Link -->
    <div id="shareLinkModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeShareLinkModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Partilhar Link do Treino</h3>
            <p class="text-text-muted mb-4">Envie este link para o seu aluno. Ele terá acesso apenas a este plano de treino.</p>
            <div class="relative">
                <input type="text" id="shareableLinkInput" class="w-full p-3 pr-12 rounded-lg border border-border-light bg-background-dark text-text-light" readonly>
                <button id="btnCopyLink" class="absolute inset-y-0 right-0 px-3 text-text-muted hover:text-primary-blue">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para carregar Templates de Treino -->
    <div id="loadTemplateModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-2xl relative">
            <span id="closeLoadTemplateModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 class="text-2xl font-semibold text-text-light mb-4">Carregar a Partir de um Modelo</h3>
            <div id="templateListContainer" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- A lista de templates será inserida aqui -->
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar/Editar Link de Vídeo -->
    <div id="videoLinkModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-lg relative">
            <span id="closeVideoLinkModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="videoLinkModalTitle" class="text-2xl font-semibold text-text-light mb-4">Adicionar/Editar Vídeo</h3>
            <p id="videoLinkModalExercise" class="text-text-muted mb-4"></p>
            <form id="formVideoLink" class="space-y-4">
                <input type="hidden" id="exerciseIdHidden">
                <input type="hidden" id="exerciseNameHidden">
                <input type="hidden" id="exerciseGroupHidden">
                <div>
                    <label for="videoUrlInput" class="block text-text-muted">Link do Vídeo (YouTube):</label>
                    <input type="url" id="videoUrlInput" placeholder="https://www.youtube.com/watch?v=..." class="w-full p-3 rounded-lg border border-border-light bg-background-dark text-text-light" required>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="py-3 px-6 text-lg bg-btn-primary text-white rounded-lg font-semibold">Guardar Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Sugestões de Vídeo do YouTube -->
    <div id="videoSuggestionsModal" class="modal fixed inset-0 z-50 flex justify-center items-center p-4 hide">
        <div class="modal-content bg-bg-container p-6 rounded-xl shadow-2xl border border-border-light w-full max-w-2xl relative">
            <span id="closeVideoSuggestionsModal" class="absolute top-4 right-4 text-2xl font-bold text-text-muted cursor-pointer">&times;</span>
            <h3 id="videoSuggestionsTitle" class="text-2xl font-semibold text-text-light mb-4">Sugestões de Vídeo</h3>
            <div id="videoSuggestionsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- As sugestões de vídeo serão inseridas aqui -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, deleteDoc, serverTimestamp, query, where, updateDoc, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // --- FUNÇÕES GLOBAIS / UTILITÁRIAS ---
        function toggleSpinner(show, message = "Aguarde...") {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                document.getElementById('spinner-message').textContent = message;
                spinner.classList.toggle('hide', !show);
            }
        }

        function showNotification(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            const iconContainer = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');

            if (notification && iconContainer && titleEl && messageEl) {
                titleEl.textContent = title;
                messageEl.textContent = message;

                const successIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                const errorIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

                if (type === 'success') {
                    notification.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 bg-btn-success opacity-100 visible translate-y-0 w-full max-w-sm shadow-lg`;
                    iconContainer.innerHTML = successIcon;
                } else {
                    notification.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white z-50 transition-all duration-300 bg-btn-danger opacity-100 visible translate-y-0 w-full max-w-sm shadow-lg`;
                    iconContainer.innerHTML = errorIcon;
                }

                setTimeout(() => {
                    notification.className = notification.className.replace('opacity-100 visible translate-y-0', 'opacity-0 invisible -translate-y-10');
                }, 4000);
            }
        }

        // --- INICIALIZAÇÃO DO FIREBASE E DA APLICAÇÃO ---
        let app, auth, db;

        try {
            const encodedConfig = 'eyJhcGlLZXkiOiJBSXphU3lEcjU0NGU0M19pS1dOVkw5VUNLZEtPTk1fczlfZ0d4VHMiLCJhdXRoRG9tYWluIjoic2FtcGxlLWZpcmViYXNlLWFpLWFwcC03YzRiOC5maXJlYmFzZWFwcC5jb20iLCJwcm9qZWN0SWQiOiJzYW1wbGUtZmlyZWJhc2UtYWktYXBwLTdjNGI4Iiwic3RvcmFnZUJ1Y2tldCI6InNhbXBsZS1maXJlYmFzZS1haS1hcHAtN2M0YjguYXBwc3BvdC5jb20iLCJtZXNzYWdpbmdTZW5kZXJJZCI6IjYxNDg5MjIzODQiLCJhcHBJZCI6IjE6NjE0ODkyMjM4NDp3ZWI6YmM2YzllZTM0MGQ5NzI2YWNmYmU5NSJ9';
            const decodedConfig = atob(encodedConfig);
            const firebaseConfig = JSON.parse(decodedConfig);

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado com sucesso!");

        } catch (error) {
            console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
            showNotification("Erro crítico", "Falha ao conectar com a aplicação. Verifique a console.", "error");
        }

        // --- INICIALIZAÇÃO DAS VIEWS ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!app || !auth || !db) {
                console.error("A aplicação não pode iniciar porque o Firebase falhou a inicialização.");
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const publicId = params.get('publicId');

            if (publicId) {
                initializePublicView(publicId);
            } else {
                initializeTrainerApp();
            }
        });

        // --- LÓGICA DA PÁGINA PÚBLICA ---
        async function initializePublicView(publicId) {
            document.getElementById('mainApp').classList.add('hide');
            const publicView = document.getElementById('publicView');
            publicView.classList.remove('hide');
            toggleSpinner(true, "A carregar treino...");

            try {
                const publicDocRef = doc(db, "publicTrainings", publicId);
                const docSnap = await getDoc(publicDocRef);

                if (docSnap.exists()) {
                    renderPublicTraining(docSnap.data());
                    document.getElementById('publicContent').classList.remove('hide');
                    document.getElementById('publicError').classList.add('hide');
                } else {
                    document.getElementById('publicContent').classList.add('hide');
                    document.getElementById('publicError').classList.remove('hide');
                }
            } catch (error) {
                console.error("Erro ao carregar treino público:", error);
                document.getElementById('publicContent').classList.add('hide');
                document.getElementById('publicError').classList.remove('hide');
            } finally {
                toggleSpinner(false);
            }
        }
        
        function renderPublicTraining(data) {
            document.getElementById('publicAlunoNome').textContent = data.alunoNome;
            document.getElementById('publicTrainerInfo').textContent = `Preparado por: ${data.trainerName}`;
            const container = document.getElementById('publicTreinoContainer');
            container.innerHTML = '';

            if (data.analiseNutricional) {
                const { imc, tmb, caloriasRecomendadas, proteina, carboidratos, agua, creatina } = data.analiseNutricional;
                container.innerHTML += `
                    <div class="mb-6 bg-bg-container p-4 rounded-lg border border-border-light">
                        <h3 class="text-lg font-semibold text-primary-blue mb-2">Análise Corporal e Metas Diárias</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                            <p><strong class="text-text-light">IMC:</strong> ${imc || 'N/D'}</p>
                            <p><strong class="text-text-light">TMB:</strong> ${tmb || 'N/D'}</p>
                            <p><strong class="text-text-light">Calorias (Obj.):</strong> ${caloriasRecomendadas || 'N/D'}</p>
                            <p><strong class="text-text-light">Proteína:</strong> ${proteina || 'N/D'}</p>
                            <p><strong class="text-text-light">Carboidratos:</strong> ${carboidratos || 'N/D'}</p>
                            <p><strong class="text-text-light">Água:</strong> ${agua || 'N/D'}</p>
                            <p><strong class="text-text-light">Creatina:</strong> ${creatina || 'N/D'}</p>
                        </div>
                    </div>
                `;
            }

            if (data.observacoes) {
                container.innerHTML += `<div class="mb-4"><h4 class="font-bold text-primary-blue">Observações Gerais:</h4><p class="text-text-muted whitespace-pre-wrap">${data.observacoes}</p></div>`;
            }

            if (!data.dias || !Array.isArray(data.dias) || data.dias.length === 0) {
                container.innerHTML += '<p class="text-text-muted text-center py-8">Nenhum dia de treino foi encontrado neste plano.</p>';
                return;
            }

            const youtubeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-red-500"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" /></svg>`;

            data.dias.forEach(dia => {
                let diaHTML = `<div class="mb-4">
                    <h3 class="text-xl font-semibold text-text-light border-b-2 border-primary-blue pb-1 mb-3">${dia.nome} <span class="text-base font-normal text-text-muted">- ${dia.musculos}</span></h3>`;

                if (dia.aquecimento) diaHTML += `<div class="mb-3"><h4 class="font-semibold text-primary-blue text-sm">Aquecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.aquecimento}</p></div>`;
                
                if (dia.exercicios && Array.isArray(dia.exercicios) && dia.exercicios.length > 0) {
                    let exerciciosHTML = dia.exercicios.map(ex => {
                        const nomeExercicioComVideo = ex.videoUrl 
                            ? `<a href="${ex.videoUrl}" target="_blank" class="flex items-center text-primary-blue hover:underline">
                                    <span>${ex.nome}</span>
                                    <span class="ml-2">${youtubeIcon}</span>
                                </a>` 
                            : `<span>${ex.nome}</span>`;

                        const obsHTML = ex.obs ? `<tr class="bg-background-dark"><td colspan="4" class="text-xs text-primary-blue pt-1 pb-2 px-2">${ex.obs}</td></tr>` : '';

                        return `
                            <tr class="border-b border-border-light">
                                <td class="py-2 px-2">${nomeExercicioComVideo}</td>
                                <td class="py-2 px-2 text-center">${ex.series || '-'}</td>
                                <td class="py-2 px-2 text-center">${ex.reps || '-'}</td>
                                <td class="py-2 px-2 text-center">${ex.descanso || '-'}</td>
                            </tr>
                            ${obsHTML}
                        `;
                    }).join('');
                    
                    diaHTML += `<table class="w-full text-left text-sm">
                        <thead><tr class="text-text-muted"><th class="w-2/5 font-semibold py-2 px-2">Exercício</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Séries</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Reps</th><th class="w-1/5 font-semibold py-2 px-2 text-center">Descanso</th></tr></thead>
                        <tbody>${exerciciosHTML}</tbody>
                    </table>`;
                }
                
                if (dia.cardio) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Cardio:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.cardio}</p></div>`;
                if (dia.arrefecimento) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Arrefecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.arrefecimento}</p></div>`;

                diaHTML += `</div>`;
                container.innerHTML += diaHTML;
            });

            if (data.tecnicas && data.tecnicas.length > 0) {
                let tecnicasHTML = data.tecnicas.map(t => `<li><strong class="text-text-light">${t.nome}:</strong> ${t.descricao}</li>`).join('');
                container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Técnicas Utilizadas</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${tecnicasHTML}</ul></div>`;
            }
            if (data.dicas && data.dicas.length > 0) {
                let dicasHTML = data.dicas.map(d => `<li>${d}</li>`).join('');
                container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Dicas Extra</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${dicasHTML}</ul></div>`;
            }
        }

        // --- LÓGICA PRINCIPAL DA APLICAÇÃO DO TREINADOR ---
        function initializeTrainerApp() {
            // --- STATE & DOM ELEMENTS ---
            let appState = { 
                currentUser: null, 
                alunoSelecionado: null, 
                treinoSemanal: [],
                tecnicas: [],
                dicas: [],
                analiseNutricional: {},
                avaliacoesCache: [],
                treinoAbertoId: null,
                alunosCache: [],
                exerciciosBibliotecaCache: [],
                apiKey: null,
                youtubeApiKey: null,
            };

            const telaLogin = document.getElementById('telaLogin');
            const telaCadastro = document.getElementById('telaCadastro');
            const appContent = document.getElementById('appContent');
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const btnForgotPassword = document.getElementById('btnForgotPassword');
            const btnTogglePassword = document.getElementById('btnTogglePassword');
            const signupForm = document.getElementById('signupForm');
            const signupName = document.getElementById('signupName');
            const signupDisplayName = document.getElementById('signupDisplayName');
            const signupAge = document.getElementById('signupAge');
            const signupEmail = document.getElementById('signupEmail');
            const signupPassword = document.getElementById('signupPassword');
            const linkGoToSignup = document.getElementById('linkGoToSignup');
            const linkGoToLogin = document.getElementById('linkGoToLogin');
            const btnLogout = document.getElementById('btnLogout');
            const userInfo = document.getElementById('userInfo');
            const btnShowAddAlunoModal = document.getElementById('btnShowAddAlunoModal');
            const addAlunoModal = document.getElementById('addAlunoModal');
            const closeAddAlunoModal = document.getElementById('closeAddAlunoModal');
            const formAddAluno = document.getElementById('formAddAluno');
            const listaAlunos = document.getElementById('listaAlunos');
            const nomeAlunoGerenciado = document.getElementById('nomeAlunoGerenciado');
            const btnVoltarParaAlunos = document.getElementById('btnVoltarParaAlunos');
            const btnNovoTreino = document.getElementById('btnNovoTreino');
            const btnCarregarTreino = document.getElementById('btnCarregarTreino');
            const tituloTelaCarregar = document.getElementById('tituloTelaCarregar');
            const btnVoltarParaGerenciarAluno_Carregar = document.getElementById('btnVoltarParaGerenciarAluno_Carregar');
            const btnVoltarParaGerenciarAluno_Form = document.getElementById('btnVoltarParaGerenciarAluno_Form');
            const btnVoltarForm = document.getElementById('btnVoltarForm');
            const diasDeTreinoContainer = document.getElementById('diasDeTreinoContainer');
            const diasSemanaSelect = document.getElementById('dias_semana');
            const divisaoTreinoSelect = document.getElementById('divisao_treino');
            const btnGerarComIA = document.getElementById('btnGerarComIA');
            const dificuldadeSelect = document.getElementById('dificuldade');
            const tecnicasContainer = document.getElementById('tecnicas_avancadas_container');
            const btnAcompanharEvolucao = document.getElementById('btnAcompanharEvolucao');
            const telaAcompanhamento = document.getElementById('telaAcompanhamento');
            const btnVoltarParaGerenciarAluno_Acomp = document.getElementById('btnVoltarParaGerenciarAluno_Acomp');
            const tituloAcompanhamento = document.getElementById('tituloAcompanhamento');
            const btnShowAddAvaliacaoModal = document.getElementById('btnShowAddAvaliacaoModal');
            const addAvaliacaoModal = document.getElementById('addAvaliacaoModal');
            const closeAddAvaliacaoModal = document.getElementById('closeAddAvaliacaoModal');
            const formAddAvaliacao = document.getElementById('formAddAvaliacao');
            const listaAvaliacoes = document.getElementById('listaAvaliacoes');
            const chartModal = document.getElementById('chartModal');
            const closeChartModal = document.getElementById('closeChartModal');
            const chartModalTitle = document.getElementById('chartModalTitle');
            const btnDownloadChart = document.getElementById('btnDownloadChart');
            let weightChartInstance = null;
            let measuresChartInstance = null;
            const modalAlunoTitle = document.getElementById('modalAlunoTitle');
            const alunoIdHidden = document.getElementById('alunoIdHidden');
            const telaBoasVindas = document.getElementById('telaBoasVindas');
            const mensagemBoasVindas = document.getElementById('mensagemBoasVindas');
            const btnIrParaAlunos = document.getElementById('btnIrParaAlunos');
            const btnAdicionarAlunoRapido = document.getElementById('btnAdicionarAlunoRapido');
            const shareLinkModal = document.getElementById('shareLinkModal');
            const closeShareLinkModal = document.getElementById('closeShareLinkModal');
            const shareableLinkInput = document.getElementById('shareableLinkInput');
            const btnCopyLink = document.getElementById('btnCopyLink');
            const btnEditProfile = document.getElementById('btnEditProfile');
            const editProfileModal = document.getElementById('editProfileModal');
            const closeEditProfileModal = document.getElementById('closeEditProfileModal');
            const editProfileForm = document.getElementById('editProfileForm');
            const editNameInput = document.getElementById('editNameInput');
            const editDisplayNameInput = document.getElementById('editDisplayNameInput');
            const alunoSearchInput = document.getElementById('alunoSearchInput');
            const alunoObjectiveFilter = document.getElementById('alunoObjectiveFilter');
            const btnLoadTemplate = document.getElementById('btnLoadTemplate');
            const loadTemplateModal = document.getElementById('loadTemplateModal');
            const closeLoadTemplateModal = document.getElementById('closeLoadTemplateModal');
            const templateListContainer = document.getElementById('templateListContainer');
            const btnSalvarComoModelo = document.getElementById('btnSalvarComoModelo');
            const btnShowSettings = document.getElementById('btnShowSettings');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const settingsForm = document.getElementById('settingsForm');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const youtubeApiKeyInput = document.getElementById('youtubeApiKeyInput');
            const btnClearApiKeys = document.getElementById('btnClearApiKeys');

            // --- Elementos da Biblioteca de Exercícios ---
            const btnIrParaBiblioteca = document.getElementById('btnIrParaBiblioteca');
            const telaBiblioteca = document.getElementById('telaBiblioteca');
            const btnVoltarParaBoasVindas_Bib = document.getElementById('btnVoltarParaBoasVindas_Bib');
            const btnPopularBiblioteca = document.getElementById('btnPopularBiblioteca');
            const exercicioSearchInput = document.getElementById('exercicioSearchInput');
            const exercicioGroupFilter = document.getElementById('exercicioGroupFilter');
            const listaExerciciosBiblioteca = document.getElementById('listaExerciciosBiblioteca');
            const videoLinkModal = document.getElementById('videoLinkModal');
            const closeVideoLinkModal = document.getElementById('closeVideoLinkModal');
            const formVideoLink = document.getElementById('formVideoLink');
            const videoLinkModalTitle = document.getElementById('videoLinkModalTitle');
            const videoLinkModalExercise = document.getElementById('videoLinkModalExercise');
            const exerciseIdHidden = document.getElementById('exerciseIdHidden');
            const exerciseNameHidden = document.getElementById('exerciseNameHidden');
            const exerciseGroupHidden = document.getElementById('exerciseGroupHidden');
            const videoUrlInput = document.getElementById('videoUrlInput');
            const videoSuggestionsModal = document.getElementById('videoSuggestionsModal');
            const closeVideoSuggestionsModal = document.getElementById('closeVideoSuggestionsModal');
            const videoSuggestionsContainer = document.getElementById('videoSuggestionsContainer');
            const videoSuggestionsTitle = document.getElementById('videoSuggestionsTitle');

            const iconEye = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.01 9.963 7.182.373.836-.018 1.76-.942 1.956a1.012 1.012 0 01-1.258-.453C18.663 15.045 15.564 18 12 18c-3.564 0-6.663-2.955-8.22-5.468z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
            const iconEyeSlash = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;
            if(btnTogglePassword) btnTogglePassword.innerHTML = iconEye;

            // --- AUTH & NAVIGATION ---
            onAuthStateChanged(auth, async user => {
                if (user) {
                    const userDocRef = doc(db, "usuarios", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    let userName = "Treinador(a)";
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        userName = userData.nomeExibicao || userData.nome || "Treinador(a)";
                    }
                    appState.currentUser = { ...user, displayName: userName };

                    userInfo.textContent = `Logado como: ${user.email}`;
                    telaLogin.classList.add('hide');
                    telaCadastro.classList.add('hide');
                    appContent.classList.remove('hide');
                    
                    loadApiKeys();
                    getBibliotecaExercicios(); // Pre-carrega a biblioteca no login
                    updateWelcomeMessage();
                    mostrarTela('telaBoasVindas');

                } else {
                    appState.currentUser = null;
                    userInfo.textContent = '';
                    appContent.classList.add('hide');
                    telaCadastro.classList.add('hide');
                    telaLogin.classList.remove('hide');
                }
            });

            linkGoToSignup.addEventListener('click', (e) => { e.preventDefault(); telaLogin.classList.add('hide'); telaCadastro.classList.remove('hide'); });
            linkGoToLogin.addEventListener('click', (e) => { e.preventDefault(); telaCadastro.classList.add('hide'); telaLogin.classList.remove('hide'); });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                toggleSpinner(true, "A criar conta...");
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
                    await setDoc(doc(db, "usuarios", userCredential.user.uid), {
                        nome: signupName.value,
                        nomeExibicao: signupDisplayName.value,
                        idade: signupAge.value,
                        email: signupEmail.value
                    });
                    showNotification("Sucesso!", `Bem-vindo, ${signupDisplayName.value}!`);
                } catch (error) { handleAuthError(error); } 
                finally { toggleSpinner(false); }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                toggleSpinner(true, "A entrar...");
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) { handleAuthError(error); }
                finally { toggleSpinner(false); }
            });

            btnLogout.addEventListener('click', () => signOut(auth));
            btnForgotPassword.addEventListener('click', async () => {
                const email = emailInput.value || prompt("Por favor, digite o seu email para redefinir a palavra-passe:");
                if (!email) return showNotification("Atenção", "Por favor, insira um email.", "error");
                toggleSpinner(true, "A enviar email...");
                try {
                    await sendPasswordResetEmail(auth, email);
                    showNotification("Enviado!", `Email de redefinição enviado para ${email}. Verifique a sua caixa de entrada e spam.`, "success");
                } catch (error) { handleAuthError(error); }
                finally { toggleSpinner(false); }
            });

            btnTogglePassword.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                btnTogglePassword.innerHTML = isPassword ? iconEyeSlash : iconEye;
            });

            function handleAuthError(error) {
                let title = "Erro de Autenticação";
                let message = "Ocorreu um erro. Tente novamente mais tarde.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        title = "Credenciais Inválidas";
                        message = "O email ou a palavra-passe que inseriu estão incorretos.";
                        break;
                    case 'auth/email-already-in-use':
                        title = "Email já Registado";
                        message = "Este endereço de email já está a ser utilizado por outra conta.";
                        break;
                    case 'auth/invalid-email':
                        title = "Email Inválido";
                        message = "O formato do email que inseriu não é válido.";
                        break;
                    case 'auth/weak-password':
                        title = "Palavra-passe Fraca";
                        message = "A sua palavra-passe deve ter pelo menos 6 caracteres.";
                        break;
                }
                showNotification(title, message, 'error');
            }
            
            // --- LÓGICA DE API KEY ---
            function loadApiKeys() {
                const storedGoogleKey = localStorage.getItem('googleAiApiKey');
                if (storedGoogleKey) {
                    appState.apiKey = storedGoogleKey;
                    apiKeyInput.value = storedGoogleKey;
                }
                const storedYoutubeKey = localStorage.getItem('youtubeApiKey');
                if (storedYoutubeKey) {
                    appState.youtubeApiKey = storedYoutubeKey;
                    youtubeApiKeyInput.value = storedYoutubeKey;
                }
            }

            btnShowSettings.addEventListener('click', () => {
                settingsModal.classList.remove('hide');
            });

            closeSettingsModal.addEventListener('click', () => settingsModal.classList.add('hide'));

            settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newGoogleKey = apiKeyInput.value.trim();
                const newYoutubeKey = youtubeApiKeyInput.value.trim();

                if (newGoogleKey) {
                    appState.apiKey = newGoogleKey;
                    localStorage.setItem('googleAiApiKey', newGoogleKey);
                }
                if (newYoutubeKey) {
                    appState.youtubeApiKey = newYoutubeKey;
                    localStorage.setItem('youtubeApiKey', newYoutubeKey);
                }
                showNotification("Sucesso", "Chaves de API guardadas com sucesso!");
                settingsModal.classList.add('hide');
            });

            btnClearApiKeys.addEventListener('click', () => {
                appState.apiKey = null;
                appState.youtubeApiKey = null;
                localStorage.removeItem('googleAiApiKey');
                localStorage.removeItem('youtubeApiKey');
                apiKeyInput.value = '';
                youtubeApiKeyInput.value = '';
                showNotification("Sucesso", "Chaves de API removidas.");
                settingsModal.classList.add('hide');
            });

            // --- LÓGICA DE PERFIL DO TREINADOR ---
            btnEditProfile.addEventListener('click', async () => {
                if (!appState.currentUser) return;
                toggleSpinner(true, "A carregar perfil...");
                try {
                    const userDocRef = doc(db, "usuarios", appState.currentUser.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        editNameInput.value = userData.nome || '';
                        editDisplayNameInput.value = userData.nomeExibicao || '';
                    } else {
                        editNameInput.value = '';
                        editDisplayNameInput.value = '';
                    }
                    editProfileModal.classList.remove('hide');
                } catch (error) {
                    showNotification("Erro", "Erro ao carregar o perfil.", "error");
                    console.error("Erro ao buscar perfil:", error);
                } finally {
                    toggleSpinner(false);
                }
            });

            closeEditProfileModal.addEventListener('click', () => editProfileModal.classList.add('hide'));

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;

                const newName = editNameInput.value.trim();
                const newDisplayName = editDisplayNameInput.value.trim();

                if (!newName || !newDisplayName) {
                    showNotification("Atenção", "Ambos os campos são obrigatórios.", "error");
                    return;
                }

                toggleSpinner(true, "A guardar alterações...");
                try {
                    const userDocRef = doc(db, "usuarios", appState.currentUser.uid);
                    await setDoc(userDocRef, {
                        nome: newName,
                        nomeExibicao: newDisplayName
                    }, { merge: true });

                    appState.currentUser.displayName = newDisplayName;
                    updateWelcomeMessage();

                    showNotification("Sucesso!", "Perfil atualizado com sucesso!");
                    editProfileModal.classList.add('hide');

                } catch (error) {
                    showNotification("Erro", "Erro ao guardar as alterações.", "error");
                    console.error("Erro ao atualizar perfil:", error);
                } finally {
                    toggleSpinner(false);
                }
            });
            
            function updateWelcomeMessage() {
                if (!appState.currentUser) return;
                let nome = appState.currentUser.displayName.split(' ')[0];
                const hora = new Date().getHours();
                let saudacao = "Olá";
                if (hora >= 5 && hora < 12) { saudacao = "Bom dia"; }
                else if (hora >= 12 && hora < 18) { saudacao = "Boa tarde"; }
                else { saudacao = "Boa noite"; }
                mensagemBoasVindas.textContent = `${saudacao}, ${nome}!`;
            }


            // --- LÓGICA DE ALUNOS ---
            btnIrParaAlunos.addEventListener('click', () => {
                mostrarTela('telaAlunos');
                carregarAlunos();
            });
            btnShowAddAlunoModal.addEventListener('click', () => {
                formAddAluno.reset();
                alunoIdHidden.value = '';
                modalAlunoTitle.textContent = "Registar Novo Aluno";
                addAlunoModal.classList.remove('hide');
            });
            closeAddAlunoModal.addEventListener('click', () => addAlunoModal.classList.add('hide'));

            formAddAluno.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;

                const alunoId = alunoIdHidden.value;
                const isEditing = !!alunoId;

                const nome = document.getElementById('alunoNome').value.trim();
                const idade = parseInt(document.getElementById('alunoIdade').value);
                const sexo = document.getElementById('alunoSexo').value;
                const altura = parseInt(document.getElementById('alunoAltura').value);
                const pesoInicial = parseFloat(document.getElementById('alunoPesoInicial').value);
                const objetivo = document.getElementById('alunoObjetivo').value;
                const email = document.getElementById('alunoEmail').value.trim();
                const telefone = document.getElementById('alunoTelefone').value.trim();

                if (!nome || !objetivo || !altura || !idade || !pesoInicial || !sexo) return showNotification('Atenção', 'Todos os campos obrigatórios devem ser preenchidos.', 'error');
                
                toggleSpinner(true, "A guardar dados...");
                try {
                    const alunosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos");
                    const nomeLowerCase = nome.toLowerCase();
                    
                    if (!isEditing) {
                        const q = query(alunosRef, where("nome_lowercase", "==", nomeLowerCase));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            showNotification("Atenção", "Já existe um aluno com este nome.", "error");
                            toggleSpinner(false);
                            return;
                        }
                    }
                    
                    const alunoData = { 
                        nome, nome_lowercase: nomeLowerCase, idade, sexo, altura, pesoInicial,
                        objetivo, email, telefone
                    };

                    if (isEditing) {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        await updateDoc(alunoDocRef, alunoData);
                        showNotification("Sucesso!", `Dados de "${nome}" atualizados!`);
                    } else {
                        alunoData.criadoEm = serverTimestamp();
                        await addDoc(alunosRef, alunoData);
                        showNotification("Sucesso!", `Aluno "${nome}" registado!`);
                    }

                    formAddAluno.reset();
                    addAlunoModal.classList.add('hide');
                    await carregarAlunos(); 
                } catch (error) { 
                    console.error("Erro ao guardar aluno:", error);
                    showNotification("Erro", "Erro ao guardar dados do aluno.", "error");
                } finally { 
                    toggleSpinner(false); 
                }
            });

            alunoSearchInput.addEventListener('input', () => renderAlunosList());
            alunoObjectiveFilter.addEventListener('change', () => renderAlunosList());

            async function carregarAlunos() {
                if (!appState.currentUser) return;
                listaAlunos.innerHTML = `<p class="text-text-muted text-center py-8">A carregar...</p>`;
                try {
                    const alunosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos");
                    const querySnapshot = await getDocs(query(alunosRef, orderBy("nome")));
                    
                    appState.alunosCache = [];
                    querySnapshot.forEach(doc => {
                        appState.alunosCache.push({ id: doc.id, ...doc.data() });
                    });
                    
                    populateObjectiveFilter();
                    renderAlunosList();
                } catch (error) { 
                    appState.alunosCache = [];
                    renderAlunosList();
                    console.error(error);
                }
            }

            function populateObjectiveFilter() {
                const objectives = [...new Set(appState.alunosCache.map(aluno => aluno.objetivo))].sort();
                alunoObjectiveFilter.innerHTML = '<option value="">Filtrar por objetivo</option>';
                objectives.forEach(obj => {
                    if (obj) {
                        const option = document.createElement('option');
                        option.value = obj;
                        option.textContent = obj;
                        alunoObjectiveFilter.appendChild(option);
                    }
                });
            }

            function renderAlunosList() {
                const searchTerm = alunoSearchInput.value.toLowerCase();
                const selectedObjective = alunoObjectiveFilter.value;

                const filteredAlunos = appState.alunosCache.filter(aluno => {
                    const nameMatch = aluno.nome.toLowerCase().includes(searchTerm);
                    const objectiveMatch = !selectedObjective || aluno.objetivo === selectedObjective;
                    return nameMatch && objectiveMatch;
                });

                if (filteredAlunos.length === 0) {
                     if(appState.alunosCache.length === 0) {
                         listaAlunos.innerHTML = `<div class="text-center p-8"><h3 class="text-xl font-semibold">Bem-vindo!</h3><p class="text-text-muted mt-2">Parece que ainda não tem alunos. Clique em "+ Adicionar Aluno" para começar a criar planos de treino.</p></div>`;
                     } else {
                         listaAlunos.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum aluno encontrado com os filtros atuais.</p>`;
                     }
                    return;
                }
                
                listaAlunos.innerHTML = '';
                filteredAlunos.forEach(aluno => {
                    const alunoDiv = document.createElement('div');
                    alunoDiv.className = 'bg-background-dark border border-border-light p-4 rounded-lg flex justify-between items-center';
                    
                    const placeholderIcon = `<div class="w-12 h-12 rounded-full bg-border-light flex items-center justify-center text-text-muted text-xl font-bold">${aluno.nome.charAt(0).toUpperCase()}</div>`;
                    
                    alunoDiv.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow cursor-pointer view-aluno" data-alunoid="${aluno.id}">
                            ${placeholderIcon}
                            <div class="flex-grow">
                                <h4 class="font-semibold text-text-light pointer-events-none">${aluno.nome}</h4>
                                <p class="text-sm text-text-muted pointer-events-none">${aluno.objetivo}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button class="btn-editar-aluno text-primary-blue hover:text-opacity-80 p-2 rounded-full" data-alunoid="${aluno.id}" title="Editar Aluno">
                                <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="btn-excluir-aluno text-red-500 hover:text-red-400 p-2 rounded-full" data-alunoid="${aluno.id}" title="Excluir Aluno">
                                <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`;
                    listaAlunos.appendChild(alunoDiv);
                });
            }
            
            async function deleteSubcollection(collectionRef) {
                const querySnapshot = await getDocs(collectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            }

            listaAlunos.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.btn-excluir-aluno');
                const editButton = e.target.closest('.btn-editar-aluno');
                const viewArea = e.target.closest('.view-aluno');

                if (deleteButton) {
                    const alunoId = deleteButton.dataset.alunoid;
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir este aluno e todos os seus dados? Esta ação não pode ser desfeita.");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir aluno...");
                    try {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        
                        const treinosRef = collection(alunoDocRef, "treinos");
                        await deleteSubcollection(treinosRef);
                        
                        const avaliacoesRef = collection(alunoDocRef, "avaliacoes");
                        await deleteSubcollection(avaliacoesRef);
                        
                        await deleteDoc(alunoDocRef);

                        showNotification("Sucesso!", "Aluno excluído com sucesso.");
                        await carregarAlunos();
                    } catch (error) {
                        console.error("Erro ao excluir aluno:", error);
                        if (error.code === 'permission-denied') {
                            showNotification("Erro de Permissão", "Verifique as regras de segurança do Firebase.", "error");
                        } else {
                            showNotification("Erro", "Erro ao excluir aluno.", "error");
                        }
                    } finally {
                        toggleSpinner(false);
                    }
                } else if (editButton) {
                    const alunoId = editButton.dataset.alunoid;
                    abrirModalEdicao(alunoId);
                } else if (viewArea) {
                    const alunoId = viewArea.dataset.alunoid;
                    toggleSpinner(true, "A carregar dados do aluno...");
                    try {
                        const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                        const docSnap = await getDoc(alunoDocRef);
                        if (docSnap.exists()) {
                            appState.alunoSelecionado = { id: docSnap.id, ...docSnap.data() };
                            nomeAlunoGerenciado.textContent = `A gerir: ${appState.alunoSelecionado.nome}`;
                            mostrarTela('telaGerenciarAluno');
                        } else { throw new Error("Aluno não encontrado."); }
                    } catch (error) { showNotification("Erro", "Erro ao carregar dados do aluno.", "error"); } 
                    finally { toggleSpinner(false); }
                }
            });
            
            async function abrirModalEdicao(alunoId) {
                toggleSpinner(true, "A carregar dados...");
                try {
                    const alunoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", alunoId);
                    const docSnap = await getDoc(alunoDocRef);
                    if (docSnap.exists()) {
                        const aluno = docSnap.data();
                        appState.alunoSelecionado = { id: docSnap.id, ...aluno }; 
                        
                        formAddAluno.reset();
                        alunoIdHidden.value = docSnap.id;
                        modalAlunoTitle.textContent = "Editar Dados do Aluno";
                        
                        document.getElementById('alunoNome').value = aluno.nome || '';
                        document.getElementById('alunoIdade').value = aluno.idade || '';
                        document.getElementById('alunoSexo').value = aluno.sexo || 'Masculino';
                        document.getElementById('alunoAltura').value = aluno.altura || '';
                        document.getElementById('alunoPesoInicial').value = aluno.pesoInicial || '';
                        document.getElementById('alunoEmail').value = aluno.email || '';
                        document.getElementById('alunoTelefone').value = aluno.telefone || '';
                        document.getElementById('alunoObjetivo').value = aluno.objetivo || '';
                        
                        addAlunoModal.classList.remove('hide');
                    }
                } catch (error) {
                    showNotification("Erro", "Erro ao carregar dados para edição.", "error");
                } finally {
                    toggleSpinner(false);
                }
            }
                                    
            // --- LÓGICA DE ACOMPANHAMENTO ---
            btnAcompanharEvolucao.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;
                tituloAcompanhamento.textContent = `Evolução de ${appState.alunoSelecionado.nome}`;
                carregarAvaliacoes();
                mostrarTela('telaAcompanhamento');
            });

            btnVoltarParaGerenciarAluno_Acomp.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnShowAddAvaliacaoModal.addEventListener('click', () => {
                formAddAvaliacao.reset();
                document.getElementById('avaliacaoData').value = new Date().toISOString().split('T')[0];
                addAvaliacaoModal.classList.remove('hide');
            });
            closeAddAvaliacaoModal.addEventListener('click', () => addAvaliacaoModal.classList.add('hide'));

            formAddAvaliacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser || !appState.alunoSelecionado) return;

                const data = document.getElementById('avaliacaoData').value;
                const peso = parseFloat(document.getElementById('avaliacaoPeso').value);

                if (!data || !peso) return showNotification("Atenção", "Data e Peso são obrigatórios.", "error");

                const medidas = {};
                document.querySelectorAll('.medida-input').forEach(input => {
                    if (input.value) {
                        medidas[input.dataset.medida] = parseFloat(input.value);
                    }
                });

                toggleSpinner(true, "A guardar avaliação...");
                try {
                    const avaliacoesRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes");
                    await addDoc(avaliacoesRef, { data, peso, medidas, criadoEm: serverTimestamp() });
                    showNotification("Sucesso!", "Avaliação guardada com sucesso!");
                    addAvaliacaoModal.classList.add('hide');
                    carregarAvaliacoes();
                } catch (error) {
                    showNotification("Erro", "Erro ao guardar avaliação.", "error");
                    console.error("Erro:", error);
                } finally {
                    toggleSpinner(false);
                }
            });

            async function carregarAvaliacoes() {
                if (!appState.currentUser || !appState.alunoSelecionado) return;
                listaAvaliacoes.innerHTML = `<p class="text-text-muted text-center py-8">A carregar histórico...</p>`;
                try {
                    const avaliacoesRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes");
                    const querySnapshot = await getDocs(query(avaliacoesRef, orderBy("data", "desc")));

                    if (querySnapshot.empty) {
                        listaAvaliacoes.innerHTML = `<p class="text-text-muted text-center py-8">Nenhuma avaliação registada. Clique em "+ Nova Avaliação" para começar.</p>`;
                        appState.avaliacoesCache = [];
                        return;
                    }

                    const avaliacoes = [];
                    querySnapshot.forEach(doc => avaliacoes.push({ id: doc.id, ...doc.data() }));
                    
                    appState.avaliacoesCache = avaliacoes;

                    renderizarListaAvaliacoes();
                } catch (error) {
                    console.error("Erro ao carregar avaliações:", error);
                    listaAvaliacoes.innerHTML = `<p class="text-red-500 text-center py-8">Erro ao carregar o histórico.</p>`;
                }
            }

            function renderizarListaAvaliacoes() {
                listaAvaliacoes.innerHTML = '';

                appState.avaliacoesCache.forEach((av, index) => {
                    const dataFormatada = new Date(av.data + 'T00:00:00').toLocaleDateString('pt-BR');
                    let medidasHTML = Object.entries(av.medidas || {}).map(([key, value]) => `
                        <div class="text-sm"><span class="capitalize text-text-muted">${key.replace(/_/g, ' ')}:</span> <strong class="text-text-light">${value} cm</strong></div>
                    `).join('');

                    if (!medidasHTML) medidasHTML = `<p class="text-text-muted text-sm col-span-2">Nenhuma medida registada.</p>`;

                    const card = document.createElement('div');
                    card.className = "bg-background-dark border border-border-light p-4 rounded-lg";
                    card.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-2 mb-3">
                            <div>
                                <h4 class="font-bold text-primary-blue text-xl">${dataFormatada}</h4>
                                <p class="font-semibold text-text-light text-lg">${av.peso} kg</p>
                            </div>
                            <div class="flex gap-2 self-end sm:self-start">
                                <button class="btn-ver-grafico py-2 px-3 text-sm bg-btn-success text-white rounded-lg font-semibold flex items-center gap-1" data-avaliacaoindex="${index}" title="Ver Gráfico de Progresso">
                                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                    Gráfico
                                </button>
                                <button class="btn-excluir-avaliacao text-red-500 hover:text-red-400 p-2 rounded-full" data-avaliacaoid="${av.id}" title="Excluir Avaliação">
                                    <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 pt-3 border-t border-border-light">
                            ${medidasHTML}
                        </div>
                    `;
                    listaAvaliacoes.appendChild(card);
                });
            }


            listaAvaliacoes.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.btn-excluir-avaliacao');
                const chartButton = e.target.closest('.btn-ver-grafico');

                if (deleteButton) {
                    const avaliacaoId = deleteButton.dataset.avaliacaoid;
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir esta avaliação?");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir...");
                    try {
                        const avaliacaoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "avaliacoes", avaliacaoId);
                        await deleteDoc(avaliacaoDocRef);
                        showNotification("Sucesso!", "Avaliação excluída.");
                        carregarAvaliacoes();
                    } catch (error) {
                        showNotification("Erro", "Erro ao excluir.", "error");
                    } finally {
                        toggleSpinner(false);
                    }
                }

                if (chartButton) {
                    const index = parseInt(chartButton.dataset.avaliacaoindex, 10);
                    abrirModalGrafico(index);
                }
            });

            // --- LÓGICA DOS GRÁFICOS ---
            closeChartModal.addEventListener('click', () => chartModal.classList.add('hide'));

            function abrirModalGrafico(index) {
                const avaliacoesOrdenadas = [...appState.avaliacoesCache].sort((a,b) => new Date(a.data) - new Date(b.data));
                const avaliacaoAtual = avaliacoesOrdenadas[avaliacoesOrdenadas.length - 1 - index];
                const avaliacaoAnterior = avaliacoesOrdenadas[avaliacoesOrdenadas.length - 2 - index] || null;

                const dataFormatada = new Date(avaliacaoAtual.data + 'T00:00:00').toLocaleDateString('pt-BR');
                chartModalTitle.textContent = `Progresso até ${dataFormatada}`;

                gerarGraficoPeso();
                gerarGraficoMedidas(avaliacaoAtual, avaliacaoAnterior);

                chartModal.classList.remove('hide');
            }

            function gerarGraficoPeso() {
                const ctx = document.getElementById('weightChart').getContext('2d');
                if (weightChartInstance) {
                    weightChartInstance.destroy();
                }
                
                const labels = [...appState.avaliacoesCache].sort((a,b) => new Date(a.data) - new Date(b.data)).map(av => new Date(av.data + 'T00:00:00').toLocaleDateString('pt-BR'));
                const data = [...appState.avaliacoesCache].sort((a,b) => new Date(a.data) - new Date(b.data)).map(av => av.peso);

                weightChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Peso (kg)',
                            data: data,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: '#c9d1d9' } },
                            x: { ticks: { color: '#c9d1d9' } }
                        }
                    }
                });
            }

            function gerarGraficoMedidas(atual, anterior) {
                const ctx = document.getElementById('measuresChart').getContext('2d');
                if (measuresChartInstance) {
                    measuresChartInstance.destroy();
                }
                
                const todasMedidas = new Set([...Object.keys(atual.medidas || {}), ...(anterior ? Object.keys(anterior.medidas || {}) : [])]);
                const labels = Array.from(todasMedidas).map(key => key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
                
                const dataAtual = labels.map(label => (atual.medidas || {})[label.toLowerCase().replace(/ /g, '_')] || 0);
                const dataAnterior = anterior ? labels.map(label => (anterior.medidas || {})[label.toLowerCase().replace(/ /g, '_')] || 0) : [];

                const datasets = [{
                    label: `Atual (${new Date(atual.data + 'T00:00:00').toLocaleDateString('pt-BR')})`,
                    data: dataAtual,
                    borderColor: '#38c172',
                    backgroundColor: 'rgba(56, 193, 114, 0.2)',
                    pointBackgroundColor: '#38c172'
                }];

                if (anterior) {
                    datasets.push({
                        label: `Anterior (${new Date(anterior.data + 'T00:00:00').toLocaleDateString('pt-BR')})`,
                        data: dataAnterior,
                        borderColor: '#8b949e',
                        backgroundColor: 'rgba(139, 148, 158, 0.2)',
                        pointBackgroundColor: '#8b949e'
                    });
                }

                measuresChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: '#c9d1d9' } } },
                        scales: {
                            r: {
                                angleLines: { color: '#30363d' },
                                grid: { color: '#30363d' },
                                pointLabels: { color: '#c9d1d9', font: { size: 12 } },
                                ticks: {
                                    color: '#c9d1d9',
                                    backdropColor: '#161b22'
                                }
                            }
                        }
                    }
                });
            }

            btnDownloadChart.addEventListener('click', () => {
                const canvasPeso = document.getElementById('weightChart');
                const canvasMedidas = document.getElementById('measuresChart');
                
                const combinedCanvas = document.createElement('canvas');
                const padding = 50;
                combinedCanvas.width = canvasPeso.width + canvasMedidas.width + padding * 2;
                combinedCanvas.height = Math.max(canvasPeso.height, canvasMedidas.height) + padding * 2;
                const ctx = combinedCanvas.getContext('2d');

                ctx.fillStyle = '#161b22';
                ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
                
                ctx.drawImage(canvasPeso, padding, padding);
                ctx.drawImage(canvasMedidas, canvasPeso.width + padding, padding);

                ctx.fillStyle = '#c9d1d9';
                ctx.font = '24px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText(`Progresso de ${appState.alunoSelecionado.nome}`, combinedCanvas.width / 2, padding - 10);

                const link = document.createElement('a');
                link.download = `progresso_${appState.alunoSelecionado.nome.replace(/\s/g, '_')}.png`;
                link.href = combinedCanvas.toDataURL('image/png');
                link.click();
                showNotification("Sucesso!", "Gráfico descarregado com sucesso!");
            });


            // --- FUNÇÕES DE CÁLCULO NUTRICIONAL ---
            function calcularIMC(peso, alturaCm) {
                if (!peso || !alturaCm) return { valor: 0, classificacao: "Dados insuficientes" };
                const alturaM = alturaCm / 100;
                const imc = peso / (alturaM * alturaM);
                let classificacao = "Normal";
                if (imc < 18.5) classificacao = "Abaixo do peso";
                else if (imc >= 25 && imc < 30) classificacao = "Excesso de peso";
                else if (imc >= 30) classificacao = "Obesidade";
                return { valor: imc.toFixed(2), classificacao };
            }

            function calcularTMB(peso, alturaCm, idade, sexo) {
                if (!peso || !alturaCm || !idade || !sexo) return 0;
                if (sexo === 'Masculino') {
                    return (10 * peso + 6.25 * alturaCm - 5 * idade + 5).toFixed(0);
                } else {
                    return (10 * peso + 6.25 * alturaCm - 5 * idade - 161).toFixed(0);
                }
            }

            function calcularCaloriasRecomendadas(tmb, objetivo) {
                if (!tmb || !objetivo) return 0;
                const fatorAtividade = 1.55;
                const gastoTotal = tmb * fatorAtividade;
                
                if (objetivo.toLowerCase().includes('emagrecimento')) return (gastoTotal - 400).toFixed(0);
                if (objetivo.toLowerCase().includes('hipertrofia')) return (gastoTotal + 400).toFixed(0);
                return gastoTotal.toFixed(0);
            }

            function calcularProteina(peso) {
                if (!peso) return "N/D";
                const min = (peso * 1.6).toFixed(0);
                const max = (peso * 2.2).toFixed(0);
                return `${min}g - ${max}g`;
            }

            function calcularCarboidratos(peso, objetivoAluno) {
                if (!peso) return "N/D";
                const objetivo = objetivoAluno || document.getElementById('objetivo').value;
                let minFactor = 2;
                let maxFactor = 5;
                if (objetivo.toLowerCase().includes('hipertrofia')) {
                    minFactor = 4;
                    maxFactor = 6;
                } else if (objetivo.toLowerCase().includes('emagrecimento')) {
                    minFactor = 2;
                    maxFactor = 4;
                }
                const min = (peso * minFactor).toFixed(0);
                const max = (peso * maxFactor).toFixed(0);
                return `${min}g - ${max}g`;
            }

            function calcularAgua(peso) {
                if (!peso) return "N/D";
                const min = (peso * 35 / 1000).toFixed(1);
                const max = (peso * 50 / 1000).toFixed(1);
                return `${min}L - ${max}L`;
            }

            function calcularCreatina() {
                return "3g - 5g";
            }

            // --- LÓGICA DE GERAÇÃO DE TREINO ---
            btnNovoTreino.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;

                appState.treinoAbertoId = null; 

                const { altura, idade, objetivo, sexo } = appState.alunoSelecionado;
                const ultimoPeso = appState.avaliacoesCache.length > 0 ? appState.avaliacoesCache[0].peso : appState.alunoSelecionado.pesoInicial;
                const imc = calcularIMC(ultimoPeso, altura);
                const tmb = calcularTMB(ultimoPeso, altura, idade, sexo);
                const calorias = calcularCaloriasRecomendadas(tmb, objetivo);

                appState.analiseNutricional = {
                    imc: `${imc.valor} (${imc.classificacao})`,
                    tmb: `${tmb} kcal`,
                    caloriasRecomendadas: `${calorias} kcal`,
                    proteina: calcularProteina(ultimoPeso),
                    carboidratos: calcularCarboidratos(ultimoPeso, objetivo),
                    agua: calcularAgua(ultimoPeso),
                    creatina: calcularCreatina(),
                    dataCriacao: new Date().toLocaleDateString('pt-BR')
                };
                
                appState.treinoSemanal = [];
                appState.tecnicas = [];
                appState.dicas = [];
                document.getElementById('treinoForm').reset();
                diasDeTreinoContainer.innerHTML = '';
                document.getElementById('nome_aluno_form').value = appState.alunoSelecionado.nome;
                atualizarDivisoes();
                tecnicasContainer.classList.add('hide');
                mostrarTela('treinoForm');
            });

            btnCarregarTreino.addEventListener('click', () => {
                if (!appState.alunoSelecionado) return;
                tituloTelaCarregar.textContent = `Treinos de ${appState.alunoSelecionado.nome}`;
                carregarTreinosSalvos();
                mostrarTela('telaCarregar');
            });

            btnVoltarParaGerenciarAluno_Carregar.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnVoltarParaGerenciarAluno_Form.addEventListener('click', () => mostrarTela('telaGerenciarAluno'));
            btnVoltarForm.addEventListener('click', () => mostrarTela('treinoForm'));

            const divisoesSugeridas = {
                '1': ['Full Body (Corpo Inteiro)', 'Treino Específico (Ex: Só Pernas)'],
                '3': ['ABC (Peito-Ombro-Tríceps / Costas-Bíceps / Pernas)', 'Full Body (Corpo Inteiro 3x)'],
                '4': ['Upper/Lower (Superiores/Inferiores 2x)', 'ABCD (Ex: Peito / Costas / Pernas / Ombros)'],
                '5': ['ABCDE (Push/Pull/Legs/Upper/Lower)', 'ABCAB (Ex: Peito-Tríceps / Costas-Bíceps / Pernas / Repete A e B)'],
                '6': ['ABCABC (Push/Pull/Legs 2x)', 'Divisão por grupo muscular isolado']
            };

            const divisoesSugeridasFeminino = {
                '1': ['Full Body (Foco em Glúteos)', 'Inferiores Completo'],
                '3': ['Inferior/Superior/Full Body', 'ABC (Foco Inferiores: Posterior/Glúteo / Quadríceps / Superiores)'],
                '4': ['Inferior/Superior/Inferior/Superior', 'ABCD (Posterior/Glúteo / Superiores A / Quadríceps / Superiores B)'],
                '5': ['Inferior/Superior/Inferior/Superior/Inferior', 'ABCDE (Posterior / Quadríceps / Superiores Push / Glúteo / Superiores Pull)'],
                '6': ['Inferior/Superior/Inferior/Superior/Inferior/Superior', 'PPL PPL (com ênfase em Glúteos nos dias de perna)']
            };

            function atualizarDivisoes() {
                const dias = diasSemanaSelect.value;
                const sexoAluno = appState.alunoSelecionado ? appState.alunoSelecionado.sexo : 'Masculino';
                const divisoes = sexoAluno === 'Feminino' ? divisoesSugeridasFeminino : divisoesSugeridas;

                divisaoTreinoSelect.innerHTML = '';
                if (divisoes[dias]) {
                    divisoes[dias].forEach(divisao => {
                        divisaoTreinoSelect.innerHTML += `<option value="${divisao}">${divisao}</option>`;
                    });
                }
            }
            diasSemanaSelect.addEventListener('change', atualizarDivisoes);
            
            dificuldadeSelect.addEventListener('change', () => {
                tecnicasContainer.classList.toggle('hide', dificuldadeSelect.value !== 'Avancado');
            });
            
            async function getExerciseHistory(alunoId) {
                if (!appState.currentUser || !alunoId) return "";

                try {
                    const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", alunoId, "treinos");
                    const q = query(treinosRef, orderBy("criadoEm", "desc"), limit(2));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) return "";

                    const exercises = new Set();
                    querySnapshot.forEach(doc => {
                        const treino = doc.data();
                        if (treino.dias && Array.isArray(treino.dias)) {
                            treino.dias.forEach(dia => {
                                if (dia.exercicios && Array.isArray(dia.exercicios)) {
                                    dia.exercicios.forEach(ex => exercises.add(ex.nome.trim()));
                                }
                            });
                        }
                    });

                    if (exercises.size === 0) return "";

                    const exerciseList = Array.from(exercises).join(', ');
                    return `\n- **Histórico de Exercícios Recentes (EVITAR REPETIR):** ${exerciseList}`;

                } catch (error) {
                    console.error("Erro ao buscar histórico de exercícios:", error);
                    return "";
                }
            }
            
            btnGerarComIA.addEventListener('click', async () => {
                if (!appState.alunoSelecionado) return;
                
                if (!appState.apiKey) {
                    showNotification("Atenção", "Por favor, configure a sua chave de API do Google AI nas configurações (⚙️) antes de gerar um treino.", "error");
                    settingsModal.classList.remove('hide');
                    return;
                }

                const duracaoTreino = document.getElementById('duracao_treino').value;
                const treinoEmCasa = document.getElementById('treino_em_casa').checked;
                const incluirTecnicas = document.getElementById('incluir_tecnicas').checked && dificuldadeSelect.value !== 'Iniciante';
                const musculoEnfase = document.getElementById('musculo_enfase').value.trim();
                const incluirDicas = document.getElementById('incluir_dicas').checked;
                const observacoesIA = document.getElementById('observacoes_ia').value.trim();
                
                toggleSpinner(true, "A analisar histórico e criar um treino único...");
                btnGerarComIA.disabled = true;
                btnGerarComIA.classList.add('opacity-50', 'cursor-not-allowed');

                const exerciseHistory = await getExerciseHistory(appState.alunoSelecionado.id);

                let prompt = `Você é um Personal Trainer de elite, focado em criar o plano de treino perfeito e seguir as instruções à risca.
                
## Regras Críticas e Obrigatórias:
- **NÃO INCLUA videoUrl:** A sua única tarefa é fornecer os nomes dos exercícios. Não inclua NENHUM URL de vídeo no JSON de resposta.
- **Volume de Treino:** Cada dia de treino DEVE conter obrigatoriamente entre 6 e 8 exercícios. Não menos que 6, não mais que 8.
- **Aquecimento e Arrefecimento:** Para CADA dia de treino, crie uma sugestão específica e apropriada para "aquecimento" e "arrefecimento". Estes campos não podem ficar vazios.
- **Cardio:** Para CADA dia de treino, adicione uma sugestão de cardio no campo "cardio".
- **Coesão Muscular:** Todos os exercícios de um dia devem pertencer aos grupos musculares definidos para esse dia.
- **Ordem Inteligente:** Comece com exercícios compostos, depois isolados. Agrupe por músculo. Abdômen no final.
- **Exercícios Reais:** Use nomes de exercícios comuns de academia.
- **Evitar Repetição:** Priorize exercícios que NÃO ESTÃO no histórico fornecido.

## Dados do Aluno:
- Aluno(a): "${appState.alunoSelecionado.nome}", Sexo: ${appState.alunoSelecionado.sexo}, Idade: ${appState.alunoSelecionado.idade} anos
- Nível: ${dificuldadeSelect.value}
- Objetivo Principal: ${document.getElementById('objetivo').value}
- Frequência: ${diasSemanaSelect.value} dias/semana
- Divisão Sugerida: ${divisaoTreinoSelect.value}`;

                if (observacoesIA) {
                    prompt += `

## Ordem Prioritária do Treinador (OBRIGATÓRIO CUMPRIR):
- As seguintes instruções do treinador TÊM PRIORIDADE MÁXIMA sobre todas as outras regras. Cumpra-as exatamente como descrito:
- "${observacoesIA}"`;
                }

                if (exerciseHistory) { prompt += exerciseHistory; }
                if (duracaoTreino !== 'N/A') { prompt += `\n- Duração Máxima: ${duracaoTreino}.`; }
                if (treinoEmCasa) { prompt += `\n- Local: Treino em casa (apenas peso corporal).`; }
                if (incluirTecnicas) { prompt += `\n- Incluir técnicas avançadas.`; }
                if (musculoEnfase) { prompt += `\n- Ênfase em: ${musculoEnfase}.`; }
                if (incluirDicas) { prompt += `\n- Fornecer descrições de técnicas e dicas.`; }
                prompt += `\n\nResponda APENAS com o JSON estruturado conforme o schema.`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        observacoes_gerais: { type: "STRING" },
                        plano_semanal: { 
                            type: "ARRAY", 
                            items: { 
                                type: "OBJECT", 
                                properties: { 
                                    nome_dia: { type: "STRING" }, 
                                    grupos_musculares: { type: "STRING" },
                                    aquecimento: { type: "STRING" },
                                    exercicios: { 
                                        type: "ARRAY", 
                                        items: { 
                                            type: "OBJECT", 
                                            properties: { 
                                                nome: { type: "STRING" }, series: { type: "STRING" }, reps: { type: "STRING" },
                                                descanso: { type: "STRING" }, obs: { type: "STRING" }
                                            },
                                            required: ["nome", "series", "reps", "descanso"]
                                        } 
                                    },
                                    cardio: { type: "STRING" },
                                    arrefecimento: { type: "STRING" }
                                },
                                required: ["nome_dia", "grupos_musculares", "aquecimento", "exercicios", "cardio", "arrefecimento"]
                            } 
                        },
                        tecnicas_utilizadas: { type: "ARRAY", items: { type: "OBJECT", properties: { nome: { type: "STRING" }, descricao: { type: "STRING" } } } },
                        dicas_extras: { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["observacoes_gerais", "plano_semanal"]
                };
                
                try {
                    const apiKey = appState.apiKey;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { 
                        contents: [{ role: "user", parts: [{ text: prompt }] }], 
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorDetails = `Erro da API: ${response.statusText}`;
                        try {
                           const errorJson = JSON.parse(errorText);
                           errorDetails = errorJson.error?.message || errorText;
                           if(errorDetails.includes("API key not valid")) {
                                errorDetails = "A sua chave de API é inválida. Por favor, verifique nas configurações (⚙️)."
                           }
                        } catch(e) {}
                        throw new Error(errorDetails);
                    }

                    const result = await response.json();
                    let textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textPart) throw new Error("A IA retornou uma resposta vazia ou malformada.");
                    
                    const treinoJson = JSON.parse(textPart);
                    
                    if (!treinoJson.plano_semanal || !Array.isArray(treinoJson.plano_semanal) || treinoJson.plano_semanal.length === 0) {
                        console.error("A resposta da IA não contém um 'plano_semanal' válido ou está vazio.", treinoJson);
                        throw new Error("A IA retornou um formato de dados inesperado. O plano de treino semanal está em falta ou vazio. Tente novamente.");
                    }

                    toggleSpinner(true, "A associar vídeos da sua biblioteca...");

                    // Anexar URLs de vídeo da biblioteca
                    const biblioteca = await getBibliotecaExercicios();
                    const bibliotecaMap = new Map(biblioteca.map(ex => [ex.nome.toLowerCase().trim(), ex.videoUrl]));

                    treinoJson.plano_semanal.forEach(dia => {
                        dia.exercicios.forEach(ex => {
                            const videoUrl = bibliotecaMap.get(ex.nome.toLowerCase().trim());
                            ex.videoUrl = videoUrl || ''; // Adiciona o URL se existir
                        });
                    });
                    
                    preencherFormularioComIA(treinoJson);
                    showNotification("Sucesso!", "Sugestão de treino gerada e vídeos associados!");

                } catch (error) {
                    console.error("Erro ao gerar treino com IA:", error);
                    let errorMessage = error.message || "A IA não conseguiu gerar o treino. Tente novamente.";
                    let errorTitle = "Erro de IA";

                    if (errorMessage.toLowerCase().includes('quota') || errorMessage.toLowerCase().includes('rate limit')) {
                        errorTitle = "Limite de API Atingido";
                        errorMessage = "A cota de utilização da sua chave de API foi excedida. Isto é comum no plano gratuito. Por favor, aguarde um tempo ou verifique o seu plano e faturação na sua conta Google AI.";
                    }
                    
                    showNotification(errorTitle, errorMessage, "error");
                } finally {
                    toggleSpinner(false);
                    setTimeout(() => {
                        btnGerarComIA.disabled = false;
                        btnGerarComIA.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 10000); 
                }
            });


            function preencherFormularioComIA(treinoData, isTemplate = false) {
                if (!isTemplate) {
                     appState.tecnicas = treinoData.tecnicas_utilizadas || [];
                    appState.dicas = treinoData.dicas_extras || [];
                    document.getElementById('observacoes_gerais').value = treinoData.observacoes_gerais || '';
                } else {
                    appState.tecnicas = treinoData.tecnicas || [];
                    appState.dicas = treinoData.dicas || [];
                    document.getElementById('observacoes_gerais').value = treinoData.observacoes || '';
                }
                
                diasDeTreinoContainer.innerHTML = '';
                const plano = isTemplate ? treinoData.dias : treinoData.plano_semanal;

                if (plano) {
                    plano.forEach((dia) => {
                        const nomeDia = isTemplate ? dia.nome : dia.nome_dia;
                        const musculos = isTemplate ? dia.musculos : dia.grupos_musculares;
                        const diaDiv = addDiaDeTreino(nomeDia, musculos, dia.aquecimento, dia.cardio, dia.arrefecimento);
                        const exerciciosContainer = diaDiv.querySelector('.exercicios-container');
                        if (dia.exercicios) {
                            dia.exercicios.forEach(ex => addExercicio(exerciciosContainer, ex));
                        }
                    });
                }
            }

            document.getElementById('btnAddDia').addEventListener('click', () => addDiaDeTreino());
            let diaCount = 0;
            function addDiaDeTreino(nome = '', musculos = '', aquecimento = '', cardio = '', arrefecimento = '') {
                diaCount++;
                const diaDiv = document.createElement('div');
                diaDiv.className = 'bg-background-dark border border-border-light p-6 rounded-xl space-y-4';
                diaDiv.id = `dia-${diaCount}`;
                diaDiv.innerHTML = `
                    <div class="flex justify-between items-center gap-4">
                        <input type="text" placeholder="Nome do Treino (Ex: Treino A)" value="${nome}" class="dia-nome w-full p-3 bg-bg-container border-border-light border rounded-lg text-lg font-semibold" required>
                        <button type="button" class="btn-remover-dia text-red-500 p-2 rounded-full hover:bg-red-500/20">✖</button>
                    </div>
                    <div>
                        <input type="text" placeholder="Grupos Musculares (Ex: Peito, Ombro, Tríceps)" value="${musculos}" class="dia-musculos w-full p-3 bg-bg-container border-border-light border rounded-lg text-md" required>
                    </div>
                    <div><textarea placeholder="Aquecimento (opcional)..." class="dia-aquecimento w-full p-2 bg-bg-container border-border-light border rounded text-sm">${aquecimento}</textarea></div>
                    <div class="exercicios-container space-y-4"></div>
                    <button type="button" class="btn-add-exercicio w-full py-2 text-md bg-btn-secondary text-white rounded-lg font-semibold mt-2">+ Adicionar Exercício Manualmente</button>
                    <div><textarea placeholder="Cardio (opcional)..." class="dia-cardio w-full p-2 bg-bg-container border-border-light border rounded text-sm">${cardio}</textarea></div>
                    <div><textarea placeholder="Arrefecimento (opcional)..." class="dia-arrefecimento w-full p-2 bg-bg-container border-border-light border rounded text-sm">${arrefecimento}</textarea></div>
                `;
                diasDeTreinoContainer.appendChild(diaDiv);
                return diaDiv;
            }

            function addExercicio(container, ex = { nome: '', series: '', reps: '', descanso: '', obs: '', videoUrl: '' }) {
                const exercicioDiv = document.createElement('div');
                exercicioDiv.className = 'exercicio-item border-t border-border-light pt-4';
                exercicioDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center gap-2">
                        <input type="text" placeholder="Exercício" value="${ex.nome || ''}" class="ex-nome flex-grow w-full p-2 bg-bg-container border-border-light border rounded">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <input type="text" placeholder="Séries" value="${ex.series || ''}" class="ex-series w-full p-2 bg-bg-container border-border-light border rounded">
                            <span class="text-text-muted">x</span>
                            <input type="text" placeholder="Reps" value="${ex.reps || ''}" class="ex-reps w-full p-2 bg-bg-container border-border-light border rounded">
                            <input type="text" placeholder="Descanso" value="${ex.descanso || ''}" class="ex-descanso w-full p-2 bg-bg-container border-border-light border rounded">
                        </div>
                        <button type="button" class="btn-remover-exercicio text-red-400 p-1 rounded-full hover:bg-red-500/20">➖</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                        <input type="text" placeholder="Obs. (ex: Drop set)" value="${ex.obs || ''}" class="ex-obs w-full p-2 bg-bg-container border-border-light border rounded text-sm">
                        <div class="flex items-center gap-2">
                            <input type="url" placeholder="Link do YouTube" value="${ex.videoUrl || ''}" class="ex-video-url w-full p-2 bg-bg-container border-border-light border rounded text-sm">
                            <button type="button" class="btn-testar-video text-primary-blue hover:text-opacity-80 p-1 rounded-full" title="Testar Link do Vídeo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>`;
                container.appendChild(exercicioDiv);
            }
            
            diasDeTreinoContainer.addEventListener('click', e => {
                if (e.target.classList.contains('btn-add-exercicio')) addExercicio(e.target.previousElementSibling);
                if (e.target.classList.contains('btn-remover-dia')) e.target.closest('.bg-background-dark').remove();
                if (e.target.classList.contains('btn-remover-exercicio')) e.target.closest('.exercicio-item').remove();
                
                const testButton = e.target.closest('.btn-testar-video');
                if (testButton) {
                    const urlInput = testButton.previousElementSibling;
                    const url = urlInput.value.trim();
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        showNotification("Atenção", "Insira um URL para testar.", "error");
                    }
                }
            });

            document.getElementById('btnGerarPreview').addEventListener('click', () => {
                const dias = diasDeTreinoContainer.querySelectorAll('.bg-background-dark');
                if (dias.length === 0) return showNotification("Atenção", "Adicione pelo menos um dia de treino.", "error");

                appState.treinoSemanal = [];
                let formValido = true;
                let totalExercicios = 0;

                dias.forEach(diaEl => {
                    const nomeDia = diaEl.querySelector('.dia-nome').value;
                    const musculosDia = diaEl.querySelector('.dia-musculos').value;
                    if (!nomeDia || !musculosDia) formValido = false;
                    const exercicios = [];
                    diaEl.querySelectorAll('.exercicio-item').forEach(exEl => {
                        const nomeEx = exEl.querySelector('.ex-nome').value;
                        if (!nomeEx) formValido = false;
                        exercicios.push({
                            nome: nomeEx,
                            series: exEl.querySelector('.ex-series').value,
                            reps: exEl.querySelector('.ex-reps').value,
                            descanso: exEl.querySelector('.ex-descanso').value,
                            obs: exEl.querySelector('.ex-obs').value,
                            videoUrl: exEl.querySelector('.ex-video-url').value
                        });
                        totalExercicios++;
                    });
                    appState.treinoSemanal.push({ 
                        nome: nomeDia, 
                        musculos: musculosDia, 
                        aquecimento: diaEl.querySelector('.dia-aquecimento').value,
                        exercicios,
                        cardio: diaEl.querySelector('.dia-cardio').value,
                        arrefecimento: diaEl.querySelector('.dia-arrefecimento').value,
                    });
                });
                if (!formValido) return showNotification("Formulário Inválido", "Preencha o nome e os grupos musculares de todos os dias, e o nome de todos os exercícios.", "error");

                if (totalExercicios === 0) {
                    return showNotification("Atenção", "O treino não contém exercícios. Adicione exercícios manualmente ou gere um novo treino com a IA.", "error");
                }

                renderizarPreview();
                mostrarTela('treinoPreview');
            });

            function renderizarPreview() {
                const container = document.getElementById('treinosPreviewContainer');
                const analiseContainer = document.getElementById('analiseNutricionalPreview');
                container.innerHTML = '';
                analiseContainer.innerHTML = '';

                const { imc, tmb, caloriasRecomendadas, proteina, carboidratos, agua, creatina } = appState.analiseNutricional || {};
                analiseContainer.innerHTML = `
                    <h3 class="text-lg font-semibold text-primary-blue mb-2">Análise Rápida & Metas Diárias</h3>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                        <p><strong class="text-text-light">IMC:</strong> ${imc || 'N/D'}</p>
                        <p><strong class="text-text-light">TMB:</strong> ${tmb || 'N/D'}</p>
                        <p><strong class="text-text-light">Calorias (Obj.):</strong> ${caloriasRecomendadas || 'N/D'}</p>
                        <p><strong class="text-text-light">Proteína:</strong> ${proteina || 'N/D'}</p>
                        <p><strong class="text-text-light">Carboidratos:</strong> ${carboidratos || 'N/D'}</p>
                        <p><strong class="text-text-light">Água:</strong> ${agua || 'N/D'}</p>
                        <p><strong class="text-text-light">Creatina:</strong> ${creatina || 'N/D'}</p>
                    </div>
                `;
                
                const observacoes = document.getElementById('observacoes_gerais').value;
                if (observacoes) {
                    container.innerHTML += `<div class="mb-4"><h4 class="font-bold text-primary-blue">Observações Gerais:</h4><p class="text-text-muted whitespace-pre-wrap">${observacoes}</p></div>`;
                }
                const youtubeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-red-500"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" /></svg>`;

                appState.treinoSemanal.forEach(dia => {
                    let diaHTML = `<div class="mb-4">
                        <h3 class="text-xl font-semibold text-text-light border-b-2 border-primary-blue pb-1 mb-2">${dia.nome} <span class="text-base font-normal text-text-muted">- ${dia.musculos}</span></h3>`;

                    if(dia.aquecimento) diaHTML += `<div class="mb-3"><h4 class="font-semibold text-primary-blue text-sm">Aquecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.aquecimento}</p></div>`;

                    if (dia.exercicios && dia.exercicios.length > 0) {
                         let exerciciosHTML = dia.exercicios.map(ex => {
                             const videoIconHTML = ex.videoUrl ? `<span class="ml-2 inline-block">${youtubeIcon}</span>` : '';
                             return `<li class="flex justify-between items-center text-text-muted border-b border-border-light py-2 gap-2">
                                         <span class="flex-1 flex items-center">${ex.nome}${videoIconHTML}</span>
                                         <span class="text-right whitespace-nowrap">${ex.series || '-' }x${ex.reps || '-'} | ${ex.descanso || '-'} | ${ex.obs || '-'}</span>
                                     </li>`;
                         }).join('');
                         diaHTML += `<ul class="space-y-1">${exerciciosHTML}</ul>`;
                    }
                    
                    if(dia.cardio) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Cardio:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.cardio}</p></div>`;
                    if(dia.arrefecimento) diaHTML += `<div class="mt-3"><h4 class="font-semibold text-primary-blue text-sm">Arrefecimento:</h4><p class="text-text-muted text-sm whitespace-pre-wrap">${dia.arrefecimento}</p></div>`;

                    diaHTML += '</div>';
                    container.innerHTML += diaHTML;
                });

                if (appState.tecnicas && appState.tecnicas.length > 0) {
                    let tecnicasHTML = appState.tecnicas.map(t => `<li><strong class="text-text-light">${t.nome}:</strong> ${t.descricao}</li>`).join('');
                    container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Técnicas Utilizadas</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${tecnicasHTML}</ul></div>`;
                }
                if (appState.dicas && appState.dicas.length > 0) {
                    let dicasHTML = appState.dicas.map(d => `<li>${d}</li>`).join('');
                    container.innerHTML += `<div class="mt-6"><h4 class="text-lg font-semibold text-primary-blue border-b border-border-light pb-1 mb-2">Dicas Extra</h4><ul class="list-disc list-inside space-y-2 text-text-muted">${dicasHTML}</ul></div>`;
                }
            }

            document.getElementById('btnSalvarTreino').addEventListener('click', async () => {
                const nomeTreino = document.getElementById('treinoNomeSalvo').value;
                if (!nomeTreino) return showNotification("Atenção", "Dê um nome ao treino para o guardar.", "error");
                if (!appState.currentUser || !appState.alunoSelecionado) return;
                
                const treinoData = { 
                    nome: nomeTreino, 
                    observacoes: document.getElementById('observacoes_gerais').value, 
                    dias: appState.treinoSemanal, 
                    tecnicas: appState.tecnicas,
                    dicas: appState.dicas,
                    analiseNutricional: appState.analiseNutricional,
                    criadoEm: serverTimestamp()
                };

                if (appState.treinoAbertoId) {
                    const choice = await showSaveOptionsModal();
                    if (choice === 'update') {
                        toggleSpinner(true, "A atualizar treino...");
                        try {
                            const treinoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", appState.treinoAbertoId);
                            await updateDoc(treinoDocRef, treinoData);
                            showNotification("Sucesso!", "Treino atualizado com sucesso!");
                            mostrarTela('telaGerenciarAluno');
                        } catch (error) {
                            showNotification("Erro", "Erro ao atualizar o treino.", "error");
                            console.error(error);
                        } finally {
                            toggleSpinner(false);
                        }
                    } else if (choice === 'save_new') {
                        toggleSpinner(true, "A guardar como novo...");
                        try {
                            const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                            await addDoc(treinosRef, treinoData);
                            showNotification("Sucesso!", "Novo treino guardado com sucesso!");
                            mostrarTela('telaGerenciarAluno');
                        } catch (error) {
                            showNotification("Erro", "Erro ao guardar o novo treino.", "error");
                            console.error(error);
                        } finally {
                            toggleSpinner(false);
                        }
                    }
                } else {
                    toggleSpinner(true, "A guardar na nuvem...");
                    try {
                        const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                        await addDoc(treinosRef, treinoData);
                        showNotification("Sucesso!", "Treino guardado com sucesso!");
                        mostrarTela('telaGerenciarAluno');
                    } catch (error) { 
                        showNotification("Erro", "Erro ao guardar o treino.", "error");
                        console.error(error);
                    } 
                    finally { toggleSpinner(false); }
                }
            });

            async function carregarTreinosSalvos() {
                const container = document.getElementById('listaTreinosSalvos');
                container.innerHTML = `<p class="text-text-muted text-center py-8">A carregar...</p>`;
                try {
                    const treinosRef = collection(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos");
                    const querySnapshot = await getDocs(query(treinosRef, orderBy("criadoEm", "desc")));

                    if (querySnapshot.empty) {
                        container.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum treino guardado para este aluno.</p>`;
                        return;
                    }
                    container.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const treino = doc.data();
                        const data = treino.criadoEm ? new Date(treino.criadoEm.seconds * 1000).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', '') : 'sem data';
                        
                        const gruposMusculares = treino.dias && treino.dias.length > 0
                            ? [...new Set(treino.dias.map(dia => dia.musculos.split(/, | e /)[0].trim()))].slice(0, 3).join(', ') + (treino.dias.length > 3 ? '...' : '')
                            : 'Geral';

                        container.innerHTML += `
                            <div class="bg-bg-container p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-3">
                                <div class="w-full">
                                    <h4 class="font-semibold text-text-light">${treino.nome}</h4>
                                    <p class="text-sm text-text-muted">Guardado em: ${data}</p>
                                    <p class="text-sm text-primary-blue font-semibold mt-1">Foco: ${gruposMusculares}</p>
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <button data-treinoid="${doc.id}" class="btn-compartilhar-treino flex-1 py-2 px-3 text-sm bg-btn-success text-white rounded-lg font-semibold">Partilhar</button>
                                    <button data-treinoid="${doc.id}" class="btn-visualizar-treino flex-1 py-2 px-3 text-sm bg-primary-blue text-white rounded-lg font-semibold">Ver</button>
                                    <button data-treinoid="${doc.id}" class="btn-deletar-treino py-2 px-3 text-sm bg-btn-danger text-white rounded-lg font-semibold">X</button>
                                </div>
                            </div>`;
                    });
                } catch (error) { 
                    container.innerHTML = `<p class="text-red-500 text-center py-8">Erro ao carregar treinos.</p>`;
                    console.error(error);
                }
            }

            document.getElementById('listaTreinosSalvos').addEventListener('click', async e => {
                const treinoId = e.target.dataset.treinoid;
                if (!treinoId) return;

                const isDelete = e.target.classList.contains('btn-deletar-treino');
                const isView = e.target.classList.contains('btn-visualizar-treino');
                const isShare = e.target.classList.contains('btn-compartilhar-treino');

                if (isDelete) {
                    const confirmed = await showConfirmationModal("Confirmar Exclusão", "Tem a certeza de que deseja excluir este treino?");
                    if (!confirmed) return;

                    toggleSpinner(true, "A excluir...");
                    try {
                        await deleteDoc(doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId));
                        showNotification("Sucesso!", "Treino excluído.");
                        carregarTreinosSalvos();
                    } catch (error) { showNotification("Erro", "Erro ao excluir.", "error"); }
                    finally { toggleSpinner(false); }
                }

                if (isView) {
                    toggleSpinner(true, "A carregar treino...");
                    try {
                        const docSnap = await getDoc(doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId));
                        if (docSnap.exists()) {
                            appState.treinoAbertoId = treinoId;
                            const treino = docSnap.data();
                            appState.treinoSemanal = treino.dias;
                            appState.tecnicas = treino.tecnicas || [];
                            appState.dicas = treino.dicas || [];
                            appState.analiseNutricional = treino.analiseNutricional || {};
                            document.getElementById('observacoes_gerais').value = treino.observacoes || '';
                            document.getElementById('treinoNomeSalvo').value = treino.nome;
                            renderizarPreview();
                            mostrarTela('treinoPreview');
                        }
                    } catch (error) { 
                        showNotification("Erro", "Erro ao carregar detalhes.", "error");
                        console.error(error);
                    }
                    finally { toggleSpinner(false); }
                }

                if (isShare) {
                    handleShareTraining(treinoId);
                }
            });

            async function handleShareTraining(treinoId) {
                toggleSpinner(true, "A gerar link...");
                try {
                    const treinoDocRef = doc(db, "usuarios", appState.currentUser.uid, "alunos", appState.alunoSelecionado.id, "treinos", treinoId);
                    const docSnap = await getDoc(treinoDocRef);
                    if (!docSnap.exists()) throw new Error("Treino não encontrado.");

                    const treinoData = docSnap.data();
                    let publicId = treinoData.publicId;

                    if (!publicId) {
                        publicId = generateUUID();
                        const publicTrainingData = {
                            ...treinoData,
                            alunoNome: appState.alunoSelecionado.nome,
                            trainerName: appState.currentUser.displayName,
                            trainerId: appState.currentUser.uid,
                            alunoId: appState.alunoSelecionado.id
                        };
                        
                        const publicDocRef = doc(db, "publicTrainings", publicId);
                        await setDoc(publicDocRef, publicTrainingData);
                        await updateDoc(treinoDocRef, { publicId: publicId });
                    }
                    
                    const url = `${window.location.origin}${window.location.pathname}?publicId=${publicId}`;
                    shareableLinkInput.value = url;
                    shareLinkModal.classList.remove('hide');

                } catch (error) {
                    showNotification("Erro ao Partilhar", "Erro ao partilhar treino. Verifique as regras de segurança do Firestore.", "error");
                    console.error(error);
                } finally {
                    toggleSpinner(false);
                }
            }
            
            closeShareLinkModal.addEventListener('click', () => shareLinkModal.classList.add('hide'));
            btnCopyLink.addEventListener('click', () => {
                shareableLinkInput.select();
                document.execCommand('copy');
                showNotification("Copiado!", "Link copiado para a área de transferência!");
            });

            document.getElementById('btnGerarPDF').addEventListener('click', gerarPDF);
            
            function gerarPDF() {
                 if (appState.treinoSemanal.length === 0) return showNotification("Atenção", "Não há treino para gerar PDF.", "error");
                
                toggleSpinner(true, "A gerar PDF profissional...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const MARGIN = 15, DOC_WIDTH = doc.internal.pageSize.getWidth(), DOC_HEIGHT = doc.internal.pageSize.getHeight();
                const PRIMARY_COLOR = '#58a6ff', TEXT_COLOR = '#333333', LIGHT_TEXT_COLOR = '#777777';
                let yPosition = 0;

                const { nome, altura, idade, objetivo, pesoInicial, sexo } = appState.alunoSelecionado;
                const temAvaliacoes = appState.avaliacoesCache && appState.avaliacoesCache.length > 0;
                const ultimoPeso = temAvaliacoes ? appState.avaliacoesCache[0].peso : pesoInicial;
                
                const analise = {
                    imc: calcularIMC(ultimoPeso, altura),
                    tmb: calcularTMB(ultimoPeso, altura, idade, sexo),
                    caloriasRecomendadas: calcularCaloriasRecomendadas(calcularTMB(ultimoPeso, altura, idade, sexo), objetivo),
                    proteina: calcularProteina(ultimoPeso),
                    carboidratos: calcularCarboidratos(ultimoPeso, objetivo),
                    agua: calcularAgua(ultimoPeso),
                    creatina: calcularCreatina()
                };

                const addHeader = () => {
                    yPosition = 20;
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(PRIMARY_COLOR);
                    doc.text('Plano de Treino', MARGIN, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(14);
                    doc.setTextColor(TEXT_COLOR);
                    doc.text(nome, MARGIN, yPosition);
                    yPosition += 6;

                    doc.setFontSize(10);
                    doc.setTextColor(LIGHT_TEXT_COLOR);
                    doc.text(`Preparado por: ${appState.currentUser.displayName}`, MARGIN, yPosition);
                    yPosition += 10;
                    
                    const studentData = [
                        ['Idade', `${idade} anos`, 'Altura', `${altura} cm`, 'Peso Atual', `${ultimoPeso} kg`],
                        ['Objetivo', objetivo, 'IMC', `${analise.imc.valor} (${analise.imc.classificacao})`, 'TMB', `${analise.tmb} kcal`],
                        ['Calorias (Obj.)', `${analise.caloriasRecomendadas} kcal`, 'Proteína', `${analise.proteina}`, 'Carboidratos', `${analise.carboidratos}`],
                        ['Água', `${analise.agua}`, 'Creatina', `${analise.creatina}`, '', '']
                    ];

                    doc.autoTable({
                        startY: yPosition,
                        body: studentData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 1.5 },
                        columnStyles: {
                            0: { fontStyle: 'bold', textColor: TEXT_COLOR },
                            2: { fontStyle: 'bold', textColor: TEXT_COLOR },
                            4: { fontStyle: 'bold', textColor: TEXT_COLOR }
                        }
                    });

                    yPosition = doc.autoTable.previous.finalY + 10;
                };

                const addFooter = (page, total) => {
                    doc.setFontSize(8);
                    doc.setTextColor(LIGHT_TEXT_COLOR);
                    doc.text(`Página ${page} de ${total}`, DOC_WIDTH - MARGIN, DOC_HEIGHT - 10, { align: 'right' });
                    doc.text(`Your Trainer Partner - Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, MARGIN, DOC_HEIGHT - 10);
                };
                
                addHeader();

                const observacoesGerais = document.getElementById('observacoes_gerais').value;
                if(observacoesGerais) {
                    doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(TEXT_COLOR);
                    doc.text("Observações Gerais:", MARGIN, yPosition); yPosition += 6;
                    doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.setTextColor(LIGHT_TEXT_COLOR);
                    const splitText = doc.splitTextToSize(observacoesGerais, DOC_WIDTH - (MARGIN * 2));
                    doc.text(splitText, MARGIN, yPosition);
                    yPosition += (splitText.length * 4) + 8;
                }
                
                appState.treinoSemanal.forEach(dia => {
                    const addSimpleSection = (title, content) => {
                        if(content) {
                            if (yPosition > DOC_HEIGHT - 40) { doc.addPage(); yPosition = 30; }
                            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(TEXT_COLOR);
                            doc.text(title, MARGIN + 1, yPosition); yPosition += 5;
                            doc.setFont('helvetica', 'normal'); doc.setTextColor(LIGHT_TEXT_COLOR);
                            const splitText = doc.splitTextToSize(content, DOC_WIDTH - (MARGIN * 2) - 2);
                            doc.text(splitText, MARGIN + 1, yPosition);
                            yPosition += (splitText.length * 4) + 5;
                        }
                    };

                    if (yPosition > DOC_HEIGHT - 60) { doc.addPage(); yPosition = 30; }
                    doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(PRIMARY_COLOR); doc.text(dia.nome, MARGIN, yPosition); yPosition += 8;
                    doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.setTextColor(LIGHT_TEXT_COLOR); doc.text(dia.musculos, MARGIN, yPosition); yPosition += 4;
                    
                    addSimpleSection("Aquecimento:", dia.aquecimento);

                    const head = [['Exercício', 'Séries x Reps', 'Descanso', 'Obs.']];
                    const body = dia.exercicios.map(ex => [ ex.nome, `${ex.series || ''}x${ex.reps || ''}`, ex.descanso, ex.obs ]);
                    doc.autoTable({ startY: yPosition, head: head, body: body, theme: 'grid', headStyles: { fillColor: PRIMARY_COLOR } });
                    yPosition = doc.autoTable.previous.finalY + 8;

                    addSimpleSection("Cardio:", dia.cardio);
                    addSimpleSection("Arrefecimento:", dia.arrefecimento);
                    yPosition += 7;
                });
                
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    addFooter(i, totalPages);
                }

                doc.save(`plano_${nome.replace(/\s/g, '_')}.pdf`);
                toggleSpinner(false);
            }

            // --- LÓGICA DE TEMPLATES ---
            btnLoadTemplate.addEventListener('click', async () => {
                if (!appState.currentUser) return;
                toggleSpinner(true, "A carregar modelos...");
                templateListContainer.innerHTML = '<p class="text-text-muted">A carregar...</p>';
                loadTemplateModal.classList.remove('hide');

                try {
                    const templatesRef = collection(db, "usuarios", appState.currentUser.uid, "workoutTemplates");
                    const querySnapshot = await getDocs(query(templatesRef, orderBy("nome")));
                    if (querySnapshot.empty) {
                        templateListContainer.innerHTML = '<p class="text-text-muted">Nenhum modelo guardado ainda.</p>';
                        return;
                    }
                    templateListContainer.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const template = doc.data();
                        const templateDiv = document.createElement('div');
                        templateDiv.className = 'bg-background-dark border border-border-light p-4 rounded-lg flex justify-between items-center';
                        templateDiv.innerHTML = `
                            <div>
                                <h4 class="font-semibold text-text-light">${template.nome}</h4>
                                <p class="text-sm text-text-muted">${template.dias.length} dias de treino</p>
                            </div>
                            <button data-templateid="${doc.id}" class="btn-load-template-confirm py-2 px-4 bg-primary-blue text-white rounded-lg font-semibold">Carregar</button>
                        `;
                        templateListContainer.appendChild(templateDiv);
                    });
                } catch (error) {
                    console.error("Erro ao carregar modelos:", error);
                    templateListContainer.innerHTML = '<p class="text-red-500">Erro ao carregar modelos.</p>';
                } finally {
                    toggleSpinner(false);
                }
            });

            closeLoadTemplateModal.addEventListener('click', () => loadTemplateModal.classList.add('hide'));

            templateListContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-load-template-confirm')) {
                    const templateId = e.target.dataset.templateid;
                    toggleSpinner(true, "A carregar modelo...");
                    try {
                        const templateDocRef = doc(db, "usuarios", appState.currentUser.uid, "workoutTemplates", templateId);
                        const docSnap = await getDoc(templateDocRef);
                        if (docSnap.exists()) {
                            const templateData = docSnap.data();
                            btnNovoTreino.click(); // Simula clique para resetar o form
                            setTimeout(() => { // Garante que o reset foi concluído
                                preencherFormularioComIA(templateData, true);
                                loadTemplateModal.classList.add('hide');
                                showNotification("Sucesso!", `Modelo "${templateData.nome}" carregado.`);
                            }, 100);
                        }
                    } catch (error) {
                        showNotification("Erro", "Não foi possível carregar o modelo.", "error");
                    } finally {
                        toggleSpinner(false);
                    }
                }
            });

            btnSalvarComoModelo.addEventListener('click', async () => {
                const nomeTreino = document.getElementById('treinoNomeSalvo').value;
                if (!nomeTreino) return showNotification("Atenção", "Dê um nome ao modelo para o guardar.", "error");
                if (!appState.currentUser) return;

                const templateData = {
                    nome: nomeTreino,
                    observacoes: document.getElementById('observacoes_gerais').value,
                    dias: appState.treinoSemanal,
                    tecnicas: appState.tecnicas,
                    dicas: appState.dicas,
                    criadoEm: serverTimestamp()
                };

                toggleSpinner(true, "A guardar modelo...");
                try {
                    const templatesRef = collection(db, "usuarios", appState.currentUser.uid, "workoutTemplates");
                    await addDoc(templatesRef, templateData);
                    showNotification("Sucesso!", `Modelo "${nomeTreino}" guardado com sucesso!`);
                } catch (error) {
                    console.error("Erro ao guardar modelo: ", error);
                    showNotification("Erro", "Não foi possível guardar o modelo.", "error");
                } finally {
                    toggleSpinner(false);
                }
            });


            // --- LÓGICA DA BIBLIOTECA DE EXERCÍCIOS ---
            btnIrParaBiblioteca.addEventListener('click', () => {
                mostrarTela('telaBiblioteca');
                renderizarBiblioteca();
            });
            btnVoltarParaBoasVindas_Bib.addEventListener('click', () => mostrarTela('telaBoasVindas'));

            btnPopularBiblioteca.addEventListener('click', async () => {
                 const confirmed = await showConfirmationModal("Popular Biblioteca", "Esta ação adicionará uma lista padrão de exercícios à sua biblioteca. Exercícios existentes não serão alterados. Deseja continuar?");
                 if (!confirmed) return;

                 toggleSpinner(true, "A popular a sua biblioteca...");
                 try {
                     const listaPadrao = getListaDeExerciciosPadrao();
                     const bibliotecaAtual = await getBibliotecaExercicios(true); // Força a atualização
                     const nomesExistentes = new Set(bibliotecaAtual.map(ex => ex.nome));

                     const novosExercicios = listaPadrao.filter(ex => !nomesExistentes.has(ex.nome));

                     if (novosExercicios.length === 0) {
                        showNotification("Biblioteca Atualizada", "A sua biblioteca já contém todos os exercícios da lista padrão.");
                        return;
                     }

                     const batch = writeBatch(db);
                     const bibliotecaRef = collection(db, "usuarios", appState.currentUser.uid, "bibliotecaExercicios");
                     
                     novosExercicios.forEach(exercicio => {
                         const newDocRef = doc(bibliotecaRef);
                         batch.set(newDocRef, {
                             ...exercicio,
                             videoUrl: '',
                             criadoEm: serverTimestamp()
                         });
                     });

                     await batch.commit();
                     await getBibliotecaExercicios(true); // Força a atualização do cache
                     renderizarBiblioteca();
                     showNotification("Sucesso", `${novosExercicios.length} novos exercícios adicionados à sua biblioteca!`);

                 } catch(error) {
                     console.error("Erro ao popular biblioteca: ", error);
                     showNotification("Erro", "Não foi possível popular a biblioteca.", "error");
                 } finally {
                     toggleSpinner(false);
                 }
            });

            async function getBibliotecaExercicios(forceRefresh = false) {
                if (!forceRefresh && appState.exerciciosBibliotecaCache.length > 0) {
                    return appState.exerciciosBibliotecaCache;
                }
                if (!appState.currentUser) return [];

                try {
                    const bibliotecaRef = collection(db, "usuarios", appState.currentUser.uid, "bibliotecaExercicios");
                    const querySnapshot = await getDocs(query(bibliotecaRef, orderBy("nome")));
                    appState.exerciciosBibliotecaCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    return appState.exerciciosBibliotecaCache;
                } catch (error) {
                    console.error("Erro ao carregar biblioteca de exercícios:", error);
                    return [];
                }
            }
            
            async function renderizarBiblioteca() {
                const biblioteca = await getBibliotecaExercicios();
                const searchTerm = exercicioSearchInput.value.toLowerCase();
                const selectedGroup = exercicioGroupFilter.value;

                // Popular filtro de grupos musculares
                const groups = [...new Set(biblioteca.map(ex => ex.grupoMuscular))].sort();
                exercicioGroupFilter.innerHTML = '<option value="">Filtrar por grupo muscular</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    exercicioGroupFilter.appendChild(option);
                });
                exercicioGroupFilter.value = selectedGroup;

                const filteredExercicios = biblioteca.filter(ex => {
                    const nameMatch = ex.nome.toLowerCase().includes(searchTerm);
                    const groupMatch = !selectedGroup || ex.grupoMuscular === selectedGroup;
                    return nameMatch && groupMatch;
                });
                
                listaExerciciosBiblioteca.innerHTML = '';
                if(filteredExercicios.length === 0) {
                    listaExerciciosBiblioteca.innerHTML = `<p class="text-text-muted text-center py-8">Nenhum exercício encontrado. Tente popular com a lista padrão.</p>`;
                    return;
                }
                
                filteredExercicios.forEach(ex => {
                    const videoIcon = ex.videoUrl ? 
                        `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : 
                        `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;

                    const exercicioDiv = document.createElement('div');
                    exercicioDiv.className = 'bg-background-dark border border-border-light p-3 rounded-lg flex justify-between items-center gap-3';
                    exercicioDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                           ${videoIcon}
                           <div>
                               <h4 class="font-semibold text-text-light">${ex.nome}</h4>
                               <p class="text-sm text-text-muted">${ex.grupoMuscular}</p>
                           </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-exercise-name="${ex.nome}" data-exercise-id="${ex.id}" data-exercise-group="${ex.grupoMuscular}" class="btn-sugerir-video py-2 px-3 text-sm bg-blue-800 text-white rounded-lg font-semibold">Sugerir</button>
                            <button data-exercise-id="${ex.id}" data-exercise-name="${ex.nome}" data-exercise-group="${ex.grupoMuscular}" data-video-url="${ex.videoUrl || ''}" class="btn-edit-video py-2 px-3 text-sm bg-btn-secondary text-white rounded-lg font-semibold">
                               ${ex.videoUrl ? 'Editar' : 'Adicionar'}
                            </button>
                        </div>
                    `;
                    listaExerciciosBiblioteca.appendChild(exercicioDiv);
                });
            }

            exercicioSearchInput.addEventListener('input', renderizarBiblioteca);
            exercicioGroupFilter.addEventListener('change', renderizarBiblioteca);

            listaExerciciosBiblioteca.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-video');
                const suggestButton = e.target.closest('.btn-sugerir-video');

                if (editButton) {
                    exerciseIdHidden.value = editButton.dataset.exerciseId;
                    exerciseNameHidden.value = editButton.dataset.exerciseName;
                    exerciseGroupHidden.value = editButton.dataset.exerciseGroup;
                    videoUrlInput.value = editButton.dataset.videoUrl;
                    videoLinkModalExercise.textContent = editButton.dataset.exerciseName;
                    videoLinkModalTitle.textContent = 'Adicionar/Editar Vídeo';
                    videoLinkModal.classList.remove('hide');
                }
                if (suggestButton) {
                    handleSuggestVideos(suggestButton.dataset.exerciseName, suggestButton.dataset);
                }
            });

            closeVideoLinkModal.addEventListener('click', () => videoLinkModal.classList.add('hide'));

            formVideoLink.addEventListener('submit', async (e) => {
                e.preventDefault();
                const videoUrl = videoUrlInput.value.trim();
                const exerciseId = exerciseIdHidden.value;
                const exerciseName = exerciseNameHidden.value;
                const exerciseGroup = exerciseGroupHidden.value;

                if (!videoUrl) return showNotification("Erro", "O link do vídeo não pode estar vazio.", "error");

                toggleSpinner(true, "A guardar link...");
                try {
                    const docRef = doc(db, "usuarios", appState.currentUser.uid, "bibliotecaExercicios", exerciseId);
                    await updateDoc(docRef, { videoUrl: videoUrl });
                    
                    await getBibliotecaExercicios(true); // Força refresh
                    renderizarBiblioteca();
                    videoLinkModal.classList.add('hide');
                    showNotification("Sucesso", "Link do vídeo guardado!");
                } catch (error) {
                    console.error("Erro ao guardar o link do vídeo:", error);
                    showNotification("Erro", "Não foi possível guardar o link.", "error");
                } finally {
                    toggleSpinner(false);
                }
            });

            // --- Lógica de Sugestão de Vídeos com API do YouTube ---
            async function handleSuggestVideos(exerciseName, dataset) {
                if (!appState.youtubeApiKey) {
                    showNotification("Atenção", "Por favor, configure a sua chave de API do YouTube nas configurações (⚙️).", "error");
                    settingsModal.classList.remove('hide');
                    return;
                }
                toggleSpinner(true, `A procurar vídeos para "${exerciseName}"...`);
                try {
                    const videos = await fetchYouTubeSuggestions(exerciseName);
                    populateVideoSuggestionsModal(videos, dataset);
                } catch (error) {
                    showNotification("Erro", `Não foi possível obter sugestões: ${error.message}`, "error");
                } finally {
                    toggleSpinner(false);
                }
            }

            async function fetchYouTubeSuggestions(exerciseName) {
                const query = `${exerciseName} exercício tutorial execução`;
                const apiKey = appState.youtubeApiKey;
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=5&key=${apiKey}`;

                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'Erro na API do YouTube');
                }
                const data = await response.json();
                return data.items;
            }

            function populateVideoSuggestionsModal(videos, originalDataset) {
                videoSuggestionsTitle.textContent = `Sugestões para "${originalDataset.exerciseName}"`;
                videoSuggestionsContainer.innerHTML = '';
                if (!videos || videos.length === 0) {
                    videoSuggestionsContainer.innerHTML = '<p class="text-text-muted">Nenhum vídeo encontrado.</p>';
                } else {
                    videos.forEach(video => {
                        const videoId = video.id.videoId;
                        const videoTitle = video.snippet.title;
                        const thumbnailUrl = video.snippet.thumbnails.default.url;
                        const channelTitle = video.snippet.channelTitle;

                        const videoDiv = document.createElement('div');
                        videoDiv.className = 'bg-background-dark border border-border-light p-3 rounded-lg flex flex-col sm:flex-row items-center gap-4';
                        videoDiv.innerHTML = `
                            <img src="${thumbnailUrl}" alt="Thumbnail" class="w-32 h-18 object-cover rounded">
                            <div class="flex-grow">
                                <p class="font-semibold text-text-light">${videoTitle}</p>
                                <p class="text-sm text-text-muted">${channelTitle}</p>
                            </div>
                            <button data-video-url="https://www.youtube.com/watch?v=${videoId}" class="btn-select-video py-2 px-4 bg-primary-blue text-white rounded-lg font-semibold w-full sm:w-auto">Selecionar</button>
                        `;
                        const selectButton = videoDiv.querySelector('.btn-select-video');
                        selectButton.dataset.exerciseId = originalDataset.exerciseId;
                        selectButton.dataset.exerciseName = originalDataset.exerciseName;
                        selectButton.dataset.exerciseGroup = originalDataset.exerciseGroup;

                        videoSuggestionsContainer.appendChild(videoDiv);
                    });
                }
                videoSuggestionsModal.classList.remove('hide');
            }

            closeVideoSuggestionsModal.addEventListener('click', () => videoSuggestionsModal.classList.add('hide'));

            videoSuggestionsContainer.addEventListener('click', (e) => {
                const selectButton = e.target.closest('.btn-select-video');
                if (selectButton) {
                    videoSuggestionsModal.classList.add('hide');
                    
                    exerciseIdHidden.value = selectButton.dataset.exerciseId;
                    exerciseNameHidden.value = selectButton.dataset.exerciseName;
                    exerciseGroupHidden.value = selectButton.dataset.exerciseGroup;
                    videoUrlInput.value = selectButton.dataset.videoUrl;
                    videoLinkModalExercise.textContent = selectButton.dataset.exerciseName;
                    videoLinkModalTitle.textContent = 'Confirmar Vídeo Sugerido';
                    videoLinkModal.classList.remove('hide');
                }
            });


            // --- FUNÇÕES GERAIS ---
            function mostrarTela(idTela) {
                document.querySelectorAll('#telaAlunos, #telaGerenciarAluno, #telaCarregar, #treinoForm, #treinoPreview, #telaAcompanhamento, #telaBoasVindas, #telaBiblioteca').forEach(el => el.classList.add('hide'));
                const tela = document.getElementById(idTela);
                if (tela) tela.classList.remove('hide');
            }
            
            function showConfirmationModal(title, message) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmationModal');
                    document.getElementById('confirmationTitle').textContent = title;
                    document.getElementById('confirmationMessage').textContent = message;
                    modal.classList.remove('hide');

                    const btnConfirm = document.getElementById('btnConfirm');
                    const btnCancel = document.getElementById('btnCancel');

                    const confirmHandler = () => { cleanup(); resolve(true); };
                    const cancelHandler = () => { cleanup(); resolve(false); };
                    
                    const cleanup = () => {
                        modal.classList.add('hide');
                        btnConfirm.removeEventListener('click', confirmHandler);
                        btnCancel.removeEventListener('click', cancelHandler);
                    }

                    btnConfirm.addEventListener('click', confirmHandler);
                    btnCancel.addEventListener('click', cancelHandler);
                });
            }

            function showSaveOptionsModal() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('saveOptionsModal');
                    modal.classList.remove('hide');

                    const btnUpdate = document.getElementById('btnUpdateWorkout');
                    const btnSaveNew = document.getElementById('btnSaveAsNewWorkout');
                    const btnCancel = document.getElementById('btnCancelSave');

                    const updateHandler = () => { cleanup(); resolve('update'); };
                    const saveNewHandler = () => { cleanup(); resolve('save_new'); };
                    const cancelHandler = () => { cleanup(); resolve('cancel'); };
                    
                    const cleanup = () => {
                        modal.classList.add('hide');
                        btnUpdate.removeEventListener('click', updateHandler);
                        btnSaveNew.removeEventListener('click', saveNewHandler);
                        btnCancel.removeEventListener('click', cancelHandler);
                    }

                    btnUpdate.addEventListener('click', updateHandler);
                    btnSaveNew.addEventListener('click', saveNewHandler);
                    btnCancel.addEventListener('click', cancelHandler);
                });
            }

            function generateUUID() {
                if (crypto && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function getListaDeExerciciosPadrao() {
                 // Esta função contém a lista de exercícios padrão para popular a biblioteca
                return [
                    // Peito
                    { nome: "Supino Reto com Barra", grupoMuscular: "Peito" }, { nome: "Supino Inclinado com Barra", grupoMuscular: "Peito" },
                    { nome: "Supino Declinado com Barra", grupoMuscular: "Peito" }, { nome: "Supino Reto com Halteres", grupoMuscular: "Peito" },
                    { nome: "Supino Inclinado com Halteres", grupoMuscular: "Peito" }, { nome: "Supino Declinado com Halteres", grupoMuscular: "Peito" },
                    { nome: "Crucifixo Reto com Halteres", grupoMuscular: "Peito" }, { nome: "Crucifixo Inclinado com Halteres", grupoMuscular: "Peito" },
                    { nome: "Crucifixo Declinado com Halteres", grupoMuscular: "Peito" }, { nome: "Voador / Peck Deck", grupoMuscular: "Peito" },
                    { nome: "Crossover na Polia Alta", grupoMuscular: "Peito" }, { nome: "Crossover na Polia Média", grupoMuscular: "Peito" },
                    { nome: "Crossover na Polia Baixa", grupoMuscular: "Peito" }, { nome: "Supino na Máquina (Vertical)", grupoMuscular: "Peito" },
                    { nome: "Supino na Máquina Inclinado (Articulada)", grupoMuscular: "Peito" }, { nome: "Flexão de Braço (Clássica)", grupoMuscular: "Peito" },
                    { nome: "Flexão Declinada (Pés elevados)", grupoMuscular: "Peito" }, { nome: "Flexão Inclinada (Mãos elevadas)", grupoMuscular: "Peito" },
                    { nome: "Flexão com Pegada Fechada", grupoMuscular: "Peito" }, { nome: "Flexão Diamante", grupoMuscular: "Peito" },
                    { nome: "Mergulho nas Barras Paralelas (Foco no Peito)", grupoMuscular: "Peito" }, { nome: "Pullover com Halter", grupoMuscular: "Peito" },
                    { nome: "Pullover na Polia Alta com Corda", grupoMuscular: "Peito" }, { nome: "Supino com Pegada Fechada (Close-grip Bench Press)", grupoMuscular: "Peito" },
                    { nome: "Flexão Arqueiro", grupoMuscular: "Peito" },
                    // Costas
                    { nome: "Barra Fixa (Pull-up) - Pegada Pronada", grupoMuscular: "Costas" }, { nome: "Barra Fixa (Chin-up) - Pegada Supinada", grupoMuscular: "Costas" },
                    { nome: "Barra Fixa com Pegada Neutra", grupoMuscular: "Costas" }, { nome: "Puxada Frontal na Polia - Pegada Aberta", grupoMuscular: "Costas" },
                    { nome: "Puxada Frontal na Polia - Pegada Fechada", grupoMuscular: "Costas" }, { nome: "Puxada Frontal na Polia - Pegada Supinada", grupoMuscular: "Costas" },
                    { nome: "Puxada com Triângulo", grupoMuscular: "Costas" }, { nome: "Puxada por Trás (Pulley Costas)", grupoMuscular: "Costas" },
                    { nome: "Remada Curvada com Barra (Pegada Pronada)", grupoMuscular: "Costas" }, { nome: "Remada Curvada com Barra (Pegada Supinada / Remada Yates)", grupoMuscular: "Costas" },
                    { nome: "Remada Cavalinho com Triângulo", grupoMuscular: "Costas" }, { nome: "Remada Serrote com Halter (Unilateral)", grupoMuscular: "Costas" },
                    { nome: "Remada Baixa na Polia (Sentado)", grupoMuscular: "Costas" }, { nome: "Remada na Máquina (Articulada)", grupoMuscular: "Costas" },
                    { nome: "Remada Alta com Barra", grupoMuscular: "Costas" }, { nome: "Remada Alta com Halteres", grupoMuscular: "Costas" },
                    { nome: "Pulldown com Corda na Polia Alta", grupoMuscular: "Costas" }, { nome: "Pulldown com Barra Reta na Polia Alta", grupoMuscular: "Costas" },
                    { nome: "Levantamento Terra (Convencional)", grupoMuscular: "Costas" }, { nome: "Levantamento Terra Romeno (Foco em Posteriores/Lombar)", grupoMuscular: "Costas" },
                    { nome: "Levantamento Terra Sumô", grupoMuscular: "Costas" }, { nome: "Encolhimento de Ombros com Barra", grupoMuscular: "Costas" },
                    { nome: "Encolhimento de Ombros com Halteres", grupoMuscular: "Costas" }, { nome: "Hiperextensão Lombar (Banco Romano)", grupoMuscular: "Costas" },
                    { nome: "Puxada Unilateral na Polia", grupoMuscular: "Costas" }, { nome: "Remada Invertida na Barra (no Smith)", grupoMuscular: "Costas" },
                    { nome: "Good Morning com Barra", grupoMuscular: "Costas" }, { nome: "Kroc Rows (Remada com Halter pesado)", grupoMuscular: "Costas" },
                    { nome: "Face Pull na Polia", grupoMuscular: "Costas" }, { nome: "Superman no Solo", grupoMuscular: "Costas" },
                    // Ombros
                    { nome: "Desenvolvimento Militar com Barra (Em Pé)", grupoMuscular: "Ombros" }, { nome: "Desenvolvimento com Barra (Sentado)", grupoMuscular: "Ombros" },
                    { nome: "Desenvolvimento com Halteres (Sentado)", grupoMuscular: "Ombros" }, { nome: "Desenvolvimento Arnold (Arnold Press)", grupoMuscular: "Ombros" },
                    { nome: "Desenvolvimento na Máquina (Smith ou Articulada)", grupoMuscular: "Ombros" }, { nome: "Elevação Lateral com Halteres", grupoMuscular: "Ombros" },
                    { nome: "Elevação Lateral na Polia (Unilateral)", grupoMuscular: "Ombros" }, { nome: "Elevação Lateral Curvado com Halteres (Crucifixo Inverso)", grupoMuscular: "Ombros" },
                    { nome: "Elevação Frontal com Barra", grupoMuscular: "Ombros" }, { nome: "Elevação Frontal com Halteres (Alternada ou Simultânea)", grupoMuscular: "Ombros" },
                    { nome: "Elevação Frontal com Anilhas", grupoMuscular: "Ombros" }, { nome: "Elevação Frontal na Polia com Corda", grupoMuscular: "Ombros" },
                    { nome: "Crucifixo Inverso na Máquina (Voador Inverso)", grupoMuscular: "Ombros" }, { nome: "Crucifixo Inverso na Polia com Corda", grupoMuscular: "Ombros" },
                    { nome: "Remada Alta com Barra (Upright Row)", grupoMuscular: "Ombros" }, { nome: "Remada Alta na Polia com Barra", grupoMuscular: "Ombros" },
                    { nome: "Face Pull na Polia com Corda", grupoMuscular: "Ombros" }, { nome: "Encolhimento de Ombros na Máquina", grupoMuscular: "Ombros" },
                    { nome: "Manguito Rotador na Polia (Rotação Externa)", grupoMuscular: "Ombros" }, { nome: "Manguito Rotador na Polia (Rotação Interna)", grupoMuscular: "Ombros" },
                    { nome: "Elevação YTWL com Halteres Leves", grupoMuscular: "Ombros" }, { nome: "Pike Push-up", grupoMuscular: "Ombros" },
                    { nome: "Handstand Push-up (Flexão de Parada de Mão)", grupoMuscular: "Ombros" }, { nome: "Landmine Press (Desenvolvimento com Barra Fixa num Canto)", grupoMuscular: "Ombros" },
                    { nome: 'Elevação Lateral "Lu" com Halteres', grupoMuscular: "Ombros" },
                    // Bíceps
                    { nome: "Rosca Direta com Barra Reta", grupoMuscular: "Bíceps" }, { nome: "Rosca Direta com Barra W", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Direta com Halteres (Simultânea)", grupoMuscular: "Bíceps" }, { nome: "Rosca Alternada com Halteres", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Martelo (Hammer Curl)", grupoMuscular: "Bíceps" }, { nome: "Rosca Concentrada com Halter", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Scott com Barra W", grupoMuscular: "Bíceps" }, { nome: "Rosca Scott com Halter (Unilateral)", grupoMuscular: "Bíceps" },
                    { nome: "Rosca na Polia Baixa com Barra", grupoMuscular: "Bíceps" }, { nome: "Rosca na Polia Baixa com Corda", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Unilateral na Polia", grupoMuscular: "Bíceps" }, { nome: "Rosca Spider (Spider Curl)", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Inversa com Barra (Reverse Curl)", grupoMuscular: "Bíceps" }, { nome: "Rosca 21s (com Barra ou Halteres)", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Zottman", grupoMuscular: "Bíceps" }, { nome: "Rosca no Banco Inclinado com Halteres", grupoMuscular: "Bíceps" },
                    { nome: "Barra Fixa com Pegada Supinada Fechada (Chin-up)", grupoMuscular: "Bíceps" }, { nome: "Rosca de Arraste (Drag Curl)", grupoMuscular: "Bíceps" },
                    { nome: "Rosca Martelo Transversal (Cross-body Hammer Curl)", grupoMuscular: "Bíceps" }, { nome: "Rosca no Cabo Alto (High Cable Curl)", grupoMuscular: "Bíceps" },
                    // Tríceps
                    { nome: "Tríceps Testa com Barra W (Skull Crusher)", grupoMuscular: "Tríceps" }, { nome: "Tríceps Testa com Halteres (Simultâneo ou Alternado)", grupoMuscular: "Tríceps" },
                    { nome: "Tríceps Pulley com Barra Reta", grupoMuscular: "Tríceps" }, { nome: "Tríceps Pulley com Corda", grupoMuscular: "Tríceps" },
                    { nome: "Tríceps Pulley com Pegada Invertida", grupoMuscular: "Tríceps" }, { nome: "Mergulho nas Barras Paralelas (Foco no Tríceps)", grupoMuscular: "Tríceps" },
                    { nome: "Mergulho no Banco", grupoMuscular: "Tríceps" }, { nome: "Supino com Pegada Fechada (Close-grip Bench Press)", grupoMuscular: "Tríceps" },
                    { nome: "Flexão Diamante", grupoMuscular: "Tríceps" }, { nome: "Tríceps Francês Unilateral com Halter (Sentado ou em pé)", grupoMuscular: "Tríceps" },
                    { nome: "Tríceps Coice na Polia", grupoMuscular: "Tríceps" }, { nome: "Tríceps Coice com Halter", grupoMuscular: "Tríceps" },
                    { nome: "Extensão de Tríceps Acima da Cabeça com Halter (Dois braços)", grupoMuscular: "Tríceps" }, { nome: "Extensão de Tríceps Acima da Cabeça com Corda na Polia", grupoMuscular: "Tríceps" },
                    { nome: "Extensão de Tríceps na Máquina", grupoMuscular: "Tríceps" }, { nome: "Extensão de Tríceps com Peso Corporal (em barra ou TRX)", grupoMuscular: "Tríceps" },
                    { nome: "JM Press", grupoMuscular: "Tríceps" }, { nome: "Tate Press com Halteres", grupoMuscular: "Tríceps" },
                    { nome: "Tríceps Unilateral na Polia", grupoMuscular: "Tríceps" }, { nome: "Extensão de Tríceps Deitado na Polia Baixa", grupoMuscular: "Tríceps" },
                    // Quadríceps
                    { nome: "Agachamento Livre com Barra (Costas)", grupoMuscular: "Quadríceps" }, { nome: "Agachamento Frontal com Barra (Front Squat)", grupoMuscular: "Quadríceps" },
                    { nome: "Agachamento no Hack Machine", grupoMuscular: "Quadríceps" }, { nome: "Agachamento no Smith Machine", grupoMuscular: "Quadríceps" },
                    { nome: "Leg Press 45°", grupoMuscular: "Quadríceps" }, { nome: "Leg Press Horizontal", grupoMuscular: "Quadríceps" },
                    { nome: "Cadeira Extensora", grupoMuscular: "Quadríceps" }, { nome: "Afundo (Lunge) com Barra", grupoMuscular: "Quadríceps" },
                    { nome: "Afundo (Lunge) com Halteres", grupoMuscular: "Quadríceps" }, { nome: "Afundo no Smith", grupoMuscular: "Quadríceps" },
                    { nome: "Passada (Walking Lunge) com Halteres", grupoMuscular: "Quadríceps" }, { nome: "Agachamento Búlgaro com Halteres", grupoMuscular: "Quadríceps" },
                    { nome: "Agachamento Sissy (Sissy Squat)", grupoMuscular: "Quadríceps" }, { nome: "Agachamento Goblet (Goblet Squat) com Halter/Kettlebell", grupoMuscular: "Quadríceps" },
                    { nome: "Agachamento com Salto (Jump Squat)", grupoMuscular: "Quadríceps" }, { nome: "Afundo Reverso (Reverse Lunge)", grupoMuscular: "Quadríceps" },
                    { nome: "Pistol Squat (Agachamento Unilateral)", grupoMuscular: "Quadríceps" }, { nome: "Leg Press Unilateral", grupoMuscular: "Quadríceps" },
                    { nome: "Step-up no Caixote com Halteres", grupoMuscular: "Quadríceps" }, { nome: "Agachamento Zercher", grupoMuscular: "Quadríceps" },
                    // Posteriores
                    { nome: "Mesa Flexora", grupoMuscular: "Posterioress" }, { nome: "Cadeira Flexora", grupoMuscular: "Posterioress" },
                    { nome: "Flexora em Pé (Unilateral)", grupoMuscular: "Posterioress" }, { nome: "Stiff com Barra", grupoMuscular: "Posterioress" },
                    { nome: "Stiff com Halteres", grupoMuscular: "Posterioress" }, { nome: "Levantamento Terra Romeno (RDL) com Barra", grupoMuscular: "Posterioress" },
                    { nome: "Levantamento Terra Romeno (RDL) com Halteres", grupoMuscular: "Posterioress" }, { nome: "Good Morning com Barra", grupoMuscular: "Posterioress" },
                    { nome: "Flexão Nórdica (Nordic Hamstring Curl)", grupoMuscular: "Posterioress" }, { nome: "Kettlebell Swing", grupoMuscular: "Posterioress" },
                    { nome: "Stiff Unilateral com Halter", grupoMuscular: "Posterioress" }, { nome: "Levantamento Terra (Convencional)", grupoMuscular: "Posterioress" },
                    { nome: "Cable Pull-through (Puxada de cabo entre as pernas)", grupoMuscular: "Posterioress" }, { nome: "Glute-Ham Raise (GHR)", grupoMuscular: "Posterioress" },
                    { nome: "Stiff na Polia Baixa com corda", grupoMuscular: "Posterioress" },
                    // Glúteos
                    { nome: "Elevação Pélvica com Barra (Hip Thrust)", grupoMuscular: "Glúteos" }, { nome: "Elevação Pélvica na Máquina Específica", grupoMuscular: "Glúteos" },
                    { nome: "Ponte de Glúteos no Solo (Glute Bridge)", grupoMuscular: "Glúteos" }, { nome: "Agachamento Sumô com Halter ou Kettlebell", grupoMuscular: "Glúteos" },
                    { nome: "Agachamento Búlgaro (foco no glúteo)", grupoMuscular: "Glúteos" }, { nome: "Afundo com passo largo (foco no glúteo)", grupoMuscular: "Glúteos" },
                    { nome: "Coice na Polia (Glute Kickback)", grupoMuscular: "Glúteos" }, { nome: "Coice na Máquina (Glute Machine)", grupoMuscular: "Glúteos" },
                    { nome: "Cadeira Abdutora (com tronco inclinado à frente)", grupoMuscular: "Glúteos" }, { nome: "Abdução de Quadril na Polia Baixa (em pé)", grupoMuscular: "Glúteos" },
                    { nome: "Abdução de Quadril Deitado com Caneleira", grupoMuscular: "Glúteos" }, { nome: "Levantamento Terra Sumô", grupoMuscular: "Glúteos" },
                    { nome: "Afundo Reverso Cruzado (Curtsy Lunge)", grupoMuscular: "Glúteos" }, { nome: "Step-up no Caixote (foco no glúteo)", grupoMuscular: "Glúteos" },
                    { nome: "Frog Pump (Ponte Sapo)", grupoMuscular: "Glúteos" }, { nome: "Hidrante (Fire Hydrant) com caneleira ou faixa", grupoMuscular: "Glúteos" },
                    { nome: "Clamshell com faixa de resistência", grupoMuscular: "Glúteos" }, { nome: "Hiperextensão Reversa", grupoMuscular: "Glúteos" },
                    { nome: "Elevação Pélvica Unilateral", grupoMuscular: "Glúteos" }, { nome: "Kas Glute Bridge (variação da Elevação Pélvica)", grupoMuscular: "Glúteos" },
                    // Panturrilhas
                    { nome: "Panturrilha em Pé na Máquina (Gastrocnêmio)", grupoMuscular: "Panturrilhas" }, { nome: "Panturrilha Sentado na Máquina (Sóleo)", grupoMuscular: "Panturrilhas" },
                    { nome: "Panturrilha no Leg Press", grupoMuscular: "Panturrilhas" }, { nome: "Panturrilha no Smith Machine (em um step)", grupoMuscular: "Panturrilhas" },
                    { nome: "Panturrilha com Halter (Unilateral em um step)", grupoMuscular: "Panturrilhas" }, { nome: 'Panturrilha "Burrinho" (Donkey Calf Raise)', grupoMuscular: "Panturrilhas" },
                    { nome: "Panturrilha em Pé com Peso do Corpo", grupoMuscular: "Panturrilhas" }, { nome: "Pular Corda", grupoMuscular: "Panturrilhas" },
                    { nome: "Salto na Caixa (Box Jumps)", grupoMuscular: "Panturrilhas" }, { nome: "Panturrilha com Rotação dos Pés (para dentro e para fora)", grupoMuscular: "Panturrilhas" },
                    // Abdômen & Core
                    { nome: "Prancha Abdominal (Plank)", grupoMuscular: "Abdômen & Core" }, { nome: "Prancha Lateral (Side Plank)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Abdominal Supra no Solo (Crunch)", grupoMuscular: "Abdômen & Core" }, { nome: "Abdominal na Polia Alta (Crunch na polia)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Elevação de Pernas na Barra Fixa", grupoMuscular: "Abdômen & Core" }, { nome: "Elevação de Joelhos na Barra Fixa", grupoMuscular: "Abdômen & Core" },
                    { nome: "Elevação de Pernas na Cadeira Romana (Paralelas)", grupoMuscular: "Abdômen & Core" }, { nome: "Elevação de Pernas Deitado", grupoMuscular: "Abdômen & Core" },
                    { nome: "Abdominal Infra (Reverse Crunch)", grupoMuscular: "Abdômen & Core" }, { nome: "Abdominal Remador (V-up)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Canivete (Jackknife Sit-up)", grupoMuscular: "Abdômen & Core" }, { nome: "Abdominal Bicicleta no Ar", grupoMuscular: "Abdômen & Core" },
                    { nome: "Roda Abdominal (Ab Wheel)", grupoMuscular: "Abdômen & Core" }, { nome: "Toque no Calcanhar Alternado (Heel Touch)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Giro Russo (Russian Twist) com peso", grupoMuscular: "Abdômen & Core" }, { nome: "Lenhador na Polia (Woodchopper)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Abdominal Oblíquo na Polia (Side Bend)", grupoMuscular: "Abdômen & Core" }, { nome: "Prancha com Rotação de Quadril", grupoMuscular: "Abdômen & Core" },
                    { nome: "L-Sit (Isométrico)", grupoMuscular: "Abdômen & Core" }, { nome: "Dragon Flag", grupoMuscular: "Abdômen & Core" },
                    { nome: "Abdominal na Bola Suíça", grupoMuscular: "Abdômen & Core" }, { nome: "Perdigueiro (Bird-dog)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Inseto Morto (Dead Bug)", grupoMuscular: "Abdômen & Core" }, { nome: "Pallof Press (Anti-rotação)", grupoMuscular: "Abdômen & Core" },
                    { nome: "Escalador (Mountain Climber)", grupoMuscular: "Abdômen & Core" }
                ];
            }

            // --- INICIALIZAÇÃO ---
            atualizarDivisoes();
            tecnicasContainer.classList.add('hide');
        }
    </script>
</body>
</html>




